let usuarioCore={usuarios:Object(),usuario:Object(),init:async function(){usuarioCore.events(),"list"==core.actionModel&&"usuario"==core.model.toLowerCase()&&await usuarioCore.listadoDashboard(),!$(".titulo-modulo").length||"Usuario"!=core.model&&"Autorizado"!=core.model||CoreUI.setTitulo("nombre"),usuarioCore.Autorizado.init()},events:function(){$("body").on(core.helper.clickEventType,".btnVerUsuario",evt=>{evt.stopImmediatePropagation(),usuarioCore.verModalAdministrador($(evt.currentTarget).attr("data-id"),$(evt.currentTarget).attr("data-nombre"))}),$("body").on(core.helper.clickEventType,".btnEliminarUsuario",evt=>{evt.stopImmediatePropagation(),usuarioCore.eliminar($(evt.currentTarget).attr("data-id"),$(evt.currentTarget).attr("data-nombre"))})},eliminar:function(id,nombre){core.Modelo.Delete("usuario",id,nombre,"listadoUsuario")},verModalAdministrador:async function(idComunidad){var infoComunidad;usuarioCore.getAdministrador(idComunidad).then(result=>{infoComunidad=result,apiFincatech.getView("modals","administradores/modal_info").then(resultHTML=>{result=CoreUI.Utils.parse(resultHTML,usuarioCore.comunidad),console.log(result),CoreUI.Modal.GetHTML("modalInfoComunidad",result,usuarioCore.comunidad.nombre)})})},renderTabla:async function(){if($("#listadoUsuario").length){CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoUsuario","nombre","NOMBRE");var html="data:rol.nombre$";CoreUI.tableData.addColumn("listadoUsuario",null,"ROL",html),CoreUI.tableData.addColumn("listadoUsuario","cif","CIF");var html='<a href="mailto:data:email$" class="pl-1 pr-1">data:email$</a>';CoreUI.tableData.addColumn("listadoUsuario",null,"EMAIL",html),CoreUI.tableData.addColumn("listadoUsuario","telefono","TELEFONO"),CoreUI.tableData.addColumn("listadoUsuario",(function(row,type,val,meta){var timeStamp,fechaCreacion;return row.lastlogin?(timeStamp=moment(row.lastlogin,"YYYY-MM-DD hh:mm").unix(),fechaCreacion=moment(row.lastlogin).locale("es").format("L")):(timeStamp="",fechaCreacion='<span class="badge badge-pill bg-danger text-white">Nunca</span>'),`<span style="display:none;">${timeStamp}</span>${fechaCreacion}`}),"Último acceso",null,"text-center");var html="data:estado$";CoreUI.tableData.addColumn("listadoUsuario",null,"Estado",html,"text-center");var html="data:created$";CoreUI.tableData.addColumn("listadoUsuario",null,"Fecha de alta",html,"text-center");var html='<ul class="nav justify-content-center">';html+=`<li class="nav-item"><a href="${baseURL}usuario/data:id$" class="btnEditarUsuario d-inline-block mr-2" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="edit" class="text-success img-fluid" style="height:26px; width:26px;"></i></a></li>`,html+='<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarUsuario d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="trash-2" class="text-danger img-fluid" style="height:26px; width:26px;"></i></li></ul>',CoreUI.tableData.addColumn("listadoUsuario",null,"",html),$("#listadoUsuario").addClass("no-clicable"),CoreUI.tableData.render("listadoUsuario","Usuario","usuario/list")}},listadoDashboard:async function(){await usuarioCore.getAll().then(async data=>{this.renderTabla()})},getAdministrador:async function(comunidadId){await apiFincatech.get("usuario/"+comunidadId).then(data=>(result=JSON.parse(data),responseStatus=result.status,responseData=result.data,usuarioCore.comunidad=responseData.Comunidad[0],console.log(usuarioCore.comunidad),usuarioCore.comunidad))},getAll:async function(){await apiFincatech.get("usuario/list").then(async data=>{result=JSON.parse(data),responseStatus=result.status,responseData=result.data,usuarioCore.usuarios=responseData.Usuario})},Autorizado:{init:function(){usuarioCore.Autorizado.events(),"list"==core.actionModel&&"autorizado"==core.model.toLowerCase()&&usuarioCore.Autorizado.listadoAutorizados(),"add"!=core.actionModel&&"get"!==core.actionModel||"autorizado"!=core.model.toLowerCase()||usuarioCore.Autorizado.comunidadesAsignadas()},events:function(){switch($("body .form-autorizado #nombre").on("keyup",(function(e){CoreUI.Utils.setTituloPantalla(null,null,`${$(this).val()}`)})),$("body .form-autorizado .btnSaveData").off(core.helper.clickEventType).on(core.helper.clickEventType,(function(evt){evt.stopImmediatePropagation(),evt.preventDefault(),usuarioCore.Autorizado.Model.Save()})),$("body").on(core.helper.clickEventType,".btnEliminarUsuarioAutorizado",(function(evt){evt.stopImmediatePropagation(),usuarioCore.Autorizado.Model.delete($(evt.currentTarget).attr("data-id"),$(evt.currentTarget).attr("data-nombre"))})),core.actionModel){case"add":case"get":$("body").on("change",".form-autorizado .chkComunidadAutorizada",(function(ev){window.tablelistadoComunidadesAutorizado.row($(this).attr("data-row")).data().asignada=$(this).is(":checked")}))}"add"===core.actionModel&&$(".form-autorizado #password").addClass("form-required")},listadoAutorizados:function(){if($("#listadoUsuariosAutorizados").length){var listado="listadoUsuariosAutorizados";CoreUI.tableData.init(),CoreUI.tableData.addColumn(listado,"nombre","NOMBRE"),CoreUI.tableData.addColumn(listado,"cif","CIF");var html='<a href="mailto:data:email$" class="pl-1 pr-1">data:email$</a>';CoreUI.tableData.addColumn(listado,null,"EMAIL",html),CoreUI.tableData.addColumn(listado,"telefono","TELEFONO"),CoreUI.tableData.addColumn(listado,(function(row,type,val,meta){var timeStamp,fechaCreacion;return row.lastlogin?(timeStamp=moment(row.lastlogin,"YYYY-MM-DD hh:mm").unix(),fechaCreacion=moment(row.lastlogin).locale("es").format("L")):(timeStamp="",fechaCreacion='<span class="badge badge-pill bg-danger text-white">Nunca</span>'),`<span style="display:none;">${timeStamp}</span>${fechaCreacion}`}),"Último acceso",null,"text-center");var html="data:created$";CoreUI.tableData.addColumn(listado,null,"Fecha de alta",html,"text-center");var html='<ul class="nav justify-content-center">';html+=`<li class="nav-item"><a href="${baseURL}autorizado/data:id$" class="btnEditarUsuario d-inline-block mr-2" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="edit" class="text-success img-fluid" style="height:26px; width:26px;"></i></a></li>`,html+='<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarUsuarioAutorizado d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="trash-2" class="text-danger img-fluid" style="height:26px; width:26px;"></i></li></ul>',CoreUI.tableData.addColumn(listado,null,"",html),$("#listadoUsuario").addClass("no-clicable"),CoreUI.tableData.render(listado,"Usuario","autorizado/list")}},comunidadesAsignadas:function(){if($("#listadoComunidadesAutorizado").length){var listado="listadoComunidadesAutorizado";CoreUI.tableData.init(),CoreUI.tableData.addColumn(listado,(function(row,type,val,meta){var asignada="",rowId=meta.row,el;return!0===row.asignada&&(asignada="checked"),`\n                            <input id="asignada_${row.id}" name="asignada_${row.id}" type="checkbox" class="form-check-label chkComunidadAutorizada" ${asignada} data-row=${rowId}>\n                            <label class="form-check-label ml-2" for="asignada_${row.id}">\n                        `}),"",null,"text-center"),CoreUI.tableData.addColumn(listado,"codigo","CÓDIGO"),CoreUI.tableData.addColumn(listado,"nombre","NOMBRE");var html="data:created$";CoreUI.tableData.addColumn(listado,null,"Fecha de alta",html,"text-center"),$(`#${listado}`).addClass("no-clicable");var ep="get"===core.actionModel?`autorizado/${core.modelId}/comunidad/list`:"autorizado/comunidad/list";CoreUI.tableData.render(listado,"Comunidad",ep,null,!1)}},Model:{GetComunidadesAsignadas:function(){let oComunidades=Array();$seleccionComunidades=window.tablelistadoComunidadesAutorizado.rows().data();for(let iSelCom=0;iSelCom<$seleccionComunidades.length;iSelCom++){let oTMP=Object();oTMP.idcomunidad=window.tablelistadoComunidadesAutorizado.row(iSelCom).data().id,oTMP.asignada=window.tablelistadoComunidadesAutorizado.row(iSelCom).data().asignada,oComunidades.push(oTMP)}return oComunidades},Validate:function(){let resultadoValidacion=!1;return core.Forms.Validate(),""!==$(".form-autorizado #email").val()&&(core.Validator.Email($(".form-autorizado #email").val())||core.Forms.SetError("El formato del e-mail no es correcto")),""!==$(".form-autorizado #password").val()&&$(".form-autorizado #password").val()!==$(".form-autorizado #passwordConfirme").val()&&core.Forms.SetError("Las contraseñas no coinciden"),""===core.Forms.GetErrorMessage()&&(resultadoValidacion=!0),resultadoValidacion},Save:function(){usuarioCore.Autorizado.Model.Validate()?(core.Forms.prepareFormDataBeforeSend("form-autorizado"),core.Forms.data.comunidadesasignadas=usuarioCore.Autorizado.Model.GetComunidadesAsignadas(),core.Forms.Save(!0)):core.Forms.ShowErrorMessage()},add:function(){},update:function(){},delete:function(id,nombre){core.Modelo.Delete("autorizado",id,nombre,"listadoUsuariosAutorizados")}}}};$(()=>{usuarioCore.init()});