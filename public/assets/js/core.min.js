let clickEventType=null!==document.ontouchstart?"click":"touchstart",environment="d",baseURL="/fincatech/";var role=null,showingLoadComunidades=!1;let Constantes={CargaComunidades:`\n   <div class="row">\n        <div class="col-12 text-center text-uppercase align-self-center">\n          <p class="m-0" style="display: block; font-size: 18px;"> Carga automática de comunidades</p>\n        </div>\n    </div>\n    <div class="row mb-2 wrapperInformacion">\n      <div class="col-12">\n          <p class="mt-3 text-justify" style="font-size: 14px;">1. Seleccione el administrador de fincas al que asignar las comunidades</p>\n          <p class="mt-3 text-justify" style="font-size: 14px;">2. Seleccione el fichero excel desde el que desea realizar la carga de comunidades de forma automática</p>\n          <p class="m-0 text-center" style="font-size: 14px;">\n            <a href="${baseURL}public/storage/plantilla_comunidades_fincatech.xlsx" target="_blank"><i class="bi bi-file-earmark-arrow-down"></i> Descargue la plantilla desde este enlace</a>\n          </p>\n          <p class="mt-3 text-left text-justify" style="font-size: 14px;">3. Una vez seleccionado, clique sobre el botón PROCESAR</p>\n      </div>\n    </div>\n    \x3c!-- Selector de administrador --\x3e\n    <div class="row mb-4 wrapperSelectorAdministrador">\n      <div class="col-12 text-left"><form>\n      <label for="administradorCargaId" class="mb-2">Seleccione el Administrador</label>\n      <select id="administradorCargaId" name="administradorCargaId" class="custom-select data form-control selectpicker mt-2" data-live-search="true" hs-entity="Administrador" hs-field="usuarioId" hs-list-entity="Administrador" hs-list-field="Usuario.nombre" hs-list-value="Usuario.id"></select></form>\n      </div>  \n    </div>\n\n    <div class="form-group row mb-2 justify-content-center wrapperSelectorFichero">\n      <div class="col-12">  \n          <div class="wrapperFichero row border rounded-lg ml-0 mr-0 mb-0 shadow-inset border-1 pt-3 pb-2">\n              <div class="col-2 align-self-center h-100 text-center">\n                  <i class="bi bi-cloud-arrow-up text-info" style="font-size: 30px;"></i>\n              </div>\n              <div class="col-10 pl-0 align-self-center">\n                  <input accept=".xls, .xlsx" class="form-control form-control-sm ficheroAdjuntarExcel border-0" hs-fichero-entity="Notasinformativas" id="ficheroAdjuntarExcel" type="file">\n              </div>       \n          </div>\n          <span class="pb-3 d-block text-center pt-2" style="font-size: 13px;">Sólo se permiten ficheros con extensión xls o xlsx</span>    \n          \n          \x3c!-- Mensaje de error --\x3e \n          <div class="wrapperMensajeErrorCarga row text-light p-3" style="display: none; font-size: 14px;">\n              <div class="col-12 bg-danger p-3 rounded shadow-neumorphic">\n                <p class="mensaje"></p>\n              </div>\n          </div>          \n\n          \x3c!-- Botón de iniciar proceso --\x3e\n          <div class="row mt-3">\n            <div class="col-12">\n              <a href="javascript:void(0);" class="btn d-block btn-success bntProcesarImportacion pt-3 pb-3">PROCESAR</a>\n            </div>\n          </div>\n      </div>\n    </div>\n\n    <div class="wrapperProgresoCarga row" style="display: none;">\n      <div class="col-12">\n          <label class="text-center mb-2 mt-3">Procesando fichero</label>\n          <div class="progress mb-3" style="height: 30px;">\n            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">Animated</div>\n          </div>\n          <label class="progresoCarga">(n de y procesados)</label>\n          <div class="row mt-3 btnCerrarProceso" style="display: none;">\n            <div class="col-12">\n              <a href="javascript:swal.close();" class="btn btn-success">OK</a>\n            </div>\n          </div>\n      </div>\n    </div>\n    `,CargaDocumento:'\n   <div class="row">\n        <div class="col-12 text-center text-uppercase align-self-center">\n          <p class="m-0" style="display: block; font-size: 18px;"> Carga de documento</p>\n        </div>\n    </div>\n    <div class="row mb-2 wrapperInformacion">\n      <div class="col-12">\n          <p class="mt-3 text-justify" style="font-size: 14px;">1. Seleccione el fichero que desea adjuntar al requerimiento</p>\n          <p class="mt-3 text-justify" style="font-size: 14px;">2. Presione el botón <strong>Adjuntar documento</strong></p>\n      </div>\n    </div>\n    <div class="form-group row mb-2 justify-content-center wrapperSelectorFichero">\n      <div class="col-12">  \n          <div class="wrapperFichero row border rounded-lg ml-0 mr-0 mb-0 shadow-inset border-1 pt-3 pb-2">\n              <div class="col-2 align-self-center h-100 text-center">\n                  <i class="bi bi-cloud-arrow-up text-info" style="font-size: 30px;"></i>\n              </div>\n              <div class="col-10 pl-0 align-self-center">\n                  <input accept=".pdf, .doc, .docx" class="form-control form-control-sm ficheroAdjuntar border-0" hs-fichero-entity="Documental" id="ficheroadjuntar" name="ficheroadjuntar" type="file">\n              </div>       \n          </div>\n          <span class="pb-3 d-block text-center pt-2" style="font-size: 13px;">Sólo se permiten ficheros con extensión pdf, doc o docx</span>    \n          \n          \x3c!-- Mensaje de error --\x3e \n          <div class="wrapperMensajeErrorCarga row text-light p-3" style="display: none; font-size: 14px;">\n              <div class="col-12 bg-danger p-3 rounded shadow-neumorphic">\n                <p class="mensaje"></p>\n              </div>\n          </div>          \n\n          \x3c!-- Botón de iniciar proceso --\x3e\n          <div class="row mt-3">\n            <div class="col-12">\n              <a href="javascript:void(0);" class="btn d-block btn-success bntUploadDocumento pt-3 pb-3">Adjuntar documento</a>\n            </div>\n          </div>\n      </div>\n    </div>\n    ',AsignacionEmpresa:'\n    <div class="row">\n        <div class="col-12 text-center text-uppercase align-self-center">\n          <p class="m-0" style="display: block; font-size: 18px;"> Asociar empresa externa a comunidad</p>\n        </div>\n    </div>\n    <div class="row mb-2 wrapperInformacion">\n      <div class="col-12">\n          <p class="mt-3 text-justify" style="font-size: 14px;">Para asignar una empresa, puede buscar por nombre, e-mail o CIF/NIF en el listado de empresas que tiene en pantalla.</p>\n          <p class="mt-3 text-justify" style="font-size: 14px;">Si no encuentra la empresa que desea asociar, puede crear una nueva clicando sobre el botón CREAR NUEVA EMPRESA. Una vez creada la empresa, ésta será asignada automáticamente a la comunidad actual.</p>\n      </div>\n    </div>\n\n    \x3c!-- Listado simple de empresas del sistema--\x3e\n\n    <div class="row mb-4 wrapperSelectorEmpresa">\n\n      <div class="col-12 text-left">\n\n          <div class="card-body shadow-inset rounded-lg border mb-1 border-white space-between">\n\n          \x3c!-- Empresas --\x3e\n\n              <div class="row flex-grow-1">\n                  <div class="col-12">\n\n                      <div class="card">\n\n                          <div class="card-header pl-0 pt-0">\x3c!--headerListado--\x3e\n\n                              <div class="row">\n\n                                  <div class="col-12 col-md-9">\n                                      <h5 class="card-title mb-0 text-uppercase font-weight-normal pl-3 pt-1"><i class="bi bi-shop pr-2"></i> Empresas disponibles</h5>\n                                  </div>\n                      \n                              </div>\n\n                          </div>\n\n                          <div class="card-body">\n\n                              <table class="table table-hover my-0 hs-tabla w-100" name="listadoSimpleEmpresas" id="listadoSimpleEmpresas" data-model="Empresa">\n                                  <thead></thead>\n                                  <tbody></tbody>\n                              </table>\n\n                          </div>\n\n                      </div>\n\n                  </div>\n              </div>\n\n          </div>\n\n      </div>  \n\n    </div>\n\n    <div class="form-group row mb-2 justify-content-center wrapperCrearNuevaEmpresa">\n      <div class="col-12">           \n          \x3c!-- Botón de crear empresa y asignar a comunidad --\x3e\n          <div class="row mt-3">\n            <div class="col-12 text-center">\n              <a href="javascript:void(0);" class="btn btn-success bntCrearNuevaEmpresaCAE pt-1 pb-1">CREAR NUEVA EMPRESA</a>\n            </div>\n          </div>\n      </div>\n    </div>\n    ',CargaDocumentoRGPD:'\n    <div class="row">\n         <div class="col-12 text-center text-uppercase align-self-center">\n           <p class="m-0" style="display: block; font-size: 18px;"> Carga de documento</p>\n         </div>\n     </div>\n     <div class="row mb-2 wrapperInformacion">\n       <div class="col-12">\n           <p class="mt-3 text-justify" style="font-size: 14px;">1. Seleccione el fichero que desea adjuntar</p>\n           <p class="mt-3 text-justify" style="font-size: 14px;">2. Presione el botón <strong>Adjuntar documento</strong></p>\n       </div>\n     </div>\n     <div class="form-group row mb-2 justify-content-center wrapperSelectorFichero">\n       <div class="col-12">  \n           <div class="wrapperFichero row border rounded-lg ml-0 mr-0 mb-0 shadow-inset border-1 pt-3 pb-2">\n               <div class="col-2 align-self-center h-100 text-center">\n                   <i class="bi bi-cloud-arrow-up text-info" style="font-size: 30px;"></i>\n               </div>\n               <div class="col-10 pl-0 align-self-center">\n                   <input accept=".pdf, .doc, .docx" class="form-control form-control-sm ficheroAdjuntar border-0" hs-fichero-entity="Documental" id="ficheroadjuntar" name="ficheroadjuntar" type="file">\n               </div>       \n           </div>\n           <span class="pb-3 d-block text-center pt-2" style="font-size: 13px;">Sólo se permiten ficheros con extensión pdf, doc o docx</span>    \n           \n          <div class="row form-group text-left">\n            <div class="col-12">\n              <label>Título</label>\n              <input type="text" class="form-control w-100 tituloDocumentoRGPD mt-2" id="tituloDocumentoRGPD" maxlength="40" name="tituloDocumentoRGPD">\n            </div>\n          </div>\n          <div class="row form-group text-left mt-2">\n            <div class="col-12">\n              <label>Descripción</label>\n              <textarea class="form-control w-100 observacionesDocumentoRGPD shadow-inset border-0 mt-2" id="observacionesDocumentoRGPD" rows="3" name="observacionesDocumentoRGPD"></textarea>\n            </div>\n          </div>          \n           \x3c!-- Mensaje de error --\x3e \n           <div class="wrapperMensajeErrorCarga row text-light p-3" style="display: none; font-size: 14px;">\n               <div class="col-12 bg-danger p-3 rounded shadow-neumorphic">\n                 <p class="mensaje"></p>\n               </div>\n           </div>          \n \n           \x3c!-- Botón de adjuntar documento --\x3e\n           <div class="row mt-3">\n             <div class="col-12">\n               <a href="javascript:void(0);" class="btn d-block btn-success bntUploadDocumentoRGPD pt-3 pb-3">Adjuntar documento</a>\n             </div>\n           </div>\n       </div>\n     </div>\n     '},core={model:null,actionModel:null,modelId:null,init:async function(){if(core.model=$("body").attr("hs-model"),core.actionModel=$("body").attr("hs-action"),core.modelId=$("body").attr("hs-model-id"),"Login"===core.model||"Register"===core.model)core.Security.init();else switch(core.actionModel){case"get":case"add":await core.Forms.init();break;case"list":"Dashboard"!=core.model&&await core.Modelo.getAll()}core.Events(),core.Security.getUserInfo()},Events:function(){$("body").on(core.helper.clickEventType,".btnLogout",(function(){core.Security.logout()})),$("body").on(core.helper.clickEventType,".btnSaveData",(function(){core.Forms.Save(!1)})),$("body").on(core.helper.clickEventType,".btnCargarComunidadesExcel",(async function(){const{value:file}=await Swal.fire({title:"",html:Constantes.CargaComunidades,showCancelButton:!1,showConfirmButton:!1,showCloseButton:!0,didOpen:function(){showingLoadComunidades=!0,core.Files.init(),core.Forms.getSelectData("Administrador","Usuario.nombre","Usuario.id","usuarioId",$("#administradorCargaId").attr("hs-value"),$("#administradorCargaId").prop("id"),!1).then(()=>{$("#administradorCargaId").select2({dropdownParent:$(".swal2-container")})}),$("body").on(core.helper.clickEventType,".bntProcesarImportacion",(function(){comunidadesCore.Import.importarComunidades()}))}})}))},helper:{clickEventType:null!==document.ontouchstart?"click":"touchstart",sortList:function(selector){$(selector).find("option").sort((function(a,b){return Number(a.innerHTML)-Number(b.innerHTML)})).each((function(index,el){$(el).parent().append(el)}))}},Files:{Fichero:Object(),file:null,init:async function(){core.Files.Fichero.entidad=null,core.Files.Fichero.entidadId=null,core.Files.Fichero.nombre=null,core.Files.Fichero.base64=null,core.Files.events()},events:function(){if(!$("#ficheroadjuntar").length)return;const fileInput=document.getElementById("ficheroadjuntar");fileInput.addEventListener("change",e=>{const file=e.target.files[0];if(void 0!==file){const reader=new FileReader;reader.onloadend=()=>{const base64String=reader.result;core.Files.Fichero.base64=base64String,core.Files.Fichero.entidad=core.model;var fullPath=document.getElementById("ficheroadjuntar").value;if(fullPath){var startIndex=fullPath.indexOf("\\")>=0?fullPath.lastIndexOf("\\"):fullPath.lastIndexOf("/"),filename=fullPath.substring(startIndex);0!==filename.indexOf("\\")&&0!==filename.indexOf("/")||(filename=filename.substring(1)),core.Files.Fichero.nombre=filename,console.log("Nombre: "+filename)}},reader.readAsDataURL(file)}else core.Files.Fichero.base64="",core.Files.Fichero.nombre=""})},isExcelFile:function(idDOMInputFile){var resultado=!1,regex;return!!/^([a-zA-Z0-9\s_\\.\-:])+(.xlsx|.xls)$/.test($(`#${idDOMInputFile}`).val().toLowerCase())}},Forms:{data:null,init:async function(){await core.Forms.getSchema().then(result=>{core.Modelo.schema=result,core.Forms.initializeSelectData(),""!=core.modelId&&apiFincatech.get(core.model.toLowerCase()+"/"+core.modelId).then(result=>{core.Modelo.entity[core.model]=JSON.parse(result).data[core.model],core.Forms.mapData(),$("#password").length&&$("#password").val(""),null!==CoreUI.tituloModulo&&CoreUI.Utils.setTituloPantalla(null,null,core.Modelo.entity[core.model][0][CoreUI.tituloModulo])})})},getSchema:async function(){return apiFincatech.get(core.model.toLowerCase()+"/schema").then(result=>{core.Modelo.schema=result})},initializeSelectData:function(){$("body .form-data .select-data").length&&($("body .form-data .select-data").each((function(){var insertarOpcionSeleccionar=!1,entidadCombo=$(this).attr("hs-list-entity"),keyField=$(this).attr("hs-list-field"),keyValue=$(this).attr("hs-list-value"),elDOM=$(this).prop("id"),keyOriginField=$(this).attr("hs-field"),keyOriginValue=$(this).attr("hs-value");void 0!==$(this).attr("hs-seleccionar")&&(insertarOpcionSeleccionar=$(this).attr("hs-seleccionar")),core.Forms.getSelectData(entidadCombo,keyField,keyValue,null,null,elDOM,insertarOpcionSeleccionar),$(".selectpicker").select2({theme:"bootstrap4"})})),$(".selectpicker").select2({theme:"bootstrap4"}))},mapData:async function(formularioMapeo=null){var formularioDestino="body .form-data";null!==formularioMapeo&&(formularioDestino=`body .${formularioMapeo}`),$(formularioDestino).length&&($(`${formularioDestino} .data`).each((function(){var entidad=$(this).attr("hs-entity"),campo=$(this).attr("hs-field"),valor="";if(void 0!==core.Modelo.entity[entidad][0][campo]&&(valor=core.Modelo.entity[entidad][0][campo]),"password"!=campo)if($(this).hasClass("select-data")){var id=$(this).attr("id");void 0!==id&&-1!==id&&""!==valor&&$(`#${id} option[value=${valor}]`).attr("selected","selected")}else $(this).hasClass("form-check-input")?(console.log("Valor checkbox campo : "+campo+" - "+valor),1==valor?(console.log("Intentando checar"),$(this).attr("checked",!0)):(console.log("Intentando checar false"),$(this).attr("checked",!1))):$(this).val(valor);else $(this).val("")})),$(".selectpicker").select2({theme:"bootstrap4"}),$(".selectpicker").each((function(){$(this).trigger("change")})),$('body input[type="number"]').each((function(e){$(this).val($(this).attr("value"))})))},getValueByTipoCampo:function(e){return e.is("select")?null==e.val()||""==e.val()?-1:e.val():e.is("checkbox")||"checkbox"==e.attr("type")?e.is(":checked")?1:0:e.val()},mapFormDataToSave:function(formularioProceso){core.Forms.data={},null==formularioProceso&&(formularioProceso="form-data");var modelo=$(`body .${formularioProceso}`).attr("hs-model");$(`body .${formularioProceso} .data`).each((function(){var fieldName=$(this).attr("hs-field"),entity=$(this).attr("hs-entity");core.Forms.data[fieldName]=core.Forms.getValueByTipoCampo($(this))}))},mapDataToSave:function(formularioProceso=null){core.Forms.data={},null==formularioProceso&&(formularioProceso="form-data"),$(`body .${formularioProceso} .data`).each((function(){var fieldName=$(this).attr("hs-field"),entity=$(this).attr("hs-entity"),entityRelated=null;void 0!==$(this).attr("hs-entity-related")&&null!==$(this).attr("hs-entity-related")&&(entityRelated=$(this).attr("hs-entity-related")),entity==core.model&&null==entityRelated?("id"!=fieldName&&(core.Forms.data[fieldName]=$(this).val()),core.Forms.data[fieldName]=core.Forms.getValueByTipoCampo($(this))):"id"!=fieldName&&(void 0===core.Forms.data[entityRelated]&&(core.Forms.data[entityRelated]={}),core.Forms.data[entityRelated][fieldName]=core.Forms.getValueByTipoCampo($(this)))})),"get"==core.actionModel&&""!=core.Forms.data.id&&(core.Forms.data.id=core.modelId)},getSelectData:async function(entidad,keyField,keyValue,keyOriginField,keyOriginValue,elementoDOM,insertarOpcionSeleccionar){$("body #"+elementoDOM).html(""),await apiFincatech.get(`${entidad}/list?target=cbo`).then(async data=>{var htmlOutput="",result=JSON.parse(data);if(responseData=result.data,keyField.indexOf(".")>=0){var entidadSeleccionada=keyField.split(".");entidad=entidadSeleccionada[0],keyField=entidadSeleccionada[1]}if(keyValue.indexOf(".")>=0){var entidadSeleccionada=keyValue.split(".");entidad=entidadSeleccionada[0],keyValue=entidadSeleccionada[1]}for(htmlOutput='<option value="-1" disabled selected="selected">SELECCIONE UNA OPCIÓN</option>',$("body #"+elementoDOM).append(htmlOutput),x=0;x<responseData[entidad].length;x++){var valueId,value;htmlOutput=`<option value="${responseData[entidad][x][keyValue]}">${responseData[entidad][x][keyField]}</option>`,$("body #"+elementoDOM).append(htmlOutput)}$("body #"+elementoDOM).select2({theme:"bootstrap4"})})},Save:async function(dataAlreadyMapped=!0){var entidadSave=$("body").attr("hs-model"),idSave=$("body").attr("hs-model-id"),actionSave=$("body").attr("hs-action");switch(0==dataAlreadyMapped&&(console.log("dataAlreadymapped false"),core.Forms.data={},core.Forms.mapDataToSave()),console.log("accion: "+actionSave),actionSave){case"get":core.Modelo.Update(core.model.toLowerCase(),idSave,core.Forms.data);break;case"add":core.Modelo.Insert(core.model.toLowerCase(),core.Forms.data,!0)}},Validate:function(nombreFormulario=null){var result=!0;return null==nombreFormulario&&(nombreFormulario="form-data"),0==$(`body .${nombreFormulario} .form-required`).length||($(`body .${nombreFormulario} .form-required`).each((function(){""==$(this).val()&&(result=!1)})),result)}},Modelo:{entity:Object(),schema:Object(),getAll:async function(params){var data={};null!=params&&(data=params),await apiFincatech.post(`${core.model.toLowerCase()}/list`,data).then(async data=>{result=JSON.parse(data),responseStatus=result.status,responseData=result.data}).catch((function(error){}))},Insert:async function(entidadSave,postData,updateModel=!0){await apiFincatech.post(`${entidadSave}/create`,postData).then(async response=>{var responseData=JSON.parse(response);if("ok"==responseData.status.response){if(updateModel){var idInsercion=responseData.data.id;$("body").attr("hs-action","get"),$("body").attr("hs-model-id",idInsercion),core.actionModel="get",core.modelId=idInsercion}CoreUI.Modal.Success("El registro se ha creado correctamente")}else Modal.Error("No se ha podido guardar por el siguiente motivo:<br><br>"+responseData.status.response)})},Delete:async function(endpoint,id,nombre,nombreListadoDOM,titulo=null,mensaje=null){Swal.fire({title:null==titulo?"¿Desea eliminar el registro y toda la información relacionada?":titulo,text:null==mensaje?`${nombre}`:mensaje,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then(result=>{result.isConfirmed&&apiFincatech.delete(endpoint,id).then(result=>{Swal.fire("Registro eliminado correctamente","","success"),$(`#${nombreListadoDOM}`).DataTable().ajax.reload()})})},Update:async function(endpoint,id,jsonPostData){await apiFincatech.put(`${endpoint}/${id}`,jsonPostData).then(async response=>{var responseData=JSON.parse(response);"ok"==responseData.status.response?CoreUI.Modal.Success("El registro se ha actualizado correctamente"):Modal.Error("No se ha podido guardar por el siguiente motivo:<br><br>"+responseData.status.response)})}},Security:{init:function(){this.events(),core.model="Login",$("#email").length&&$("#email").focus(),$("#email").val(""),$("#password").val(""),$("form").attr("autocomplete","off"),$("input").attr("autocomplete","off")},events:function(){$("body").on(core.helper.clickEventType,".btnAuthenticate",(function(e){core.Forms.Validate()?(core.Forms.mapDataToSave(),core.Security.checkLogin(core.Forms.data)):CoreUI.Modal.Error("Debe proporcionar todos los datos obligatorios")})),$("input").keyup((function(event){13===event.key?$(".btnAuthenticate").trigger("click"):13===event.keyIdentifier?$(".btnAuthenticate").trigger("click"):13===event.keyCode&&$(".btnAuthenticate").trigger("click")}))},getUserInfo:async function(){await apiFincatech.get("userinfo").then(response=>{respuesta=JSON.parse(response),null!=respuesta.user.nombre&&""!=respuesta.user.nombre?$(".usuarioFincatech").text(respuesta.user.nombre):$(".usuarioFincatech").text("Fincatech")})},logout:async function(){await apiFincatech.get("logout").then(response=>{respuesta=JSON.parse(response),"ok"==respuesta.data.logout&&CoreUI.Modal.Success("La sesión se ha cerrado correctamente","Fincatech",(function(){window.location.href=baseURL+"login"}))})},checkLogin:async function(datos){await apiFincatech.post("checklogin",datos).then(response=>{respuesta=JSON.parse(response),!1===respuesta.data.check?CoreUI.Modal.Error("El e-mail y/o contraseña proporcionada es incorrecto"):CoreUI.Modal.Success("Login Correcto","Fincatech",(function(){window.location.href="dashboard"}))})},getRole:function(){return $("body").attr("hs-role")}}};$((function(){apiFincatech.init(),core.init(),$(".loading").hide()}));