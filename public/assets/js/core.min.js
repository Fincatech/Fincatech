let clickEventType=null!==document.ontouchstart?"click":"touchstart",environment="d",baseURL="/fincatech/",Constantes={CargaComunidades:'\n   <p class="text-center mb-0 mt-1"><i class="bi bi-file-earmark-arrow-up" style="font-size:60px;"></i></p>\n   <h2 class="swal2-title" id="swal2-title" style="display: block;">Carga automática de comunidades</h2>\n   <p class="mt-3" style="font-size: 14px;">Seleccione el fichero excel desde el que desea realizar la carga de comunidades de forma automática</p>\n   <p style="font-size: 14px;">Sólo se permiten ficheros con extensión xls o xlsx</p>'},core={model:null,actionModel:null,modelId:null,init:async function(){if(core.model=$("body").attr("hs-model"),core.actionModel=$("body").attr("hs-action"),core.modelId=$("body").attr("hs-model-id"),"Login"===core.model||"Register"===core.model)core.Security.init();else switch(core.actionModel){case"get":case"add":await core.Forms.init();break;case"list":"Dashboard"!=core.model&&await core.Modelo.getAll()}core.Events()},Events:function(){$("body").on(core.helper.clickEventType,".btnLogout",(function(){core.Security.logout()})),$("body").on(core.helper.clickEventType,".btnSaveData",(function(){core.Forms.Save()})),$("body").on(core.helper.clickEventType,".btnCargarComunidadesExcel",(async function(){const{value:file}=await Swal.fire({html:Constantes.CargaComunidades,footer:'<a href="javascript:void(0);"><i class="bi bi-file-earmark-arrow-down"></i> Descargue la plantilla desde este enlace</a>',showCancelButton:!0,grow:"row",confirmButtonColor:"#28a745",cancelButtonColor:"#dc3545",cancelButtonText:"Cancelar",confirmButtonText:"Procesar",reverseButtons:!0,showCloseButton:!0,input:"file",inputAttributes:{accept:"image/*","aria-label":"Upload your profile picture"}});if(file){const reader=new FileReader;reader.onload=e=>{Swal.fire({title:"Your uploaded picture",imageUrl:e.target.result,imageAlt:"The uploaded picture"})},reader.readAsDataURL(file)}}))},helper:{clickEventType:null!==document.ontouchstart?"click":"touchstart",sortList:function(selector){$(selector).find("option").sort((function(a,b){return Number(a.innerHTML)-Number(b.innerHTML)})).each((function(index,el){$(el).parent().append(el)}))}},Forms:{data:null,init:async function(){await core.Forms.getSchema().then(result=>{core.Modelo.schema=result,$("body .form-data .select-data").length&&($("body .form-data .select-data").each((function(){var entidadCombo=$(this).attr("hs-list-entity"),keyField=$(this).attr("hs-list-field"),keyValue=$(this).attr("hs-list-value"),elDOM=$(this).prop("id"),keyOriginField=$(this).attr("hs-field"),keyOriginValue=$(this).attr("hs-value");core.Forms.getSelectData(entidadCombo,keyField,keyValue,keyOriginField,keyOriginValue,elDOM)})),$(".selectpicker").select2({theme:"bootstrap4"})),""!=core.modelId&&apiFincatech.get(core.model.toLowerCase()+"/"+core.modelId).then(result=>{core.Modelo.entity[core.model]=JSON.parse(result).data[core.model],core.Forms.mapData()})})},getSchema:async function(){return apiFincatech.get(core.model.toLowerCase()+"/schema").then(result=>{core.Modelo.schema=result})},mapData:async function(){$("body .form-data").length&&($("body .data").each((function(){var entidad=$(this).attr("hs-entity"),campo=$(this).attr("hs-field"),valor=core.Modelo.entity[entidad][0][campo];if($(this).hasClass("select-data")){var id=$(this).attr("id");$(`#${id} option[value=${valor}]`).attr("selected","selected")}else $(this).val(valor)})),$(".selectpicker").select2({theme:"bootstrap4"}))},mapDataToSave:function(){core.Forms.data={},$("body .form-data .data").each((function(){var fieldName=$(this).attr("hs-field"),entity=$(this).attr("hs-entity");entity==core.model?("id"!=fieldName&&(core.Forms.data[fieldName]=$(this).val()),$(this).is("select")&&(console.log("Es un combo!"),console.log("Valor del select: "+$(this).val())),"checkbox"===$(this).attr("type")&&($(this).is(":checked")?core.Forms.data[fieldName]=$(this).val():core.Forms.data[fieldName]="")):"id"!=fieldName&&(core.Forms.data[entity][fieldName]=$(this).val())})),"get"==core.actionModel&&""!=core.Forms.data.id&&(core.Forms.data.id=core.modelId)},getSelectData:async function(entidad,keyField,keyValue,keyOriginField,keyOriginValue,elementoDOM){$("body #"+elementoDOM).html(""),await apiFincatech.get(`${entidad}/list?target=cbo`).then(async data=>{var htmlOutput="",result=JSON.parse(data);if(responseData=result.data,keyField.indexOf(".")>=0){var entidadSeleccionada=keyField.split(".");entidad=entidadSeleccionada[0],keyField=entidadSeleccionada[1]}if(keyValue.indexOf(".")>=0){var entidadSeleccionada=keyValue.split(".");entidad=entidadSeleccionada[0],keyValue=entidadSeleccionada[1]}for(x=0;x<responseData[entidad].length;x++){var valueId,value;htmlOutput=`<option value="${responseData[entidad][x][keyValue]}">${responseData[entidad][x][keyField]}</option>`,$("body #"+elementoDOM).append(htmlOutput)}})},Save:async function(){var entidadSave=$("body").attr("hs-model"),idSave=$("body").attr("hs-model-id"),actionSave=$("body").attr("hs-action");switch(core.Forms.data={},core.Forms.mapDataToSave(),actionSave){case"get":core.Modelo.Update(core.model.toLowerCase(),idSave,core.Forms.data);break;case"add":core.Modelo.Insert(core.model.toLowerCase(),core.Forms.data)}},Validate:function(){var result=!0;return 0==$("body .form-required").length||($("body .form-required").each((function(){""==$(this).val()&&(result=!1)})),result)}},Modelo:{entity:Object(),schema:Object(),getAll:async function(){await apiFincatech.get(`${core.model.toLowerCase()}/list`).then(async data=>{result=JSON.parse(data),responseStatus=result.status,responseData=result.data})},Insert:async function(entidadSave,postData){await apiFincatech.post(`${entidadSave}/create`,JSON.stringify(postData)).then(async response=>{var responseData=JSON.parse(response);if("ok"==responseData.status.response){var idInsercion=responseData.data.id;$("body").attr("hs-action","get"),$("body").attr("hs-model-id",idInsercion),core.actionModel="get",core.modelId=idInsercion,CoreUI.Modal.Success("El registro se ha creado correctamente")}else Modal.Error("No se ha podido guardar por el siguiente motivo:<br><br>"+responseData.status.response)})},Delete:async function(endpoint,id,nombre,nombreListadoDOM,titulo=null,mensaje=null){Swal.fire({title:"¿Desea eliminar el registro y toda la información relacionada?",text:`${nombre}`,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then(result=>{result.isConfirmed&&apiFincatech.delete(endpoint,id).then(result=>{Swal.fire("Registro eliminado correctamente","","success"),$(`#${nombreListadoDOM}`).DataTable().ajax.reload()})})},Update:async function(endpoint,id,jsonPostData){await apiFincatech.put(`${endpoint}/${id}`,JSON.stringify(jsonPostData)).then(async response=>{var responseData=JSON.parse(response);"ok"==responseData.status.response?CoreUI.Modal.Success("El registro se ha actualizado correctamente"):Modal.Error("No se ha podido guardar por el siguiente motivo:<br><br>"+responseData.status.response)})}},Security:{init:function(){this.events(),core.model="Login",$("#email").length&&$("#email").focus(),$("#email").val(""),$("#password").val(""),$("form").attr("autocomplete","off"),$("input").attr("autocomplete","off")},events:function(){$("body").on(core.helper.clickEventType,".btnAuthenticate",(function(e){core.Forms.Validate()?(core.Forms.mapDataToSave(),core.Security.checkLogin(core.Forms.data)):CoreUI.Modal.Error("Debe proporcionar todos los datos obligatorios")})),$("input").keyup((function(event){13===event.key?$(".btnAuthenticate").trigger("click"):13===event.keyIdentifier?$(".btnAuthenticate").trigger("click"):13===event.keyCode&&$(".btnAuthenticate").trigger("click")}))},logout:async function(){await apiFincatech.get("logout").then(response=>{respuesta=JSON.parse(response),"ok"==respuesta.data.logout&&CoreUI.Modal.Success("La sesión se ha cerrado correctamente","Fincatech",(function(){window.location.href=baseURL+"login"}))})},checkLogin:async function(datos){await apiFincatech.post("checklogin",JSON.stringify(datos)).then(response=>{respuesta=JSON.parse(response),!1===respuesta.data.check?CoreUI.Modal.Error("El e-mail y/o contraseña proporcionada es incorrecto"):CoreUI.Modal.Success("Login Correcto","Fincatech",(function(){window.location.href="dashboard"}))})}}};$((function(){apiFincatech.init(),core.init()}));