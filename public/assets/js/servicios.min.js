let serviciosCore={servicios:Object(),servicio:Object(),caeContratado:!1,rgpdContratado:!1,Controller:{ProcesarUpdateFicheroServicios:async function(e){$(".wrapperProgresoCarga").show();var a=$("#ficheroAdjuntarExcel")[0].files[0],t=new ExcelJS.Workbook;let i=[],o=[];await t.xlsx.load(a.arrayBuffer()).then((()=>{t.worksheets[0].eachRow(((e,a)=>{if(a>0){let t=e.values;if(t.shift(),1===a)o=t;else{let e={};for(let a=0;a<o.length;a++){let i=o[a],s=t[a];e[i]=s}i.push(e)}}}))})).then((async()=>{for($(".wrapperProgresoCarga .progress-bar").css("width","0%"),$(".wrapperProgresoCarga .progress-bar-striped").html("0%"),x=0;x<i.length;x++)$(".wrapperProgresoCarga .progresoCarga").html(`(${x+1} de `+i.length+")"),i[x].type="single",await apiFincatech.put(`comunidad/${i[x]["Id Comunidad"]}/servicios`,i[x]);CoreUI.Modal.Success("Los servicios se han actualizado satisfactoriamente","Actualización masiva de servicios")}))}},Model:{actualizarServicios:function(){var e=Object();e.type="bulk",e.servicesdata=[],$("body #listadoServiciosContratadosComunidades tbody tr").each((function(){let a=$(this).attr("data-idcomunidad"),t=$(this);$(this).find(".servicio_contratado").each((function(){let i=$(this).attr("data-id"),o=$(this).attr("data-idtiposervicio"),s=$(this).attr("data-tipo"),r=Object();r.idcomunidad=a,r.id=i,r.idtiposervicio=o,r.contratado=!!$(this).is(":checked"),r.mesfacturacion=$(t).find(`.mes-facturacion-${s} option:selected`).val(),r.precio=$(t).find(`.precio-${s}`).val(),r.preciocomunidad=$(t).find(`.precio-comunidad-${s}`).val(),e.servicesdata.push(r)}))})),e.servicesdata.length>0&&apiFincatech.put("servicios/0",e).then((e=>{JSON.parse(e);CoreUI.Modal.Success("Los servicios modificados se han actualizado satisfactoriamente","Actualización de Servicios Contratados",(function(){comunidadesCore.Render.tablaServiciosContratadosComunidades()}))}))}},init:async function(){serviciosCore.events(),await serviciosCore.renderServicios().catch((e=>{}))},events:function(){$("body").on(core.helper.clickEventType,".btnGuardarPreciosServicios",(function(e){serviciosCore.Model.actualizarServicios()}))},eliminar:function(e,a){},mapServiciosContratados:function(){core.Forms.data.comunidadservicioscontratados=[],$("body .dataServicioContratado").each((function(){var e,a,t,i,o=$(this).attr("data-idservicio"),s=$(this).attr("data-idserviciocomunidad");e=$(this).find(".servicioContratado").is(":checked")?1:0,a=$(this).find(".servicioPrecio").val(),i=$(this).find(".servicio-mesfacturacion option:selected").val(),t=$(this).find(".servicioPrecioComunidad").val(),infoServicio=Object(),infoServicio.idserviciocomunidad=s,infoServicio.idcomunidad=core.modelId,infoServicio.idservicio=o,infoServicio.precio=a,infoServicio.preciocomunidad=t,infoServicio.contratado=e,infoServicio["servicio-mesfacturacion"]=""==i?"12":i,core.Forms.data.comunidadservicioscontratados.push(infoServicio)}))},addServiceToTable:function(e,a,t=!1){var i=1==e.contratado?' checked="checked" ':"";if(t){var o=parseFloat(e.preciocomunidad)-parseFloat(e.precio),s=`\n            <tr class="dataServicioContratado" data-idservicio="${e.id}" data-idserviciocomunidad="${a}">\n                <td class="mb-0 pb-0">\n                    <div class="form-check">\n                    <input type="hidden" class="data" hs-entity-related="comunidadservicioscontratados" hs-entity="Comunidad" hs-field="idservicio" value="${e.id}">\n                        <input class="form-check-input servicioContratado" type="checkbox" ${i} value="${e.id}" data-id="${e.id}" id="id-${e.id}">\n                        <label class="form-check-label" for="id-${e.id}">${e.nombre}</label>\n                    </div>\n                </td>\n                <td class="mb-0 pb-0">\n                    <input type="number" class="form-control text-center data servicioPrecio" maxlength="6" hs-entity-related="comunidadservicioscontratados" hs-entity="Comunidad" hs-field="precio" value="${e.precio}">\n                </td>\n                <td class="mb-0 pb-0">\n                    <input type="number" class="form-control text-center data servicioPrecioComunidad" maxlength="6" hs-entity-related="comunidadservicioscontratados" hs-entity="Comunidad" hs-field="preciocomunidad" value="${e.preciocomunidad}">\n                </td>\n                <td class="mb-0 pb-0 text-center">\n                    <select id="mesfacturacion-${e.id}" name="mesfacturacion-${e.id}" class=" servicio-mesfacturacion custom-select select-picker form-control w-100">\n                        <option value="1" ${1==e.mesfacturacion?"selected":""}>Enero</option>\n                        <option value="2" ${2==e.mesfacturacion?"selected":""}>Febrero</option>\n                        <option value="3" ${3==e.mesfacturacion?"selected":""}>Marzo</option>\n                        <option value="4" ${4==e.mesfacturacion?"selected":""}>Abril</option>\n                        <option value="5" ${5==e.mesfacturacion?"selected":""}>Mayo</option>\n                        <option value="6" ${6==e.mesfacturacion?"selected":""}>Junio</option>\n                        <option value="7" ${7==e.mesfacturacion?"selected":""}>Julio</option>\n                        <option value="8" ${8==e.mesfacturacion?"selected":""}>Agosto</option>\n                        <option value="9" ${9==e.mesfacturacion?"selected":""}>Septiembre</option>\n                        <option value="10" ${10==e.mesfacturacion?"selected":""}>Octubre</option>\n                        <option value="11" ${11==e.mesfacturacion?"selected":""}>Noviembre</option>\n                        <option value="12" ${12==e.mesfacturacion?"selected":""}>Diciembre</option>\n                    </select>          \n                </td>\n                <td class="mb-0 pb-0 text-right">\n                    <label class="retorno badge bg-success badge-pill text-white font-weight-normal d-block text-right" style="font-size: 16px;">${o.toFixed(2)}€</label>\n                </td>\n            </tr>\n            `;$("body .form-servicioscontratados table tbody").append(s)}else{var r=0==e.contratado||void 0===e.contratado?'<i class="bi bi-x-circle text-danger" style="font-size:21px;"></i>':'<i class="bi bi-check-circle text-success" style="font-size:21px;"></i>';s=`\n            <tr>\n                <td class="mb-0 pb-0">\n                        <label class="form-check-label">${e.nombre}</label>\n                </td>\n                <td class="mb-0 pb-0 text-center">${r}</td>\n            </tr>\n        `;$("body .form-servicioscontratados-info table tbody").append(s)}},renderServicios:async function(){var e="";switch($("body").attr("hs-role")){case"SUDO":if($(".form-servicioscontratados").length){switch(core.actionModel){case"add":e="servicios/list",nombreEntidad="Tiposservicios",_isAdding=!0;break;case"get":e=`comunidad/${core.modelId}/servicioscontratados`,nombreEntidad="comunidadservicioscontratados",_isAdding=!1;break}await apiFincatech.get(e).then((e=>{for(result=JSON.parse(e),responseStatus=result.status,_isAdding?responseData=result.data:responseData=result.data.Comunidad[0],$("body .form-servicioscontratados table tbody").html(""),x=0;x<responseData[nombreEntidad].length;x++){var a="";void 0!==responseData[nombreEntidad][x].idserviciocomunidad&&(a=responseData[nombreEntidad][x].idserviciocomunidad),serviciosCore.addServiceToTable(responseData[nombreEntidad][x],a,!0)}$(".servicio-mesfacturacion").each((function(){let e=$(this).children("option:selected").val();$(this).select2({theme:"bootstrap4"}),$(this).val(e).trigger("change")}))}))}break;default:if(void 0===core.modelId||""===core.modelId||"Comunidad"!==core.model)return;e=`comunidad/${core.modelId}/servicioscontratados`,nombreEntidad="comunidadservicioscontratados",await apiFincatech.get(e).then((async e=>{if(result=JSON.parse(e),responseStatus=result.status,responseData=result.data.Comunidad[0],caeContratado=!1,rgpdContratado=!1,certificadoDigitalContratado=!1,"ADMINFINCAS"==core.Security.getRole()&&(void 0!==responseData.comunidadservicioscontratados[0].contratado&&(caeContratado="0"!=responseData.comunidadservicioscontratados[0].contratado),void 0!==responseData.comunidadservicioscontratados[1].contratado&&(certificadoDigitalContratado="0"!=responseData.comunidadservicioscontratados[1].contratado),void 0!==responseData.comunidadservicioscontratados[4].contratado&&(rgpdContratado="0"!=responseData.comunidadservicioscontratados[4].contratado)),"CONTRATISTA"==core.Security.getRole()||"TECNICOCAE"==core.Security.getRole())return $(".enlaceRGPD").remove(),$(".enlaceCertificadoDigital").remove(),$(".btnAsociarEmpresaCAE").remove(),$(".empresasComunidadHeader").remove(),$(".wrapperEmpresasComunidad").remove(),void $(".wrapperEmpleadosEmpresaComunidad").remove();for($(".enlaceCae").removeClass("text-success"),$(".enlaceCae").removeClass("text-danger"),!1===caeContratado?($(".enlaceCae").attr("href","#"),$(".enlaceCae").removeClass("enlaceCae").addClass("enlaceKOCae"),$(".enlaceKOCae").addClass("text-danger")):$(".enlaceCae").addClass("text-success"),$(".enlaceRGPD").removeClass("text-success"),$(".enlaceRGPD").removeClass("text-danger"),!1===rgpdContratado?($(".enlaceRGPD").attr("href","#"),$(".enlaceRGPD").removeClass("enlaceRGPD").addClass("enlaceKORGPD"),$(".enlaceKORGPD").addClass("text-danger")):$(".enlaceRGPD").addClass("text-success"),!1===certificadoDigitalContratado?($(".enlaceCertificadoDigital").attr("href","#"),$(".enlaceCertificadoDigital").removeClass("enlaceCertificadoDigital").addClass("enlaceKOCertificadoDigital"),$(".enlaceKOCertificadoDigital").addClass("text-danger")):$(".enlaceCertificadoDigital").addClass("text-success"),$("body .form-servicioscontratados-info table tbody").html(""),x=0;x<responseData[nombreEntidad].length;x++){serviciosCore.addServiceToTable(responseData[nombreEntidad][x],null,!1)}$(".servicio-mesfacturacion").each((function(){let e=$(this).children("option:selected").val();$(this).select2({theme:"bootstrap4"}),$(this).val(e).trigger("change")}))}));break}},getSpa:async function(e){await apiFincatech.get("spa/"+e).then((e=>(result=JSON.parse(e),responseStatus=result.status,responseData=result.data,serviciosCore.spa=responseData.Spa[0],serviciosCore.spa)))},getAll:async function(){await apiFincatech.get("servicios/list").then((async e=>{result=JSON.parse(e),responseStatus=result.status,responseData=result.data,serviciosCore.servicios=responseData.Tiposservicios,serviciosCore.servicios.total=serviciosCore.Tiposservicios.length}))},Render:{Meses:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],ServiceInfo:function(e,a,t,i,o,s,r,c){let n;return n=`\n                <td class="bg-white text-center">\n                    ${serviciosCore.Render.StatusCheckbox(e,a,i,o,t)}\n                </td>\n                <td class="bg-white text-center pl-2 pr-2">\n                    ${serviciosCore.Render.MonthSelect(e,i,o,a,s)}\n                </td>\n                <td class="bg-white text-right pl-3 pr-3">\n                    ${serviciosCore.Render.InputPrecioPVP(e,a,i,o,r)}\n                </td>\n                <td class="bg-white text-right pl-3 pr-3">\n                    ${serviciosCore.Render.InputPrecioComunidad(e,a,i,o,c)}\n                </td>\n            `,n},StatusCheckbox:function(e,a,t,i,o){return`\n                <input data-id="${a}" data-idcomunidad="${t}" data-idtiposervicio="${i}" data-tipo="${e}" class="servicio_contratado servicio-contratado-${a}" type="checkbox" ${o}>\n            `},MonthSelect:function(e,a,t,i,o){let s,r=`<select data-idcomunidad="${a}" data-id="${i}" data-idtiposervicio="${t}" class=" servicio-mesfacturacion mes-facturacion-${i} mes-facturacion-${e} custom-select select-picker form-control w-100" style="width: 150px;">`;for(let e=1;e<13;e++)s=`${s}\n                    <option value="${e}" ${o==e?"selected":""}>${serviciosCore.Render.Meses[e-1]}</option>\n                `;return r=`${r}${s}</select>`,r},InputPrecioPVP:function(e,a,t,i,o){let s;return s=`\n            <input data-id="${a}" data-idcomunidad="${t}" data-idtiposervicio="${i}" type="number" class="servicio_precio precio-${a} precio-${e} text-right" style="max-width:70px;" data-precio="precio" data-servicio="instalaciones" value="${o}">\n            `,s},InputPrecioComunidad:function(e,a,t,i,o){let s;return s=`\n            <input data-id="${a}" data-idcomunidad="${t}" data-idtiposervicio="${i}" type="number" class="servicio_precio precio-comunidad-${a} precio-comunidad-${e} text-right" style="max-width:70px;" data-precio="comunidad" data-servicio="rgpd" value="${o}">            \n            `,s}}};$((()=>{serviciosCore.init()}));