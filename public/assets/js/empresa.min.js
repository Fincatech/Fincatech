let empresaCore={Empresa:Object(),empresa:Object(),init:async function(){this.events(),$("#listadoEmpresa").length&&empresaCore.renderTabla(),empresaCore.renderTablaEmpleados(core.modelId),$(".titulo-modulo").length&&"Empresa"==core.model&&CoreUI.setTitulo("razonsocial")},events:function(){$("body").on(core.helper.clickEventType,".btnDescargarEmailCertificado",(a=>{a.stopImmediatePropagation()})),$("body").on(core.helper.clickEventType,".btnEliminarEmpresa",(a=>{a.stopImmediatePropagation(),empresaCore.eliminar($(a.currentTarget).attr("data-id"),$(a.currentTarget).attr("data-nombre"))})),$("body").on(core.helper.clickEventType,".bntCrearNuevaEmpresaCAE",(function(a){empresaCore.mostrarModalNuevaEmpresaCAE($("body #searchEmpresa").val())})),$("body").on(core.helper.clickEventType,"#listadoEmpresaComunidad tr",(function(a){a.stopImmediatePropagation(),$(".wrapperEmpresasComunidad").hide(),$(".wrapperDocumentacionEmpleado").hide();var e=window.tablelistadoEmpresaComunidad.row($(this).attr("id")).data().idusuario,t=window.tablelistadoEmpresaComunidad.row($(this).attr("id")).data().razonsocial;$(".tituloEmpresasComunidad").text(t),$(".empresaDeclaracion").text(t),empresaCore.renderTablaRequerimientosEmpresa(e).then((()=>{$(".wrapperDocumentacionBasica").hide(),$(".wrapperEmpleadosEmpresaComunidad").show(),empleadoCore.renderTablaEmpleadosEmpresaComunidad(e,core.modelId).then((()=>{empresaCore.renderTablaInfoDescargas(e,core.modelId)}))})),empresaCore.comprobarAceptacionOperatoria(e,core.modelId)})),$("body").on(core.helper.clickEventType,".btnCerrarEmpleadosComunidad",(function(a){$(".wrapperEmpleadosEmpresaComunidad").hide(),$(".wrapperEmpresasComunidad").show(),$(".wrapperDocumentacionBasica").show(),$(".tituloEmpresasComunidad").text("Empresas externas")})),$("body").on(core.helper.clickEventType,".enlaceCae",(function(a){documentalCore.Comunidad.renderTablaDocumentacionComunidadCAE(core.modelId).then((()=>{empresaCore.renderTablaEmpresasComunidad(core.modelId)})),$(".tituloEmpresasComunidad").text("Empresas externas"),empresaCore.comprobarAceptacionOperatoria(core.Security.user,core.modelId)})),$("body").on(core.helper.clickEventType,".btnRedirect",(function(a){a.stopImmediatePropagation(),CoreUI.Utils.redirectTo($(this).attr("data-url"))})),$("body").on(core.helper.clickEventType,".btnBuscarEmpresaCAE",(async function(a){if($(".wrapperBusquedaEmpresa .mensaje").hide(),$(".wrapperInfoEmpresa").hide(),!core.helper.validarEmail($("#searchEmpresa").val()))return $(".wrapperBusquedaEmpresa .mensaje").addClass("text-danger"),$(".wrapperBusquedaEmpresa .mensaje").text("El e-mail proporcionado no es válido"),void $(".wrapperBusquedaEmpresa .mensaje").show();await empresaCore.buscarEmailEmpresa($("#searchEmpresa").val()).then((a=>{if(!1===a)$(".wrapperBusquedaEmpresa .mensaje").hasClass("text-danger")||$(".wrapperBusquedaEmpresa .mensaje").addClass("text-danger"),$(".wrapperBusquedaEmpresa .mensaje").text("No existe ninguna empresa asociada al e-mail proporcionado"),$(".wrapperBusquedaEmpresa .mensaje").show(),$(".bntCrearNuevaEmpresaCAE").show();else{$(".bntCrearNuevaEmpresaCAE").hide();let e=a;$(".wrapperInfoEmpresa .nombreEmpresa").text(e.razonsocial),$(".wrapperInfoEmpresa .cifEmpresa").text(e.cif),$(".wrapperInfoEmpresa .emailEmpresa").text(e.email),$(".wrapperInfoEmpresa .btnConfirmarEmpresaCAE").attr("data-id",e.id),$(".wrapperInfoEmpresa .btnConfirmarEmpresaCAE").attr("data-nombre",e.razonsocial),$(".wrapperInfoEmpresa").show()}}))}))},buscarEmailEmpresa:async function(a){let e,t=Object();return t={fields:Array()},t.fields.push({field:"email",search:a,type:"string",searchtype:"eq"}),await apiFincatech.post("empresa/search",t).then((a=>{var t=JSON.parse(a);e=t})),e.data.Empresa.length>=1&&e.data.Empresa[0]},comprobarAceptacionOperatoria:function(a,e){$(".tablaOperatoriaCondiciones").length<1||apiFincatech.get(`empresa/${a}/comunidad/${e}/operatoria`).then((a=>{var e=JSON.parse(a);if($(".fechaSubida").html(""),$(".tablaOperatoriaCondiciones .estado").html(""),e.data)if(e=e.data,$(".btnAdjuntarOperatoria").attr("data-idrelacionrequerimiento",e.id),$(".tablaOperatoriaCondiciones .estado").html(CoreUI.Utils.renderLabelByEstado(e.estado)),"Verificado"==e.estado){var t=moment(e.created).locale("es").format("L"),o=`\n                        <p class="mb-0 text-center"><a href="${baseURL}public/storage/${e.nombrestorage}" class="text-success" download="${e.nombre}"><i class="bi bi-file-earmark-arrow-down" style="font-size: 24px;"></i></a> </p>Subido el ${t}`;$(".fechaSubida").html(o)}else{o='<span class="badge rounded-pill bg-danger pl-3 pr-3 pt-2 pb-2 d-block" style="font-size: 12px; font-weight: 300;">Pendiente de adjuntar</span>';$(".fechaSubida").html(o)}else;}))},mostrarModalNuevaEmpresaCAE:async function(a=null){apiFincatech.getView("empresa","form").then((e=>{Swal.fire({text:"",html:e,grow:"false",width:"120rem",showCancelButton:!0,showConfirmButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:'<i class="bi bi-save mr-2"></i> Guardar',cancelButtonText:'<i class="bi bi-x-circle mr-2"></i> Cancelar',reverseButtons:!0,buttonsStyling:!1,customClass:{actions:"text-center p-3 shadow-inset rounded-pill border-light border-2 bg-white",confirmButton:"btn btnSaveData btn-success shadow d-block pb-2 pt-2 confirmButtonModal",cancelButton:" btn btn-danger btnCancelSave shadow d-block pb-2 pt-2 mr-3 cancelButtonModal",popup:"bg-transparent"},didOpen:function(e){$(".formEmpresaComunidad #email").val(a),core.Forms.getSelectData("Empresatipo","Empresatipo.nombre","Empresatipo.id","","","tipoEmpresaComunidad",!0).then((()=>{$("body .formEmpresaComunidad #tipoEmpresaComunidad").select2({dropdownParent:$(".swal2-container"),theme:"bootstrap4"}),$("body .formEmpresaComunidad #tipoEmpresaComunidad").val("1"),$("body .formEmpresaComunidad #tipoEmpresaComunidad").trigger("change")})),core.Forms.getSelectData("Provincia","Provincia.Nombre","Provincia.Id","","","provinciaEmpresaComunidad",!0).then((()=>{$("body .formEmpresaComunidad #provinciaEmpresaComunidad").select2({dropdownParent:$(".swal2-container"),theme:"bootstrap4"})})),$(".swal2-container .btnSaveData").removeClass("btnSaveData")},preConfirm:function(a){return!!core.Forms.Validate("formEmpresaComunidad")||(Swal.showValidationMessage("Debe completar todos los campos marcados como obligatorios"),!1)}}).then((a=>{a.isConfirmed&&(core.Forms.mapFormDataToSave("formEmpresaComunidad"),core.Forms.data.fromcae="1",core.Forms.data.comunidad=core.Modelo.entity.Comunidad[0].nombre,core.Modelo.Insert("empresa",core.Forms.data,!1,"El registro se ha creado correctamente. Hemos remitido un e-mail al proveedor para que acceda y aporte los documentos requeridos.").then((a=>{apiFincatech.post(`comunidad/${core.modelId}/empresa/${core.Modelo.insertedId}/asignar`,null).then((async a=>{var e=JSON.parse(a);"ok"==e.status.response?window.tablelistadoEmpresaComunidad.ajax.reload():Modal.Error("No se ha podido asignar por el siguiente motivo:<br><br>"+e.status.response)})),window.tablelistadoEmpresaComunidad.ajax.reload(),$(".loading").hide()})))}))}))},eliminar:function(a,e){core.Modelo.Delete("empresa",a,e,"listadoEmpresa"),Swal.fire({title:`¿Desea eliminar la empresa:<br>${e}?`,text:"Se va a eliminar la empresa y toda la información asociada",icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then((e=>{e.isConfirmed&&apiFincatech.delete("empresa",a).then((a=>{Swal.fire("Empresas eliminada correctamente","","success"),$("#listadoEmpresa").DataTable().ajax.reload()}))}))},renderTabla:async function(){if($("#listadoEmpresa").length){CoreUI.tableData.init(),CoreUI.tableData.addColumnRow("listadoEmpresa","comunidades"),CoreUI.tableData.addColumn("listadoEmpresa","razonsocial","Nombre",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresa","cif","CIF",null,"text-justify"),CoreUI.tableData.addColumn("listadoEmpresa","email","EMAIL",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresa","telefono","TELEFONO",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresa","personacontacto","Persona de contacto",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresa","localidad","Localidad",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresa","empresatipo[0].nombre","Tipo",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresa",(function(a,e,t,o){var r,n;return a.lastlogin?(r=moment(a.lastlogin,"YYYY-MM-DD hh:mm").unix(),n=moment(a.lastlogin).locale("es").format("L")):(btnReenvio="","-1"!=a.idmensajeregistro&&void 0!==a.idmensajeregistro&&(btnReenvio=`<a href="javascript:void(0);" class="btnReenviarMensaje d-inline-block btn btn-primary ml-2 pt-0 pb-0" title="Reenviar mensaje de registro" data-id="${a.idmensajeregistro}"><i data-feather="send" style="width:12px;height:12px;"></i></a>`),r="",n=`<span class="badge badge-pill bg-danger text-white pt-2 pl-3 pr-3 pb-2">Nunca</span>${btnReenvio}`),`<span style="display:none;">${r}</span>${n}`}),"Último acceso",null,"text-left");var a='<ul class="nav justify-content-center accionesTabla">';a+=`<li class="nav-item"><a href="${baseURL}empresa/data:id$" class="btnEditarEmpresa d-inline-block" data-id="data:id$" data-nombre="data:razonsocial$"><i data-feather="edit" class="text-success img-fluid"></i></a></li>`,a+='<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarEmpresa d-inline-block" data-id="data:id$" data-nombre="data:razonsocial$"><i data-feather="trash-2" class="text-danger img-fluid"></i></li></ul>',CoreUI.tableData.addColumn("listadoEmpresa",null,"",a),$("#listadoEmpresa").addClass("no-clicable"),CoreUI.tableData.render("listadoEmpresa","Empresa","empresa/list")}},renderTablaSimple:async function(){if($("#listadoSimpleEmpresas").length){void 0!==window.tablelistadoSimpleEmpresas&&(CoreUI.tableData.columns.listadoSimpleEmpresas=[]),CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoSimpleEmpresas","razonsocial","Nombre",null,"text-left"),CoreUI.tableData.addColumn("listadoSimpleEmpresas","cif","CIF",null,"text-justify"),CoreUI.tableData.addColumn("listadoSimpleEmpresas","email","EMAIL",null,"text-left"),CoreUI.tableData.addColumn("listadoSimpleEmpresas","empresatipo[0].nombre","Tipo",null,"text-left");'<li class="nav-item">\n                                <a href="javascript:void(0);" class="btnConfirmarEmpresaCAE d-inline-block btn btn-sm btn-success" data-id="data:id$" data-nombre="data:razonsocial$">ASIGNAR</a>\n                            </li>\n                            </ul>',CoreUI.tableData.addColumn("listadoSimpleEmpresas",null,"",'<ul class="nav justify-content-center accionesTabla"><li class="nav-item">\n                                <a href="javascript:void(0);" class="btnConfirmarEmpresaCAE d-inline-block btn btn-sm btn-success" data-id="data:id$" data-nombre="data:razonsocial$">ASIGNAR</a>\n                            </li>\n                            </ul>'),$("#listadoSimpleEmpresas").addClass("no-clicable"),CoreUI.tableData.render("listadoSimpleEmpresas","Empresa","empresa/list")}},renderTablaEmpleados:async function(a,e="listadoEmpleadosEmpresa"){if($(`#${e}`).length){CoreUI.tableData.init(),CoreUI.tableData.addColumn(e,"nombre","Nombre",null,"text-left"),CoreUI.tableData.addColumn(e,"numerodocumento","DNI/NIE",null,"text-left"),CoreUI.tableData.addColumn(e,"razonsocial","Empresa",null,"text-left"),CoreUI.tableData.addColumn(e,"puesto","Puesto",null,"text-left"),CoreUI.tableData.addColumn(e,"email","EMAIL",null,"text-left"),CoreUI.tableData.addColumn(e,"telefono","TELEFONO",null,"text-left"),CoreUI.tableData.addColumn(e,"fechaalta","Fecha alta",null,"text-left"),CoreUI.tableData.addColumn(e,"fechabaja","Fecha baja",null,"text-left");CoreUI.tableData.addColumn(e,null,"Estado","data:estado$"),CoreUI.tableData.render(e,"Empleados",`empresa/${a}/empleados`,!1,!1,!1)}},renderTablaEmpleadosContratista:async function(a,e="listadoEmpleadosEmpresa"){var t=`#${e}`;if($(t).length){CoreUI.tableData.init(),CoreUI.tableData.addColumn(e,(function(a,e,t,o){return`${a.nombre}`}),"Nombre del empleado",null,"text-left","30%"),CoreUI.tableData.addColumn(e,"numerodocumento","DNI/NIE",null,"text-left"),CoreUI.tableData.addColumn(e,"puesto","Puesto",null,"text-left"),CoreUI.tableData.addColumn(e,"email","EMAIL",null,"text-left"),CoreUI.tableData.addColumn(e,"telefono","TELEFONO",null,"text-left"),CoreUI.tableData.addColumn(e,"fechaalta","Fecha alta",null,"text-left"),CoreUI.tableData.addColumn(e,"fechabaja","Fecha baja",null,"text-left");CoreUI.tableData.addColumn(e,null,"Estado","data:estado$"),CoreUI.tableData.addColumn(e,(function(a,e,t,o){return`<a href="javascript:void(0);" class="btnRedirect" data-url="/contratista/empleado?id=${a.idempleado}"><i class="bi bi-pencil-square text-success pt-2" style="font-size: 17px;"></i></a>&nbsp;<a href="javascript:void(0);" class="btnEliminarEmpleado d-inline-block" data-id="${a.idempleado}" data-nombre="${a.nombre}"><i class="bi bi-trash text-danger" style="font-size: 17px;"></i></a>`}),"&nbsp;",null,"text-center","20px"),$(t).addClass("no-clicable"),CoreUI.tableData.render(e,"Empleados",`empresa/${a}/empleados`,!1,!1,!1)}},renderTablaEmpresasComunidad:async function(a){""!=a&&void 0!==a&&null!=a&&$("#listadoEmpresaComunidad").length&&(CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoEmpresaComunidad","razonsocial","Nombre",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresaComunidad","cif","CIF",null,"text-justify"),CoreUI.tableData.addColumn("listadoEmpresaComunidad","email","EMAIL",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresaComunidad","telefono","TELEFONO",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresaComunidad","personacontacto","Persona de contacto",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresaComunidad","localidad","Localidad",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresaComunidad","tipoempresa","Tipo",null,"text-left"),CoreUI.tableData.addColumn("listadoEmpresaComunidad",(function(a,e,t,o){var r="";""!==a.emailcertificado&&"null"!==a.emailcertificado&&null!==a.emailcertificado&&(r=`<a class="btnDescargarEmailCertificado" href="${baseURL}public/storage/emailcertificados/${a.emailcertificado}" target="_blank" title="Email certificado"><i data-feather="mail" class="text-success img-fluid"></i></a> `);var n='<ul class="nav justify-content-center accionesTabla">';return""!=r&&(n=`${n}\n                            <li class="nav-item">\n                                ${r}\n                            </li>`),n=`${n}<li class="nav-item">\n                                    <a href="javascript:void(0);" class="btnEliminarEmpresaComunidad d-inline-block" data-id="${a.id}" data-nombre="${a.razonsocial}">\n                                        <i data-feather="trash-2" class="text-danger img-fluid"></i>\n                                    </a>\n\n                                </li>\n                            </ul>`}),"&nbsp;",null,"text-center"),$("#listadoEmpresaComunidad").addClass("no-clicable"),CoreUI.tableData.render("listadoEmpresaComunidad","empresascomunidad",`comunidad/${a}/empresas`,null,!1,!1))},renderTablaRequerimientosEmpresa:async function(a){$("#listadoDocumentacionEmpresa").length&&(CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoDocumentacionEmpresa","requerimiento","Requerimiento",null,"text-left"),CoreUI.tableData.addColumn("listadoDocumentacionEmpresa",(function(a,e,t,o){return""!=a.fechasubida&&"null"!=a.fechasubida&&a.fechasubida?'<p class="mb-0 text-center">'+moment(a.fechasubida).locale("es").format("L")+"</p>":"No se ha realizado ninguna actuación"}),"Fecha última actuación",null,"text-center"),CoreUI.tableData.addColumn("listadoDocumentacionEmpresa",(function(a,e,t,o){var r,n=a.idestado;switch(n=n?parseInt(n):1){case 1:r="no adjuntado";break;case 2:r="no descargado";break;case 3:r="no verificado";break;case 4:r="verificado";break;case 5:r="descargado";break;case 6:r="verificado";break;case 7:r="rechazado";break}return CoreUI.Utils.renderLabelByEstado(r)}),"Estado",null,"text-center"),CoreUI.tableData.addColumn("listadoDocumentacionEmpresa",(function(e,t,o,r){var n=!1,l="";("CONTRATISTA"==core.Security.getRole()&&(n=!0),ficheroAdjuntado=!!e.idficherorequerimiento,ficheroAdjuntado)&&(l+=` <td class="text-center">\n                                        <a href="${config.baseURL+"public/storage/"+e.storageficherorequerimiento}" target="_blank" title="Ver documento">\n                                            <i class="bi bi-cloud-arrow-down text-primary mr-1" style="font-size: 30px;"></i>\n                                        </a>\n                                    </td>`);var i=null==e.idempresa?a:e.idempresa;return n&&(dataset=` data-idcomunidad="${e.idcomunidad}" data-idempresa="${i}" data-idempleado="" data-idrequerimiento="${e.idrequerimiento}" data-idrelacionrequerimiento="${e.idrelacion}" data-entidad="empresa" `,l+=`<td class="text-center" ><a href="javascript:void(0)" class="btnAdjuntarFicheroDocumento" data-toggle="tooltip" ${dataset} data-placement="bottom" title="" id="home" data-original-title="Adjuntar documento"><i class="bi bi-cloud-arrow-up text-success" style="font-size: 30px;"></i></a></td>`),ficheroAdjuntado||n||(l+="<td>&nbsp;</td>"),l}),"&nbsp;",null,"text-center"),$("#listadoDocumentacionEmpresa").addClass("no-clicable"),void 0!==window.tablelistadoDocumentacionEmpresa&&window.tablelistadoDocumentacionEmpresa.destroy(),CoreUI.tableData.render("listadoDocumentacionEmpresa","documentacioncae",`empresa/${a}/documentacion`,null,!1,!1))},renderTablaInfoDescargas:async function(a,e){$("#listadoDocumentacionDescargaEmpresa").length&&(CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoDocumentacionDescargaEmpresa","nombre","Requerimiento",null,"text-left"),CoreUI.tableData.addColumn("listadoDocumentacionDescargaEmpresa",(function(a,e,t,o){return""!=a.fechadescarga&&"null"!=a.fechadescarga&&a.fechadescarga?'<p class="mb-0 text-center">'+moment(a.fechadescarga).locale("es").format("LLLL")+"</p>":"N/D"}),"Fecha descarga",null,"text-center"),CoreUI.tableData.addColumn("listadoDocumentacionDescargaEmpresa",(function(a,e,t,o){return""!=a.fechadescarga&&"null"!=a.fechadescarga&&a.fechadescarga?'<span class="badge rounded-pill bg-success pl-3 pr-3 pt-2 pb-2 d-block">Descargado</span>':'<span class="badge rounded-pill bg-danger pl-3 pr-3 pt-2 pb-2 d-block">No descargado</span>'}),"Estado",null,"text-center"),CoreUI.tableData.render("listadoDocumentacionDescargaEmpresa","infodescargas",`requerimiento/comunidad/${e}/empresa/${a}/infodescarga`,null,!1,!1))}};$((()=>{empresaCore.init()}));