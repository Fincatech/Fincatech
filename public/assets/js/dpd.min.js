let dpdCore={dpds:Object(),dpd:Object(),consultaId:null,consultaTexto:null,consultaRespuesta:null,init:async function(){this.events(),$("#listadoDpd").length&&dpdCore.renderTabla()},events:async function(){$("#listadoDpd").length&&dpdCore.renderTabla(),$("body").on(core.helper.clickEventType,".btnResponderConsulta",(function(){apiFincatech.get("dpd/"+$(this).attr("data-id")).then((a=>{var t=JSON.parse(a);dpdCore.consultaId=$(this).attr("data-id"),dpdCore.consultaTexto=t.data.Dpd[0].consulta,dpdCore.consultaRespuesta=t.data.Dpd[0].respuesta,dpdCore.verModalContestarConsulta(dpdCore.consultaId,dpdCore.consultaTexto,dpdCore.consultaRespuesta)}))})),$("body").on(core.helper.clickEventType,".btnEnviarRespuestaDPD",(function(){dpdCore.responderConsulta($(this).attr("data-id"))})),$("body").on(core.helper.clickEventType,".btnEnviarConsultaDPD",(function(){dpdCore.crearConsulta()})),$("body").on(core.helper.clickEventType,".btnCrearConsultaDPD",(function(a){dpdCore.verModalCrearConsulta()})),$("body").on(core.helper.clickEventType,".btnCancelarConsultaDPD",(function(a){Swal.close()})),$("body").on(core.helper.clickEventType,".dpd-exportar",(function(a){dpdCore.Controller.ExportarAdministradoresDPD()})),$(".stats-dpd").length&&dpdCore.Controller.LoadStatsDashboard()},Controller:{ExportarAdministradoresDPD:function(){Swal.fire({title:"Exportaci贸n de administradores",html:"<p>Clique el bot贸n <strong>descargar</strong> para generar y descargar un fichero Excel con la informaci贸n de todos los administradores que tienen contratado el servicio DPD para al menos 1 comunidad.</p>",grow:"false",width:"60rem",showCancelButton:!0,showConfirmButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:'<i class="bi bi-save mr-2"></i> Descargar',cancelButtonText:'<i class="bi bi-x-circle mr-2"></i> Cancelar',reverseButtons:!0,buttonsStyling:!1,customClass:{actions:"text-center p-3 shadow-inset rounded-pill border-light border-2 bg-white",confirmButton:"btn btn-success rounded-pill shadow d-block pb-2 pt-2 cofirmButtonModal",cancelButton:" btn btn-danger btnCancelSave rounded-pill shadow d-block pb-2 pt-2 mr-3 cacelButtonModal",popup:"bdg-transparent"}}).then((a=>{a.isConfirmed&&apiFincatech.get("administrador/exportar/dpd").then((a=>{let t=JSON.parse(a);if("Error"==t.data)CoreUI.Modal.Error(t.status.error,"Exportaci贸n de administradores");else{let a=atob(t.data),e=new Uint8Array(a.length);for(let t=0;t<a.length;t++)e[t]=a.charCodeAt(t);let o=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=document.createElement("a");n.href=window.URL.createObjectURL(o),n.download=`exportacion_administradores_dpd_contratado_${moment().format("YYYY_MM_DD")}.xlsx`,n.click(),n.remove()}}))}))},LoadStatsDashboard:function(){new Promise((async(a,t)=>{await apiFincatech.get("stats/dpd").then((t=>{let e=JSON.parse(t);"ok"==e.status.response&&(dpdCore.Model.Stats.administradores=e.data.administradores,dpdCore.Model.Stats.consultasdpd=e.data.consultasdpd,dpdCore.Model.Stats.informevaloracion=e.data.informevaloracion,dpdCore.Model.Stats.notasinformativas=e.data.notasinformativas),a(!0)}))})).then((a=>{dpdCore.Controller.View.RenderStatsDashboard()}))},View:{RenderStatsDashboard:function(){$(".stats-dpd .stat-administradores").html(dpdCore.Model.Stats.administradores),$(".stats-dpd .stat-consultasdpd").html(dpdCore.Model.Stats.consultasdpd),$(".stats-dpd .stat-informevaloracion").html(dpdCore.Model.Stats.informevaloracion),$(".stats-dpd .stat-notasinformativas").html(dpdCore.Model.Stats.notasinformativas)}}},Model:{Stats:{administradores:0,consultasdpd:0,informevaloracion:0,notasinformativas:0}},verModalCrearConsulta:function(){CoreUI.Modal.CustomHTML('\n            <div class="row">\n                <div class="col-12 text-left">\n                    <p><i data-feather="message-square"></i> NUEVA CONSULTA AL DPD</p>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-12">\n                    <textarea id="textoconsulta" rows="10" name="textoconsulta" class="textoconsulta form-control shadow-inset border-0 rounded mb-3"></textarea>\n                </div>\n            </div>            \n            <div class="row">\n                <div class="col-6 pr-1">\n                    <a href="javascript:void(0);" class="btn btn-danger d-block shadow d-block pb-2 pt-2 btnCancelarConsultaDPD"><i class="bi bi-x-circle"></i> Cancelar</a>\n                </div>\n                <div class="col-6 pl-1">\n                    <a href="javascript:void(0);" class="btn btn-success d-block shadow d-block pb-2 pt-2 btnEnviarConsultaDPD"><i class="bi bi-check-square"></i> Enviar consulta</a>\n                </div>\n            </div>\n        ',"",(function(){dpdCore.renderTabla()}))},verModalContestarConsulta:function(a,t,e){""!=e&&null!==e||(e="");var o=`\n            <div class="row">\n                <div class="col-12 text-center shadow-neumorphic mb-3 rounded-lg p-2">\n                    <p class="display-6 m-0"><i data-feather="message-square"></i> CONSULTA DPD</p>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-12 text-left">\n                    <label for="textoconsulta" class="mb-2 text-uppercase">Consulta</label>\n                    <div class="alert alert-warning rounded shadow-neumorphic" style="border-radius: 10px !important;" role="alert">                         \n                        <div class="alert-message text-justify" style="font-size: 14px;">${t}</div>\n                    </div>                \n                </div>\n            </div>            \n            <div class="row">\n                <div class="col-12 text-left">\n                    <label for="textoconsulta" class="mb-2 text-uppercase">Respuesta</label>\n                    <textarea id="textoconsulta" rows="10" name="textoconsulta" class="textoconsulta form-control shadow-inset border-0 rounded mb-3">${e}</textarea>\n                </div>\n            </div>    \n            <div class="row">\n                <div class="col-12 text-left">\n                    <p class="mb-1 text-left text-uppercase font-weight-normal pr-3 pt-2" style="font-size:14px;">Adjuntar fichero</p>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-12">\n                    <div class="wrapperFichero row border rounded-lg ml-0 mr-0 mb-3 shadow-inset border-1 pt-3 pb-2">\n                        <div class="col-1 align-self-center h-100 text-center">\n                            <i class="bi bi-cloud-arrow-up text-info" style="font-size: 30px;"></i>\n                        </div>\n                        <div class="col-11 pl-0">\n                            <input accept=".pdf" class="form-control form-control-sm ficheroadjuntar border-0" hs-fichero-entity="Dpd" id="ficheroadjuntar" type="file">\n                        </div>       \n                    </div>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-6 pr-1">\n                    <a href="javascript:void(0);" class="btn btn-danger d-block shadow d-block pb-2 pt-2 btnCancelarConsultaDPD"><i class="bi bi-x-circle"></i> Cancelar</a>\n                </div>\n                <div class="col-6 pl-1">\n                    <a href="javascript:void(0);" class="btn btn-success d-block shadow d-block pb-2 pt-2 btnEnviarRespuestaDPD" data-id="${a}"><i class="bi bi-check-square"></i> Enviar respuesta</a>\n                </div>\n            </div>\n        `;CoreUI.Modal.CustomHTML(o,"",null,"50%").then((()=>{})),core.Files.init(),core.Files.Fichero.entidadId=a},crearConsulta:async function(){if(""==$("body .textoconsulta").val())CoreUI.Modal.Error("Escribe la consulta para poder enviarla","Error",(function(){dpdCore.verModalCrearConsulta()}));else{var a=Object();a={idcomunidad:$("body").attr("hs-model-id"),consulta:$("body .textoconsulta").val()},await apiFincatech.post("dpd/create",a).then((async a=>{var t=JSON.parse(a);"ok"==t.status.response?(CoreUI.Modal.Success("La consulta ha sido registrada correctamente"),dpdCore.renderTabla()):Modal.Error("No se ha podido enviar la consulta por el siguiente motivo:<br><br>"+t.status.response)}))}},responderConsulta:async function(a){if(""==$("body .textoconsulta").val())CoreUI.Modal.Error("Escribe la respuesta para poder contestar la consulta","Error",(function(){dpdCore.verModalContestarConsulta(dpdCore.consultaId,dpdCore.consultaTexto,dpdCore.consultaRespuesta)}));else{var t=Object();t={id:a,respuesta:$("body .textoconsulta").val(),fecharesolucion:moment().format("Y-MM-DD HH:mm"),solucionado:"1"},await apiFincatech.put(`dpd/${a}`,t).then((async a=>{var t=JSON.parse(a);"ok"==t.status.response?CoreUI.Modal.Success("La respuesta ha sido registrada correctamente",null,(function(){window.tablelistadoDpd.ajax.reload()})):Modal.Error("No se ha podido enviar la consulta por el siguiente motivo:<br><br>"+t.status.response)}))}},renderTabla:function(){if($("#listadoDpd").length){CoreUI.tableData.init(),CoreUI.tableData.columns=[],"DPD"==core.Security.getRole()&&(CoreUI.tableData.addColumn("listadoDpd",(function(a,t,e,o){return`<p class="mb-0">${a.usuario[0].nombre}</p>`}),"Administrador",null,"text-left"),CoreUI.tableData.addColumn("listadoDpd",(function(a,t,e,o){return`<p class="mb-0 text-left"><small>${a.usuario[0].email}</small></p>`}),"E-mail",null,"text-center")),CoreUI.tableData.addColumn("listadoDpd","consulta","Consulta"),CoreUI.tableData.addColumn("listadoDpd","respuesta","Respuesta");var a="data:created$";CoreUI.tableData.addColumn("listadoDpd",null,"Fecha",a,"text-center","80px"),CoreUI.tableData.addColumn("listadoDpd",(function(a,t,e,o){var n="";return null!=a.idfichero&&(!0,n+=`<a href="${config.baseURL}public/storage/${a.ficheroscomunes[0].nombrestorage}" target="_blank" download="${a.ficheroscomunes[0].nombre}" ><i class="bi bi-file-earmark-arrow-down" style="font-size:24px;"></i></a>`),n}),"Fichero",null,"text-center");a="data:solucionado$";if(CoreUI.tableData.addColumn("listadoDpd",null,"Estado",a,"text-center"),"DPD"==$("body").attr("hs-role")){a='<ul class="nav justify-content-center accionesTabla">';a+='<li class="nav-item"><a href="javascript:void(0);" class="btnResponderConsulta d-inline-block" data-id="data:id$"><i data-feather="send" class="text-info img-fluid"  style="height:26px; width: 26px;"></i></a></li>',CoreUI.tableData.addColumn("listadoDpd",null,"",a,"text-center")}$("#listadoDpd").addClass("no-clicable"),CoreUI.tableData.render("listadoDpd","Dpd","dpd/list")}return!0}};$((()=>{dpdCore.init()}));