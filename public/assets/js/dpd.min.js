let dpdCore={dpds:Object(),dpd:Object(),consultaId:null,consultaTexto:null,consultaRespuesta:null,init:async function(){this.events(),$("#listadoDpd").length&&"Dpd"==core.model&&dpdCore.renderTabla()},events:async function(){$("#listadoDpd").length,$("body").on(core.helper.clickEventType,".btnResponderConsulta",(function(){apiFincatech.get("dpd/"+$(this).attr("data-id")).then(response=>{var respuesta=JSON.parse(response);dpdCore.consultaId=$(this).attr("data-id"),dpdCore.consultaTexto=respuesta.data.Dpd[0].consulta,dpdCore.consultaRespuesta=respuesta.data.Dpd[0].respuesta,dpdCore.verModalContestarConsulta(dpdCore.consultaId,dpdCore.consultaTexto,dpdCore.consultaRespuesta)})})),$("body").on(core.helper.clickEventType,".btnEnviarRespuestaDPD",(function(){dpdCore.responderConsulta($(this).attr("data-id"))})),$("body").on(core.helper.clickEventType,".btnEnviarConsultaDPD",(function(){dpdCore.crearConsulta()})),$("body").on(core.helper.clickEventType,".btnCrearConsultaDPD",(function(e){dpdCore.verModalCrearConsulta()})),$("body").on(core.helper.clickEventType,".btnCancelarConsultaDPD",(function(e){Swal.close()}))},verModalCrearConsulta:function(){var html='\n            <div class="row">\n                <div class="col-12 text-left">\n                    <p><i data-feather="message-square"></i> NUEVA CONSULTA AL DPD</p>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-12">\n                    <textarea id="textoconsulta" rows="10" name="textoconsulta" class="textoconsulta form-control shadow-inset border-0 rounded mb-3"></textarea>\n                </div>\n            </div>            \n            <div class="row">\n                <div class="col-6 pr-1">\n                    <a href="javascript:void(0);" class="btn btn-danger d-block shadow d-block pb-2 pt-2 btnCancelarConsultaDPD"><i class="bi bi-x-circle"></i> Cancelar</a>\n                </div>\n                <div class="col-6 pl-1">\n                    <a href="javascript:void(0);" class="btn btn-success d-block shadow d-block pb-2 pt-2 btnEnviarConsultaDPD"><i class="bi bi-check-square"></i> Enviar consulta</a>\n                </div>\n            </div>\n        ';CoreUI.Modal.CustomHTML(html,"",(function(){dpdCore.renderTabla()}))},verModalContestarConsulta:function(id,textoConsulta,textoRespuesta){""!=textoRespuesta&&null!==textoRespuesta||(textoRespuesta="");var html=`\n            <div class="row">\n                <div class="col-12 text-center shadow-neumorphic mb-3 rounded-lg p-2">\n                    <p class="display-6 m-0"><i data-feather="message-square"></i> CONSULTA DPD</p>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-12 text-left">\n                    <label for="textoconsulta" class="mb-2 text-uppercase">Consulta</label>\n                    <div class="alert alert-warning rounded shadow-neumorphic" style="border-radius: 10px !important;" role="alert">                         \n                        <div class="alert-message text-justify" style="font-size: 14px;">${textoConsulta}</div>\n                    </div>                \n                </div>\n            </div>            \n            <div class="row">\n                <div class="col-12 text-left">\n                    <label for="textoconsulta" class="mb-2 text-uppercase">Respuesta</label>\n                    <textarea id="textoconsulta" rows="10" name="textoconsulta" class="textoconsulta form-control shadow-inset border-0 rounded mb-3">${textoRespuesta}</textarea>\n                </div>\n            </div>    \n            <div class="row">\n                <div class="col-12 text-left">\n                    <p class="mb-1 text-left text-uppercase font-weight-normal pr-3 pt-2" style="font-size:14px;">Adjuntar fichero</p>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-12">\n                    <div class="wrapperFichero row border rounded-lg ml-0 mr-0 mb-3 shadow-inset border-1 pt-3 pb-2">\n                        <div class="col-1 align-self-center h-100 text-center">\n                            <i class="bi bi-cloud-arrow-up text-info" style="font-size: 30px;"></i>\n                        </div>\n                        <div class="col-11 pl-0">\n                            <input accept=".pdf" class="form-control form-control-sm ficheroadjuntar border-0" hs-fichero-entity="Dpd" id="ficheroadjuntar" type="file">\n                        </div>       \n                    </div>\n                </div>\n            </div>\n            <div class="row">\n                <div class="col-6 pr-1">\n                    <a href="javascript:void(0);" class="btn btn-danger d-block shadow d-block pb-2 pt-2 btnCancelarConsultaDPD"><i class="bi bi-x-circle"></i> Cancelar</a>\n                </div>\n                <div class="col-6 pl-1">\n                    <a href="javascript:void(0);" class="btn btn-success d-block shadow d-block pb-2 pt-2 btnEnviarRespuestaDPD" data-id="${id}"><i class="bi bi-check-square"></i> Enviar respuesta</a>\n                </div>\n            </div>\n        `;CoreUI.Modal.CustomHTML(html,"",null,"50%").then(()=>{}),core.Files.init(),core.Files.Fichero.entidadId=id},crearConsulta:async function(){if(""==$("body .textoconsulta").val())CoreUI.Modal.Error("Escribe la consulta para poder enviarla","Error",(function(){dpdCore.verModalCrearConsulta()}));else{var postData=Object();postData={idcomunidad:$("body").attr("hs-model-id"),consulta:$("body .textoconsulta").val()},await apiFincatech.post("dpd/create",postData).then(async response=>{var responseData=JSON.parse(response);"ok"==responseData.status.response?(CoreUI.Modal.Success("La consulta ha sido registrada correctamente"),dpdCore.renderTabla()):Modal.Error("No se ha podido enviar la consulta por el siguiente motivo:<br><br>"+responseData.status.response)})}},responderConsulta:async function(consultaId){if(""==$("body .textoconsulta").val())CoreUI.Modal.Error("Escribe la respuesta para poder contestar la consulta","Error",(function(){dpdCore.verModalContestarConsulta(dpdCore.consultaId,dpdCore.consultaTexto,dpdCore.consultaRespuesta)}));else{var postData=Object();postData={id:consultaId,respuesta:$("body .textoconsulta").val(),fecharesolucion:moment().format("Y-MM-DD HH:mm"),solucionado:"1"},await apiFincatech.put(`dpd/${consultaId}`,postData).then(async response=>{var responseData=JSON.parse(response);"ok"==responseData.status.response?CoreUI.Modal.Success("La respuesta ha sido registrada correctamente",null,(function(){window.tablelistadoDpd.ajax.reload()})):Modal.Error("No se ha podido enviar la consulta por el siguiente motivo:<br><br>"+responseData.status.response)})}},renderTabla:async function(){if($("#listadoDpd").length){CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoDpd","consulta","Consulta"),CoreUI.tableData.addColumn("listadoDpd","respuesta","Respuesta");var html='<a href="'+config.baseURL+'public/storage/data:ficheroscomunes.nombrestorage$" target="_blank"><i class="bi bi-cloud-arrow-down" style="font-size:24px;"></i></a>';CoreUI.tableData.addColumn(null,"Fichero",html,"text-center");var html="data:created$";CoreUI.tableData.addColumn("listadoDpd",null,"Fecha",html,"text-center","80px");var html="data:solucionado$";if(CoreUI.tableData.addColumn("listadoDpd",null,"Estado",html,"text-center"),"DPD"==$("body").attr("hs-role")){var html='<ul class="nav justify-content-center accionesTabla">';html+='<li class="nav-item"><a href="javascript:void(0);" class="btnResponderConsulta d-inline-block" data-id="data:id$"><i data-feather="send" class="text-info img-fluid"  style="height:42px; width: 42px;"></i></a></li>',CoreUI.tableData.addColumn("listadoDpd",null,"",html,"text-center")}$("#listadoDpd").addClass("no-clicable"),CoreUI.tableData.render("listadoDpd","Dpd","dpd/list")}return!0}};$(()=>{dpdCore.init()});