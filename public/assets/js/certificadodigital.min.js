let CertificadoDigital={Init:async function(){$("body #listadoCertificadoDigitalPendiente").length>0&&CertificadoDigital.Render.CertificadosPendientes(),CertificadoDigital.Events()},Events:function(){$("body").on(core.helper.clickEventType,".enlaceCertificadoDigital",(function(e){documentalCore.Comunidad.renderTablaDocumentacionComunidadCertificadoDigital(core.modelId)})),$("body").on(core.helper.clickEventType,".btnSolicitarCertificadoComunidad",(function(e){CertificadoDigital.Solicitud.SeleccionarRepresentanteLegal()})),$("body").on(core.helper.clickEventType,".btnConfirmarRepresentanteLegal",(function(e){let t=$("body #representanteLegal option:selected").val();CertificadoDigital.Solicitud.CertificadoIndividual(core.modelId,t)})),$("body").on(core.helper.clickEventType,".btnProcesarSolicitudesCertificadoDigital",(function(e){CertificadoDigital.Solicitud.CertificadoMultiple()})),$("body").on(core.helper.clickEventType,".btnSelectAllComunity",(function(e){CertificadoDigital.GUI.SelectComunityStatus(!0)})),$("body").on(core.helper.clickEventType,".btnDeselectAll",(function(e){CertificadoDigital.GUI.SelectComunityStatus(!1)})),$("body").on(core.helper.clickEventType,".btnProcesarSolicitudCertificados",(function(e){$(".swal2-container .mensajeError").text(""),CertificadoDigital.Model.RequestMultipleCertificate()}))},GUI:{CargarComunidadesSeleccionadasIntoModal:function(){CertificadoDigital.Model.LoadDataFromSelectedRows(),$("body .comunidadesCertificadoSolicitado").text(CertificadoDigital.Model.comunityNames.join(", "))},SelectComunityStatus:function(e){$(".chkSelectorComunidad").each((function(t){$(this).prop("checked",e)}))}},Helper:{readURL:function(e,t){if(e.files&&e.files[0]){var i=new FileReader;i.onload=function(i){$(`body .${t}`).attr("src",i.target.result);var a=document.getElementById(e.id).value;if(a){var o=a.indexOf("\\")>=0?a.lastIndexOf("\\"):a.lastIndexOf("/"),d=a.substring(o);0!==d.indexOf("\\")&&0!==d.indexOf("/")||(d=d.substring(1))}switch(t){case"imgfileFrontDocument":CertificadoDigital.Model.frontDocumentBase64=i.target.result,CertificadoDigital.Model.frontDocument=d;break;case"imgfileRearDocument":CertificadoDigital.Model.rearDocumentBase64=i.target.result,CertificadoDigital.Model.rearDocument=d;break}},i.readAsDataURL(e.files[0])}}},Model:{frontDocument:null,frontDocumentBase64:null,rearDocument:null,rearDocumentBase64:null,comunityIds:Array(),comunityNames:Array(),solicitudIds:Array(),LoadDataFromSelectedRows:function(){CertificadoDigital.Model.solicitudIds=Array(),CertificadoDigital.Model.comunityIds=Array(),CertificadoDigital.Model.comunityNames=Array(),$(".chkSelectorComunidad").each((function(e){if($(this).is(":checked")){let e=$(this).attr("data-idrow"),t=window.tablelistadoCertificadoDigitalPendiente.row(e).data().nombre;CertificadoDigital.Model.solicitudIds.push($(this).attr("data-idsolicitud")),CertificadoDigital.Model.comunityIds.push($(this).attr("data-idcomunidad")),CertificadoDigital.Model.comunityNames.push(t)}})),CertificadoDigital.Model.comunityNames.sort()},RequestMultipleCertificate:async function(){if(CertificadoDigital.Model.frontDocument&&CertificadoDigital.Model.rearDocument){var e=Object();e={solicitudIds:CertificadoDigital.Model.solicitudIds.join(","),comunityIds:CertificadoDigital.Model.comunityIds.join(","),userId:core.Security.user,documentoFrontalBase64:CertificadoDigital.Model.frontDocumentBase64,documentoFrontalNombre:CertificadoDigital.Model.frontDocument,documentoTraseroBase64:CertificadoDigital.Model.rearDocumentBase64,documentoTraseroNombre:CertificadoDigital.Model.rearDocument},await apiFincatech.post("certificadodigital/comunidad/createrequest",e).then((e=>{if(Swal.close(),"ok"==JSON.parse(e).status.response)CoreUI.Modal.Success("La solicitud se ha realizado correctamente.<br><br>Una vez que el Operador de Registro Autorizado haya validado las solicitudes, recibirá en su e-mail las instrucciones para descargar el certificado digital."),CertificadoDigital.Render.CertificadosPendientes();else{let e="No se ha podido completar la solicitud por los siguientes motivos:<br><br>";e=`<p class="text-left">${e}</p>`,CoreUI.Modal.Error(e,"Solicitud de certificado digital")}}))}else $(".swal2-container .mensajeError").text("Debe adjuntar el documento de identidad escaneado tanto su parte frontal como su parte trasera")}},Solicitud:{CertificadoIndividual:async function(e,t){await apiFincatech.get(`comunidad/${e}/solicitarcertificado/${t}`).then((async e=>{result=JSON.parse(e),"error"==result.data?CoreUI.Modal.Error(result.status.error,"Solicitud certificado digital"):CoreUI.Modal.Success("Se ha solicitado correctamente el certificado digital para la comunidad y está a la espera de ser validado y aprobado por un Operador de Registro Autorizado.<br><br>Recibirá un e-mail con el resultado de la validación.","Solicitar certificado digital")}))},CertificadoMultiple:async function(){CertificadoDigital.Validate.HasSelectedComunity()?apiFincatech.getView("modals","modal_documento_identificativo").then((e=>{CoreUI.Modal.CustomHTML(e,null,null,"90%")})).then((()=>{CertificadoDigital.GUI.CargarComunidadesSeleccionadasIntoModal()})):CoreUI.Modal.Error("Debe seleccionar al menos una comunidad para poder solicitar y emitir el certificado digital correspondiente","Error")},SeleccionarRepresentanteLegal:async function(){let e=Object();e.idcomunidad=core.modelId,e.nombreComunidad=core.Modelo.entity.Comunidad[0].nombre,e.codigoComunidad=core.Modelo.entity.Comunidad[0].codigo,apiFincatech.get(`administrador/${core.Security.user}/representantelegal/list`).then((t=>{e.representanteslegales=JSON.parse(t).data.representantelegal,0==e.representanteslegales.length?CoreUI.Modal.Error("Actualmente no tiene representantes legales asignados.<br>Por favor, contacte con Fincatech para más información.","Certificado digital de comunidad"):apiFincatech.getView("modals","certificadodigital/modal_representante_legal",JSON.stringify(e)).then((e=>{CoreUI.Modal.CustomHTML(e,"SOLICITUD APROBACIÓN CERTIFICADO DIGITAL",null,"64em")})).then((()=>{$("body #representanteLegal").select2({theme:"bootstrap4",placeholder:"Seleccione una opción"})}))}))}},Render:{renderTablaComunidadCertificadoDigital:function(e){if($("#listadoDocumentacionCertificadoDigital").length){CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoDocumentacionCertificadoDigital","titulo","Nombre del empleado",null,"text-left"),CoreUI.tableData.addColumn("listadoDocumentacionCertificadoDigital","ficheroscomunes[0]","DOCUMENTO",null,"text-center",null,(function(e,t,i,a){return`\n                                      <a href="javascript:void(0);" class="btnAdjuntarDocumentoEmpleadoRGPD" data-idrow="${a.row}" data-tipo="rgpdempleado" data-idrequerimiento="${i.id}">\n                                        <i class="bi bi-cloud-arrow-up text-danger" style="font-size: 30px;"></i>\n                                      </a>\n                                      `})),CoreUI.tableData.addColumn("listadoDocumentacionCertificadoDigital",(function(e,t,i,a){var o="";e.updated;return e.ficheroscomunes.length>0&&(o=`<a href="${baseURL}public/storage/${e.ficheroscomunes[0].nombrestorage}" download="${e.ficheroscomunes[0].nombre}" class="d-block" data-toggle="tooltip" data-placement="bottom" title="Ver documento" data-original-title="Ver documento" target="_blank">\n                                            <i class="bi bi-file-earmark-arrow-down text-success" style="font-size: 24px;"></i>\n                                        </a>`),e.ficheroscomunes.length?(e.updated?fecha=e.updated:fecha=e.created,`<p class="mb-0 text-center">${o} ${`<span class="small">Subido el ${moment(fecha).locale("es").format("L")}</span>`}</p>`):'<span class="badge rounded-pill bg-danger pl-3 pr-3 pt-2 pb-2 d-block">No adjuntado</span>'}),"DOCUMENTO ADJUNTADO",null,"text-center");'<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarDocumentoRGPD d-inline-block" data-id="data:id$" data-tipo="rgpdempleado" data-nombre="data:titulo$"><i data-feather="trash-2" class="text-danger img-fluid"></i></li></ul>',CoreUI.tableData.addColumn("listadoDocumentacionCertificadoDigital",null,"",'<ul class="nav justify-content-center accionesTabla"><li class="nav-item"><a href="javascript:void(0);" class="btnEliminarDocumentoRGPD d-inline-block" data-id="data:id$" data-tipo="rgpdempleado" data-nombre="data:titulo$"><i data-feather="trash-2" class="text-danger img-fluid"></i></li></ul>'),$("#listadoDocumentacionCertificadoDigital").addClass("no-clicable")}},CertificadosPendientes:function(){$("#listadoCertificadoDigitalPendiente").length&&(CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoCertificadoDigitalPendiente",(function(e,t,i,a){if("0"==e.aprobado||"1"==e.solicitadouanataca||"1"==e.solicitudcertificado)return"";return`<div class="form-check">\n                                <input class="form-check-input chkSelectorComunidad mx-auto" type="checkbox" data-idrow="${a.row}" data-idsolicitud="${e.idsolicitud}" data-idcomunidad="${e.id}" value="${e.idsolicitud}" id="chkSelectorComunidad${e.id}">\n                            </div>`})),CoreUI.tableData.addColumn("listadoCertificadoDigitalPendiente",(function(e,t,i,a){return e.codigo}),"Cód.",null,"text-left"),CoreUI.tableData.addColumn("listadoCertificadoDigitalPendiente",(function(e,t,i,a){return e.nombre}),"Comunidad",null,"text-left"),CoreUI.tableData.addColumn("listadoCertificadoDigitalPendiente",(function(e,t,i,a){return e.tecnicoaprobacion}),"Técnico Operador de Registro",null,"text-left"),CoreUI.tableData.addColumn("listadoCertificadoDigitalPendiente",(function(e,t,i,a){let o="";return o="1"==e.aprobado?'<span class="badge rounded-pill text-uppercase bg-success d-block pt-2 pb-2 pl-5 pr-5">Aprobada</span>':'<span class="badge rounded-pill text-uppercase bg-warning text-dark d-block pt-2 pb-2 pl-5 pr-5">Pendiente de aprobación</span>',o}),"Solicitud",null,"text-center","10%"),CoreUI.tableData.addColumn("listadoCertificadoDigitalPendiente",(function(e,t,i,a){return"1"==e.aprobado?moment(e.fechaaprobacion).locale("es").format("L"):""}),"Fecha aprobación",null,"text-center"),CoreUI.tableData.addColumn("listadoCertificadoDigitalPendiente",(function(e,t,i,a){let o="";return o="1"==e.solicitadouanataca?'<span class="badge rounded-pill text-uppercase bg-success d-block pt-2 pb-2 pl-5 pr-5">Emitido</span>':'<span class="badge rounded-pill text-uppercase bg-warning text-dark d-block pt-2 pb-2 pl-5 pr-5">Pendiente emisión</span>',o}),"Estado certificado",null,"text-center","10%"),$("#listadoCertificadoDigitalPendiente").addClass("no-clicable"),CoreUI.tableData.render("listadoCertificadoDigitalPendiente","comunidad","certificadodigital/administrador/solicitudes/list",null,!1,!0))}},Validate:{HasSelectedComunity:function(){let e=!1;return $(".chkSelectorComunidad").each((function(t){$(this).is(":checked")&&(e=!0)})),e}}};$((()=>{CertificadoDigital.Init()}));