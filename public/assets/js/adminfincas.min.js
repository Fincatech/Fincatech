let adminFincas={Init:async function(){comunidadesCore.renderMenuLateral(),adminFincas.Events()},Events:async function(){$("body #listadoSMSAdministrador").length>0&&await adminFincas.SMS.RenderTableSMSCertified(),$("body #listadoEmailCertificadoAdministrador").length>0&&await adminFincas.Email.RenderTableEmailCertified(),$("body").on(core.helper.clickEventType,".btnSendSimpleSMS",(e=>{if(e.stopImmediatePropagation(),adminFincas.SMS.ValidateSMSSimple()){let e=$("#telefonoDestinatario").val(),a=$("#mensajeSMS").val();adminFincas.SMS.SendSimpleSMSCertified(e,a)}})),$("body").on(core.helper.clickEventType,".btnEnviarSMSCertificadoContrato",(e=>{if(adminFincas.SMS.ValidateSMSContrato()){let e=$("#telefonoDestinatarioContrato").val(),a=$("#mensajeSMSContrato").val();adminFincas.SMS.SendContractSMSCertified(e,a)}})),$("body").on(core.helper.clickEventType,".btnVerMensajeEnviado",(function(e){adminFincas.Email.VerEmailEnviado($(this).attr("data-id"))})),$("body").on("keyup",".mensajeSMS",(e=>{let a=e.target.id,i=$(`body #${a}`).val(),t=$(`body #${a}`).attr("data-origin");adminFincas.SMS.CalcRemainChars(t,i)})),$("body").on(core.helper.clickEventType,".btnEnviarEmailCertificado",(()=>{adminFincas.Email.EnviarEmailCertificado($("#nombreDestinatario").val(),$("#emailDestinatario").val(),$("#emailAsunto").val(),$("#emailBody").val(),core.Files.Fichero)}))},Helper:{htmlEntities:function(e){var a=document.createElement("textarea");return a.innerHTML=e,a.value}},Email:{VerEmailEnviado:async function(e){await apiFincatech.get(`mensaje/${e}`).then((async e=>{let a=JSON.parse(e);a.data.Mensaje[0].body=adminFincas.Helper.htmlEntities(a.data.Mensaje[0].body),a.data.Mensaje[0].body=a.data.Mensaje[0].body.replaceAll("https:/app.fincatech.es/","https://app.fincatech.es/");let i=JSON.stringify(a.data.Mensaje[0]);await apiFincatech.getView("modals","email/view_email",i).then((e=>{CoreUI.Modal.CustomHTML(e,"E-mail certificado")}))}))},validarEmailCertificado:function(){let e="",a=core.helper.validarEmail($("#emailDestinatario").val());return $("form .form-control").removeClass("form-error"),""!=$("#emailDestinatario").val()&&0!=a||(e="El e-mail del destinatario no es válido<br>",$("#emailDestinatario").addClass("form-error")),""==$("#emailAsunto").val()&&(e=`${e}El asunto del e-mail no puede estar vacío<br>`,$("#emailAsunto").addClass("form-error")),""==$("#emailBody").val()&&(e=`${e}El cuerpo del e-mail está vacío<br>`,$("#emailBody").addClass("form-error")),""===e||(CoreUI.Modal.Error(`<p class="text-left">No se ha podido enviar el e-mail por los siguientes motivos:<br><br>${e}</p>`,"Envío E-mail certificado"),!1)},EnviarEmailCertificado:async function(e,a,i,t,o=null){if(adminFincas.Email.validarEmailCertificado()){var r=Object();r={senderid:-1,destinatario:a,comunidad:e,mensaje:t,subject:i,attachment:o},await apiFincatech.post("certificadodigital/administrador/envioemailcertificado",r).then((async e=>{var a=JSON.parse(e);"ok"==a.status.response?(CoreUI.Modal.Success("El E-mail se ha enviado correctamente."),$("#nombreDestinatario").val(""),$("#emailDestinatario").val(""),$("#emailAsunto").val(""),$("#emailBody").val(""),adminFincas.Email.RenderTableEmailCertified()):CoreUI.Modal.Error(`No se ha podido enviar el E-mail<br><br>${a.status.error}`)}))}},RenderTableEmailCertified:function(){$("#listadoEmailCertificadoAdministrador").length&&(CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(e,a,i,t){let o="";return o=e.destinatarionombre?`${e.destinatarionombre} ( ${e.email} )`:e.email,o}),"Destinatario",null,"text-left"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador","subject","Asunto",null,"text-left"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(e,a,i,t){return`<a href="javascript:void(0);" class="btnVerMensajeEnviado pr-4" data-id="${e.id}"><i class="bi bi-envelope-open"></i></a>`}),"Mensaje",null,"text-center"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(e,a,i,t){return fecha=e.created,fechaSubida=`<span>${moment(fecha).locale("es").format("DD/MM/YYYY")}</span>`,`<p class="mb-0 text-center">${fechaSubida}</p>`}),"Fecha envío",null,"text-center"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(e,a,i,t){return fecha=e.created,fechaSubida=`<span>${moment(fecha).locale("es").format("h:mm")}</span>`,`<p class="mb-0 text-center">${fechaSubida}</p>`}),"Hora envío",null,"text-center"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(e,a,i,t){let o="";return o=e.filename?`<a class="btnDescargarEmailCertificado" href="${baseURL}public/storage/emailcertificados/${e.filename}" target="_blank" title="Email certificado"><i data-feather="mail" class="text-success img-fluid"></i></a>`:'<span class="badge rounded-pill bg-success pl-2 pr-2 pt-1 pb-1 d-block">Entregado</span>',`<p class="mb-0 text-center">${o}</p>`}),"Estado",null,"text-center"),$("#listadoEmailCertificadoAdministrador").addClass("no-clicable"),CoreUI.tableData.render("listadoEmailCertificadoAdministrador","Mensaje","certificadodigital/administrador/emailcertificado/list",!1,!0,!0))}},SMS:{CalcRemainChars:function(e,a){let i=160-a.length;$(`body .${e} .smsCaracteresRestantes`).text(i)},RenderTableSMSCertified:async function(){$("#listadoSMSAdministrador").length&&(CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoSMSAdministrador","phone","Teléfono",null,"text-left"),CoreUI.tableData.addColumn("listadoSMSAdministrador","message","Mensaje",null,"text-left"),CoreUI.tableData.addColumn("listadoSMSAdministrador",(function(e,a,i,t){return fecha=e.created,fechaSubida=`<span>${moment(fecha).locale("es").format("LLL")}</span>`,`<p class="mb-0 text-center">${fechaSubida}</p>`}),"Fecha envío",null,"text-center"),$("#listadoSMSAdministrador").addClass("no-clicable"),CoreUI.tableData.render("listadoSMSAdministrador","Sms","sms/list",!1,!1,!0))},SendSimpleSMSCertified:async function(e,a){var i=Object();i={sender:core.Security.user,phonenumber:e,message:a},await apiFincatech.post("certificadodigital/administrador/enviosms",i).then((async a=>{var i=JSON.parse(a);"ok"==i.status.response?(CoreUI.Modal.Success("El SMS se ha enviado correctamente al número de teléfono "+e),adminFincas.SMS.RenderTableSMSCertified(),$("#telefonoDestinatario").val(""),$("#mensajeSMS").val("")):CoreUI.Modal.Error("No se ha podido enviar el SMS por el siguiente motivo:<br><br>"+i.status.response)}))},SendContractSMSCertified:async function(e,a){var i=Object();i={sender:core.Security.user,phonenumber:e,message:a,filebase64:core.Files.Fichero.base64,filename:core.Files.Fichero.nombre},await apiFincatech.post("certificadodigital/administrador/enviosmscontrato",i).then((async a=>{var i=JSON.parse(a);"ok"==i.status.response?(CoreUI.Modal.Success("El SMS se ha enviado correctamente al número de teléfono "+e),adminFincas.SMS.RenderTableSMSCertified()):CoreUI.Modal.Error("No se ha podido enviar el SMS por el siguiente motivo:<br><br>"+i.status.response)}))},ValidatePhoneNumber:function(e){return new RegExp(/^[0-9]{11}$/).test(e)},ValidateSMSSimple:function(){let e="";return $("form .form-control").removeClass("form-error"),""==$("#telefonoDestinatario").val()&&(e="- El teléfono no puede estar vacío<br>",$("#telefonoDestinatario").addClass("form-error")),0==adminFincas.SMS.ValidatePhoneNumber($("#telefonoDestinatario").val())&&(e+="- El número de teléfono no es válido<br>",$("#telefonoDestinatario").addClass("form-error")),""==$("#mensajeSMS").val()&&(e+="- El texto del mensaje no puede estar vacío<br>",$("#mensajeSMS").addClass("form-error")),""==e||(CoreUI.Modal.Error(`<p class="text-left">No se ha podido enviar el sms certificado por los siguientes motivos:<br><br>${e}</p>`,"No se ha podido enviar el SMS"),!1)},ValidateSMSContrato:function(){let e="";return""==$("#telefonoDestinatarioContrato").val()&&(e="- El teléfono no puede estar vacío<br>"),0==adminFincas.SMS.ValidatePhoneNumber($("#telefonoDestinatarioContrato").val())&&(e+="- El número de teléfono no es válido<br>"),""==$("#mensajeSMSContrato").val()&&(e+="- El texto del mensaje no puede estar vacío<br>"),null==core.Files.Fichero.base64&&(e+="- Debe adjuntar un fichero en formato PDF<br>"),""==e||(CoreUI.Modal.Error(`<p class="text-left">No se ha podido enviar el sms certificado de contrato por los siguientes motivos:<br><br>${e}</p>`,"No se ha podido enviar el SMS"),!1)}}};$((()=>{adminFincas.Init()}));