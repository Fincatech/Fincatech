let adminFincas={Init:async function(){comunidadesCore.renderMenuLateral(),adminFincas.Events()},Events:async function(){$("body #listadoSMSAdministrador").length>0&&await adminFincas.SMS.RenderTableSMSCertified(),$("body #listadoEmailCertificadoAdministrador").length>0&&await adminFincas.Email.RenderTableEmailCertified(),$("body").on(core.helper.clickEventType,".btnSendSimpleSMS",evt=>{if(evt.stopImmediatePropagation(),adminFincas.SMS.ValidateSMSSimple()){let phoneNumber=$("#telefonoDestinatario").val(),messageText=$("#mensajeSMS").val();adminFincas.SMS.SendSimpleSMSCertified(phoneNumber,messageText)}}),$("body").on(core.helper.clickEventType,".btnEnviarSMSCertificadoContrato",evt=>{if(adminFincas.SMS.ValidateSMSContrato()){let phoneNumber=$("#telefonoDestinatarioContrato").val(),messageText=$("#mensajeSMSContrato").val();adminFincas.SMS.SendContractSMSCertified(phoneNumber,messageText)}}),$("body").on(core.helper.clickEventType,".btnVerMensajeEnviado",(function(evt){adminFincas.Email.VerEmailEnviado($(this).attr("data-id"))})),$("body").on("keyup",".mensajeSMS",evt=>{let fieldId=evt.target.id,messageText=$(`body #${fieldId}`).val(),messageOrigin=$(`body #${fieldId}`).attr("data-origin");adminFincas.SMS.CalcRemainChars(messageOrigin,messageText)}),$("body").on(core.helper.clickEventType,".btnEnviarEmailCertificado",()=>{adminFincas.Email.EnviarEmailCertificado($("#nombreDestinatario").val(),$("#emailDestinatario").val(),$("#emailAsunto").val(),$("#emailBody").val())})},Helper:{htmlEntities:function(rawStr){var textArea=document.createElement("textarea");return textArea.innerHTML=rawStr,textArea.value}},Email:{VerEmailEnviado:async function(emailId){await apiFincatech.get(`mensaje/${emailId}`).then(async result=>{let resultado=JSON.parse(result);resultado.data.Mensaje[0].body=adminFincas.Helper.htmlEntities(resultado.data.Mensaje[0].body),resultado.data.Mensaje[0].body=resultado.data.Mensaje[0].body.replaceAll("https:/app.fincatech.es/","https://app.fincatech.es/");let datosMensaje=JSON.stringify(resultado.data.Mensaje[0]);await apiFincatech.getView("modals","email/view_email",datosMensaje).then(result=>{CoreUI.Modal.CustomHTML(result,"E-mail certificado")})})},validarEmailCertificado:function(){let error="",emailValido=core.helper.validarEmail($("#emailDestinatario").val());return $("form .form-control").removeClass("form-error"),""!=$("#emailDestinatario").val()&&0!=emailValido||(error="El e-mail del destinatario no es válido<br>",$("#emailDestinatario").addClass("form-error")),""==$("#emailAsunto").val()&&(error=`${error}El asunto del e-mail no puede estar vacío<br>`,$("#emailAsunto").addClass("form-error")),""==$("#emailBody").val()&&(error=`${error}El cuerpo del e-mail está vacío<br>`,$("#emailBody").addClass("form-error")),""===error||(CoreUI.Modal.Error(`<p class="text-left">No se ha podido enviar el e-mail por los siguientes motivos:<br><br>${error}</p>`,"Envío E-mail certificado"),!1)},EnviarEmailCertificado:async function(recipient,emailto,subject,message){if(adminFincas.Email.validarEmailCertificado()){var data=Object();data={senderid:-1,destinatario:emailto,comunidad:recipient,mensaje:message,subject:subject},await apiFincatech.post("certificadodigital/administrador/envioemailcertificado",data).then(async response=>{var responseData=JSON.parse(response);console.log(responseData),"ok"==responseData.status.response?(CoreUI.Modal.Success("El E-mail se ha enviado correctamente."),$("#nombreDestinatario").val(""),$("#emailDestinatario").val(""),$("#emailAsunto").val(""),$("#emailBody").val(""),adminFincas.Email.RenderTableEmailCertified()):CoreUI.Modal.Error(`No se ha podido enviar el E-mail<br><br>${responseData.status.error}`)})}},RenderTableEmailCertified:function(){$("#listadoEmailCertificadoAdministrador").length&&(CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(row,type,val,meta){let outhtml="";return outhtml=row.destinatarionombre?`${row.destinatarionombre} ( ${row.email} )`:row.email,outhtml}),"Destinatario",null,"text-left"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador","subject","Asunto",null,"text-left"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(row,type,val,meta){let outhtml;return`<a href="javascript:void(0);" class="btnVerMensajeEnviado pr-4" data-id="${row.id}"><i class="bi bi-envelope-open"></i></a>`}),"Mensaje",null,"text-center"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(row,type,val,meta){return fecha=row.created,fechaSubida=`<span>${moment(fecha).locale("es").format("DD/MM/YYYY")}</span>`,`<p class="mb-0 text-center">${fechaSubida}</p>`}),"Fecha envío",null,"text-center"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(row,type,val,meta){return fecha=row.created,fechaSubida=`<span>${moment(fecha).locale("es").format("h:mm")}</span>`,`<p class="mb-0 text-center">${fechaSubida}</p>`}),"Hora envío",null,"text-center"),CoreUI.tableData.addColumn("listadoEmailCertificadoAdministrador",(function(row,type,val,meta){let salida="";return salida=row.filename?`<a class="btnDescargarEmailCertificado" href="${baseURL}public/storage/emailcertificados/${row.filename}" target="_blank" title="Email certificado"><i data-feather="mail" class="text-success img-fluid"></i></a>`:'<span class="badge rounded-pill bg-success pl-2 pr-2 pt-1 pb-1 d-block">Entregado</span>',`<p class="mb-0 text-center">${salida}</p>`}),"Estado",null,"text-center"),$("#listadoEmailCertificadoAdministrador").addClass("no-clicable"),CoreUI.tableData.render("listadoEmailCertificadoAdministrador","Mensaje","certificadodigital/administrador/emailcertificado/list",!1,!0,!0))}},SMS:{CalcRemainChars:function(smsOrigin,smsText){let maxLength=160,totalRemaining=160-smsText.length;$(`body .${smsOrigin} .smsCaracteresRestantes`).text(totalRemaining)},RenderTableSMSCertified:async function(){$("#listadoSMSAdministrador").length&&(CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoSMSAdministrador","phone","Teléfono",null,"text-left"),CoreUI.tableData.addColumn("listadoSMSAdministrador","message","Mensaje",null,"text-left"),CoreUI.tableData.addColumn("listadoSMSAdministrador",(function(row,type,val,meta){return fecha=row.created,fechaSubida=`<span>${moment(fecha).locale("es").format("LLL")}</span>`,`<p class="mb-0 text-center">${fechaSubida}</p>`}),"Fecha envío",null,"text-center"),$("#listadoSMSAdministrador").addClass("no-clicable"),CoreUI.tableData.render("listadoSMSAdministrador","Sms","sms/list",!1,!1,!0))},SendSimpleSMSCertified:async function(targetPhone,messageText){var data=Object();data={sender:core.Security.user,phonenumber:targetPhone,message:messageText},await apiFincatech.post("certificadodigital/administrador/enviosms",data).then(async response=>{var responseData=JSON.parse(response);"ok"==responseData.status.response?(CoreUI.Modal.Success("El SMS se ha enviado correctamente al número de teléfono "+targetPhone),adminFincas.SMS.RenderTableSMSCertified(),$("#telefonoDestinatario").val(""),$("#mensajeSMS").val("")):CoreUI.Modal.Error("No se ha podido enviar el SMS por el siguiente motivo:<br><br>"+responseData.status.response)})},SendContractSMSCertified:async function(targetPhone,messageText){var data=Object();data={sender:core.Security.user,phonenumber:targetPhone,message:messageText,filebase64:core.Files.Fichero.base64,filename:core.Files.Fichero.nombre},await apiFincatech.post("certificadodigital/administrador/enviosmscontrato",data).then(async response=>{var responseData=JSON.parse(response);"ok"==responseData.status.response?(CoreUI.Modal.Success("El SMS se ha enviado correctamente al número de teléfono "+targetPhone),adminFincas.SMS.RenderTableSMSCertified()):CoreUI.Modal.Error("No se ha podido enviar el SMS por el siguiente motivo:<br><br>"+responseData.status.response)})},ValidatePhoneNumber:function(num){var ph;return new RegExp(/^[0-9]{11}$/).test(num)},ValidateSMSSimple:function(){let validationError="";return $("form .form-control").removeClass("form-error"),""==$("#telefonoDestinatario").val()&&(validationError="- El teléfono no puede estar vacío<br>",$("#telefonoDestinatario").addClass("form-error")),0==adminFincas.SMS.ValidatePhoneNumber($("#telefonoDestinatario").val())&&(validationError+="- El número de teléfono no es válido<br>",$("#telefonoDestinatario").addClass("form-error")),""==$("#mensajeSMS").val()&&(validationError+="- El texto del mensaje no puede estar vacío<br>",$("#mensajeSMS").addClass("form-error")),""==validationError||(CoreUI.Modal.Error(`<p class="text-left">No se ha podido enviar el sms certificado por los siguientes motivos:<br><br>${validationError}</p>`,"No se ha podido enviar el SMS"),!1)},ValidateSMSContrato:function(){let validationError="";return""==$("#telefonoDestinatarioContrato").val()&&(validationError="- El teléfono no puede estar vacío<br>"),0==adminFincas.SMS.ValidatePhoneNumber($("#telefonoDestinatarioContrato").val())&&(validationError+="- El número de teléfono no es válido<br>"),""==$("#mensajeSMSContrato").val()&&(validationError+="- El texto del mensaje no puede estar vacío<br>"),null==core.Files.Fichero.base64&&(validationError+="- Debe adjuntar un fichero en formato PDF<br>"),""==validationError||(CoreUI.Modal.Error(`<p class="text-left">No se ha podido enviar el sms certificado de contrato por los siguientes motivos:<br><br>${validationError}</p>`,"No se ha podido enviar el SMS"),!1)}}};$(()=>{adminFincas.Init()});