let administradorCore={administradores:Object(),administrador:Object(),init:async function(){administradorCore.events(),"list"==core.actionModel&&"administrador"==core.model.toLowerCase()?await administradorCore.listadoDashboard():"administrador"==core.model.toLowerCase()&&"list"!=core.actionModel&&(core.model="Usuario",comunidadesCore.renderTablaComunidadesAdministrador(core.modelId),$(".titulo-modulo").length&&"Administrador"==core.model&&CoreUI.setTitulo("nombre"),administradorCore.RepresentanteLegal.Controller.RenderTablaRepresentantesLegales()),administradorCore.RepresentanteLegal.Events()},events:function(){$("body").on(core.helper.clickEventType,".btnVerAdministrador",(e=>{e.stopImmediatePropagation(),administradorCore.verModalAdministrador($(e.currentTarget).attr("data-id"),$(e.currentTarget).attr("data-nombre"))})),$("body").on(core.helper.clickEventType,".btnEliminarAdministrador",(e=>{e.stopImmediatePropagation(),administradorCore.eliminar($(e.currentTarget).attr("data-id"),$(e.currentTarget).attr("data-nombre"))})),$("body .form-representante-legal").off(core.helper.clickEventType).on(core.helper.clickEventType,".btnSaveData",(e=>{e.stopImmediatePropagation(),administradorCore.RepresentanteLegal.Controller.Guardar()})),$("body").on(core.helper.clickEventType,".btnEliminarRepresentanteLegal",(e=>{e.stopImmediatePropagation(),administradorCore.RepresentanteLegal.Controller.Eliminar($(e.currentTarget).attr("data-id"),$(e.currentTarget).attr("data-nombre"))})),$("body").on("change","#fileFrontDocument",(function(){administradorCore.Helper.readURL(this,"imgfileFrontDocument")})),$("body").on("change","#fileRearDocument",(function(){administradorCore.Helper.readURL(this,"imgfileRearDocument")})),$("body").on(core.helper.clickEventType,".btnExportarComunidades",(function(e){administradorCore.ExportComunidadesToExcel($(this).attr("data-id"),$(this).attr("data-nombre"))}))},eliminar:function(e,a){core.Modelo.Delete("administrador",e,a,"listadoAdministrador")},verModalAdministrador:async function(e){administradorCore.getAdministrador(e).then((e=>{e,apiFincatech.getView("modals","administradores/modal_info").then((a=>{e=CoreUI.Utils.parse(a,administradorCore.comunidad),CoreUI.Modal.GetHTML("modalInfoComunidad",e,administradorCore.comunidad.nombre)}))}))},renderTabla:async function(e=!1,a="listadoAdministrador"){if($(`#${a}`).length){CoreUI.tableData.init(),CoreUI.tableData.addColumn(a,"codigo","CÓD"),CoreUI.tableData.addColumn(a,"nombre","NOMBRE"),CoreUI.tableData.addColumn(a,"cif","CIF");var t='<a href="mailto:data:email$" class="pl-1 pr-1">data:email$</a>';CoreUI.tableData.addColumn(a,null,"EMAIL",t),CoreUI.tableData.addColumn(a,"telefono","TELEFONO"),CoreUI.tableData.addColumn(a,"numerocomunidades","Comunidades activas",null,"text-center"),CoreUI.tableData.addColumn(a,(function(e,a,t,r){return 1==e.visitado?'<span class="badge badge-pill bg-success text-white">Visitado</span>':'<span class="badge badge-pill bg-danger text-white">No visitado</span>'}),"Visitado",null,"text-center"),CoreUI.tableData.addColumn(a,(function(e,a,t,r){var o,n;return e.lastlogin&&"0000-00-00 00:00:00"!=e.lastlogin?(o=moment(e.lastlogin,"YYYY-MM-DD hh:mm").unix(),n=moment(e.lastlogin).format("DD/MM/YYYY")):(o="",n='<span class="badge badge-pill bg-danger text-white">Nunca</span>'),`<span style="display:none;">${o}</span>${n}`}),"Último acceso",null,"text-center");t="data:estado$";CoreUI.tableData.addColumn(a,null,"Estado",t,"text-center");t="data:created$";CoreUI.tableData.addColumn(a,null,"Fecha de alta",t,"text-center");t='<ul class="nav justify-content-center">';t+=`<li class="nav-item"><a href="${baseURL}administrador/data:id$" class="btnEditarAdministrador d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="edit" class="text-success img-fluid icono-accion" style="height:26px; width:26px;"></i></a></li>`,"SUDO"==core.Security.getRole()&&(t+='<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarAdministrador d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="trash-2" class="text-danger img-fluid icono-accion" style="height:26px; width:26px;"></i></a></li>'),t+="</ul>",CoreUI.tableData.addColumn(a,null,"",t,"text-center"),"SUDO"==core.Security.getRole()&&(t='<a href="javascript:void(0);" class="btnExportarComunidades btn btn-primary d-inline-block" data-id="data:id$" data-nombre="data:nombre$">Exportar comunidades</a>',CoreUI.tableData.addColumn(a,null,"",t,"text-center")),CoreUI.tableData.render(a,"Usuario","administrador/list")}},listadoDashboard:async function(){this.renderTabla()},getAdministrador:async function(e){await apiFincatech.get("administrador/"+e).then((e=>(result=JSON.parse(e),responseStatus=result.status,responseData=result.data,administradorCore.administrador=responseData.Usuario[0],administradorCore.administrador.password="",administradorCore.comunidad)))},getAll:async function(){await apiFincatech.get("administrador/list").then((async e=>{result=JSON.parse(e),responseStatus=result.status,responseData=result.data,administradorCore.administradores=responseData.Usuario}))},ExportComunidadesToExcel:function(e,a){Swal.fire({title:"Exportación de comunidades",html:'<p>Clique el botón <strong>descargar</strong> para poder descargar un fichero Excel con la información de todas las comunidades asociadas a este administrador así como los servicios contratados.</p>\n            <h6 class="p-2 bg-primary shadow-neumorphic mb-3 mt-3 br-10 text-white font-weight-bold text-uppercase"></i> Instrucciones tras la descarga</h6>\n            <p class="text-left">Las columnas con el nombre <strong>ID interno (No cambiar)</strong> no puede cambiarse su valor o el proceso de importación no se ejecutará correctamente.</p>\n            <p class="text-left">Las columnas que hacen referencia al <strong>estado de contratación</strong> solo admiten 2 valores: 0 ó 1 de donde 0 indica que no está contratado y 1 que está contratado el servicio especificado.</p>\n            <p class="text-left">Las columnas que hacen referencia al <strong>precio</strong> tanto de comunidad como de Fincatech no deben contener símbolos de Euro, sólo valores numéricos.</p>',grow:"false",width:"60rem",showCancelButton:!0,showConfirmButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:'<i class="bi bi-save mr-2"></i> Descargar',cancelButtonText:'<i class="bi bi-x-circle mr-2"></i> Cancelar',reverseButtons:!0,buttonsStyling:!1,customClass:{actions:"text-center p-3 shadow-inset rounded-pill border-light border-2 bg-white",confirmButton:"btn btnSaveData btn-success rounded-pill shadow d-block pb-2 pt-2 cofirmButtonModal",cancelButton:" btn btn-danger btnCancelSave rounded-pill shadow d-block pb-2 pt-2 mr-3 cacelButtonModal",popup:"bdg-transparent"}}).then((t=>{t.isConfirmed&&apiFincatech.get(`administrador/${e}/comunidades/excelexport`).then((e=>{let t=JSON.parse(e);if("Error"==t.data)CoreUI.Modal.Error(t.status.error,"Exportación de comunidades");else{let e=atob(t.data),r=new Uint8Array(e.length);for(let a=0;a<e.length;a++)r[a]=e.charCodeAt(a);let o=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=document.createElement("a");n.href=window.URL.createObjectURL(o),a=a.replace(/ /g,"_"),n.download=`exportacion_comunidades_${a}.xlsx`,n.click()}}))}))},RepresentanteLegal:{Events:function(){$(".form-representante-legal")&&"get"===core.actionModel&&(administradorCore.Helper.changeUploadStatus("status-frontal",!0),administradorCore.Helper.changeUploadStatus("status-anverso",!0),"Representantelegal"==core.model&&$("body").on("hsFormDataLoaded",(function(e,a){$(".fecha-frontal").html(moment(core.Modelo.entity.Representantelegal[0].documentofrontal.created).locale("es").format("DD/MM/YYYY HH:mm")),$(".fecha-anverso").html(moment(core.Modelo.entity.Representantelegal[0].documentotrasera.created).locale("es").format("DD/MM/YYYY HH:mm"))})))},Controller:{Guardar:function(){if(core.Forms.Validate("form-representante-legal"))if(administradorCore.RepresentanteLegal.Validator.ValidateImages())switch(core.actionModel){case"add":administradorCore.RepresentanteLegal.Controller.Insert();break;case"get":administradorCore.RepresentanteLegal.Controller.Update();break}else CoreUI.Modal.Error("Debe adjuntar las imágenes del documento de identidad");else CoreUI.Modal.Error("Corrija los campos obligatorios para poder guardar la información")},Insert:function(){core.Forms.mapDataToSave(),administradorCore.Helper.setDocumentImages(),core.Forms.Save(),$("#administradorid").val($("#hadministradorid").val())},Listado:function(){administradorCore.RepresentanteLegal.Controller.GetAll(1).then((e=>{}))},GetAll:async function(e){return apiFincatech.get(`administrador/${e}/representantelegal/list`)},Update:function(){},Eliminar:function(e,a){core.Modelo.Delete("representantelegal",e,a,"listadoAdministradorRepresentantesLegales")},RenderTablaComunidadesRepresentadas:function(){},RenderTablaRepresentantesLegales:function(){if($("#listadoAdministradorRepresentantesLegales").length){CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoAdministradorRepresentantesLegales",(function(e,a,t,r){return`${e.nombre} ${e.apellido} ${e.apellido2}`}),"Nombre y apellidos",null,"text-left"),CoreUI.tableData.addColumn("listadoAdministradorRepresentantesLegales","documento","CIF");CoreUI.tableData.addColumn("listadoAdministradorRepresentantesLegales",null,"EMAIL",'<a href="mailto:data:email$" class="pl-1 pr-1">data:email$</a>'),CoreUI.tableData.addColumn("listadoAdministradorRepresentantesLegales","telefono","TELEFONO"),CoreUI.tableData.addColumn("listadoAdministradorRepresentantesLegales",(function(e,a,t,r){return`${moment(e.created).locale("es").format("L")}`}),"Fecha de alta",null,"text-center"),CoreUI.tableData.addColumn("listadoAdministradorRepresentantesLegales",(function(e,a,t,r){return`${e.estado}`}),"Estado",null,"text-center"),CoreUI.tableData.addColumn("listadoAdministradorRepresentantesLegales",(function(e,a,t,r){var o='<ul class="nav justify-content-center">';return o+=`<li class="nav-item"><a href="${baseURL}representantelegal/${e.id}" class="btnEditarRepresentanteLegal d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="edit" class="text-success img-fluid mr-2" style="height:26px; width:26px;"></i></a></li>`,"SUDO"==core.Security.getRole()&&(o+=`<li class="nav-item">\n                                                <a href="javascript:void(0);" class="btnEliminarRepresentanteLegal d-inline-block" data-id="${e.id}" data-nombre="${e.nombre} ${e.apellido} ${e.apellido2}"><i data-feather="trash-2" class="text-danger img-fluid" style="height:26px; width:26px;"></i>\n                                            </li>`),o+="</ul>"}),"",null,"text-center"),$("#listadoAdministradorRepresentantesLegales").addClass("no-clicable"),CoreUI.tableData.render("listadoAdministradorRepresentantesLegales","representantelegal",`administrador/${core.modelId}/representantelegal/list`)}}},Model:{frontDocumentBase64:null,frontDocument:null,rearDocumentBase64:null,rearDocument:null},Entity:{ImagenDocumentoFrontal:null,ImagenDocumentoTrasera:null},Validator:{ValidateImages:function(){return"add"!==core.actionModel||null!==CertificadoDigital.Model.frontDocumentBase64&&null!==CertificadoDigital.Model.rearDocumentBase64}}},Helper:{changeUploadStatus:function(e,a){a?$(`.${e}`).html('<span class="badge rounded-pill text-uppercase bg-success d-block pt-2 pb-2 pl-5 pr-5 mx-3">Subido</span>'):$(`.${e}`).html('<span class="badge rounded-pill text-uppercase bg-danger d-block pt-2 pb-2 pl-5 pr-5 mx-3">Pendiente</span>')},readURL:function(e,a){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(t){$(`body .${a}`).attr("src",t.target.result);var r=document.getElementById(e.id).value;if(r){var o=r.indexOf("\\")>=0?r.lastIndexOf("\\"):r.lastIndexOf("/"),n=r.substring(o);0!==n.indexOf("\\")&&0!==n.indexOf("/")||(n=n.substring(1))}if(r.filesize/1024>3)CoreUI.Modal.Error("El archivo no puede superar los 3Mb de tamaño. Seleccione otro, por favor");else switch(a){case"imgfileFrontDocument":CertificadoDigital.Model.frontDocumentBase64=t.target.result,CertificadoDigital.Model.frontDocument=n,administradorCore.Helper.changeUploadStatus("status-frontal",!0);break;case"imgfileRearDocument":CertificadoDigital.Model.rearDocumentBase64=t.target.result,CertificadoDigital.Model.rearDocument=n,administradorCore.Helper.changeUploadStatus("status-anverso",!0);break}},t.readAsDataURL(e.files[0])}},setDocumentImages:function(){core.Forms.data.frontImageBase64=CertificadoDigital.Model.frontDocumentBase64,core.Forms.data.frontImageName=CertificadoDigital.Model.frontDocument,core.Forms.data.rearImageBase64=CertificadoDigital.Model.rearDocumentBase64,core.Forms.data.rearImageName=CertificadoDigital.Model.rearDocument}}};$((()=>{document.addEventListener("coreInitialized",(function(e){administradorCore.init()}))}));