let comunidadesCore={comunidades:Object(),comunidad:Object(),iTotalDocumentos:0,iTotalDocumentosPendientes:0,iTotalDocumentosSubidos:0,init:async function(){this.events(),"list"==core.actionModel&&"comunidad"==core.model.toLowerCase()?await comunidadesCore.listadoDashboard():($(".titulo-modulo").length&&"Comunidad"==core.model&&(dpdCore.renderTabla(),empresaCore.renderTablaEmpresasComunidad(core.modelId),empleadoCore.renderTablaEmpleadosComunidad(core.modelId),documentalCore.Comunidad.renderTablaDocumentacionComunidad(core.modelId)),CoreUI.setTitulo("nombre"))},events:function(){"comunidad"==core.model.toLowerCase()&&$("body").on(core.helper.clickEventType,".btnSaveData",evt=>{evt.stopImmediatePropagation(),comunidadesCore.guardarComunidad()}),$("body").on(core.helper.clickEventType,".btnVerComunidad",evt=>{evt.stopImmediatePropagation(),comunidadesCore.verModalComunidad($(evt.currentTarget).attr("data-id"),$(evt.currentTarget).attr("data-nombre"))}),$("body").on(core.helper.clickEventType,".btnEliminarComunidad",evt=>{evt.stopImmediatePropagation(),comunidadesCore.eliminar($(evt.currentTarget).attr("data-id"),$(evt.currentTarget).attr("data-nombre"))}),$("body").on(core.helper.clickEventType,".btnConfirmarEmpresaCAE",(function(e){comunidadesCore.asignarEmpresa($(this).attr("data-id"))})),$("body").on(core.helper.clickEventType,".btnEliminarEmpresaComunidad",(function(e){comunidadesCore.eliminarEmpresaComunidad($(this).attr("data-id"),$(this).attr("data-nombre"))})),$("body").on(core.helper.clickEventType,".btnAsociarEmpresaCAE",(async function(e){comunidadesCore.mostrarModalAsociarEmpresa()})),$("body .form-comunidad #nombre").on("keyup",(function(e){CoreUI.Utils.setTituloPantalla(null,null,$(this).val()),$(".sidebar-item .comunidad-"+core.modelId).text(`${$(".form-comunidad #codigo").val()} - ${$(this).val()}`)})),$("body .form-comunidad #codigo").on("keyup",(function(e){$(".sidebar-item .comunidad-"+core.modelId).text(`${$(".form-comunidad #codigo").val()} - ${$(this).val()}`)}))},guardarComunidad:function(){core.Forms.Validate("form-comunidad")?(core.Forms.mapDataToSave(),serviciosCore.mapServiciosContratados(),core.Forms.Save(!0)):CoreUI.Modal.Error("Rellene los campos obligatorios para poder guardar la comunidad","Formulario incompleto")},eliminar:function(id,nombre){core.Modelo.Delete("comunidad",id,nombre,"listadoComunidades")},asignarEmpresa:async function(id){var existe=!1;if(core.Modelo.entity.Comunidad[0].view_empresascomunidad.length)for(y=0;y<core.Modelo.entity.Comunidad[0].view_empresascomunidad.length;y++)if(core.Modelo.entity.Comunidad[0].view_empresascomunidad[y].id==id){existe=!0;break}existe?CoreUI.Modal.Error("La empresa ya está asignada a esta comunidad",null,(function(){comunidadesCore.mostrarModalAsociarEmpresa()})):(datos=Object(),datos={idcomunidad:core.modelId,idempresa:id},await apiFincatech.post(`comunidad/${core.modelId}/empresa/${id}/asignar`,datos).then(async response=>{var responseData=JSON.parse(response);"ok"==responseData.status.response?(CoreUI.Modal.Success("La empresa se ha asignado correctamente. Los empleados aparecerán en el listado una vez que la empresa los asigne."),window.tablelistadoEmpresaComunidad.ajax.reload()):Modal.Error("No se ha podido registrar el documento por el siguiente motivo:<br><br>"+responseData.status.response)}))},eliminarEmpresaComunidad:async function(id,nombre){core.Modelo.Delete(`comunidad/${id}/empresa/${id}`,id,nombre,"listadoEmpresaComunidad","¿Desea eliminar la relación de la empresa con la comunidad?")},mostrarModalAsociarEmpresa:async function(){const{value:file}=await Swal.fire({title:"",html:Constantes.AsignacionEmpresa,showCancelButton:!1,showConfirmButton:!1,grow:"row",showCloseButton:!0,didOpen:function(e){empresaCore.renderTablaSimple()}})},verModalComunidad:async function(idComunidad){var infoComunidad;comunidadesCore.getComunidad(idComunidad).then(result=>{infoComunidad=result,apiFincatech.getView("modals","comunidades/modal_info").then(resultHTML=>{result=CoreUI.Utils.parse(resultHTML,comunidadesCore.comunidad),console.log(result),CoreUI.Modal.GetHTML("modalInfoComunidad",result,comunidadesCore.comunidad.nombre)})})},renderMenuLateral:async function(){$(".navComunidades").append('<li class="sidebar-header">Comunidades</li>'),comunidadesCore.comunidades.forEach((function(valor,indice,array){var html=`<li class="sidebar-item">\n                            <a class="sidebar-link" href="/fincatech/comunidad/${valor.id}">\n                                <div class="row">\n                                    <div class="col-2">\n                                        <img src="/fincatech/public/assets/img/icon_edificio.png" class="img-responsive feather">\n                                    </div>\n                                    <div class="col-10 pr-0">\n                                        <span class="align-middle comunidad-${valor.id}">${valor.codigo} - ${valor.nombre}</span>\n                                    </div>\n                                </div>\n                            </a>\n                        </li>`;$(".navComunidades").append(html)})),feather.replace()},renderTabla:async function(){if($("#listadoComunidad").length){CoreUI.tableData.init(),CoreUI.tableData.addColumnRow("listadoComunidad","documentacioncomunidad"),CoreUI.tableData.addColumn("listadoComunidad","codigo","COD"),CoreUI.tableData.addColumn("listadoComunidad","nombre","NOMBRE"),CoreUI.tableData.addColumn("listadoComunidad","usuario[0].nombre","Administrador");var html='<a href="mailto:data:emailcontacto$" class="pl-1 pr-1">data:emailcontacto$</a>';CoreUI.tableData.addColumn("listadoComunidad",null,"EMAIL",html),CoreUI.tableData.addColumn("listadoComunidad","telefono","TELEFONO"),CoreUI.tableData.addColumn("listadoComunidad",(function(row,type,val,meta){var claseAviso="text-success",iDocumentos=0;for(x=0;x<row.documentacioncomunidad.length;x++)null==row.documentacioncomunidad[x].idficherorequerimiento&&(iDocumentos++,claseAviso="text-danger");return`<p class="text-center m-0"><span class=" ${claseAviso}" style="font-size: 15px;"> ${iDocumentos}</span></p>`}),"doc pend. de subir",null,"text-center"),CoreUI.tableData.addColumn("listadoComunidad",(function(row,type,val,meta){var iDocumentos=0,iDocumentosTotal=0;for(x=0;x<row.documentacioncomunidad.length;x++)iDocumentosTotal++,null!=row.documentacioncomunidad[x].idficherorequerimiento&&iDocumentos++;return iDocumentosTotal==iDocumentos?'<p class="text-center m-0"><i class="bi bi-check2-square text-success" style="font-size:24px;"></i></p>':`<p class="text-center m-0"><span class="" style="font-size:15px;">${iDocumentos}</span></p>`}),"doc verificados",null,"text-center");var html="data:created$";CoreUI.tableData.addColumn("listadoComunidad",null,"Fecha alta",html);var html="data:estado$";CoreUI.tableData.addColumn("listadoComunidad",null,"Estado",html);var html='<ul class="nav justify-content-center accionesTabla">';html+=`<li class="nav-item"><a href="${baseURL}comunidad/data:id$" class="btnEditarComunidad d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="edit" class="text-success img-fluid"></i></a></li>`,html+='<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarComunidad d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="trash-2" class="text-danger img-fluid"></i></li></ul>',CoreUI.tableData.addColumn("listadoComunidad",null,"",html),$("#listadoComunidad").addClass("no-clicable"),CoreUI.tableData.render("listadoComunidad","Comunidad","comunidad/list")}},renderTablaComunidadesAdministrador:async function(id){if($("#listadoComunidadesAdministrador").length){CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoComunidadesAdministrador","codigo","COD"),CoreUI.tableData.addColumn("listadoComunidadesAdministrador","nombre","NOMBRE");var html='<a href="mailto:data:emailcontacto$" class="pl-1 pr-1">data:emailcontacto$</a>';CoreUI.tableData.addColumn("listadoComunidadesAdministrador",null,"EMAIL",html),CoreUI.tableData.addColumn("listadoComunidadesAdministrador","telefono","TELEFONO"),CoreUI.tableData.addColumn("listadoComunidadesAdministrador","nombre","doc pend. de subir"),CoreUI.tableData.addColumn("listadoComunidadesAdministrador","nombre","doc pend. de verificar");var html="data:created$";CoreUI.tableData.addColumn("listadoComunidadesAdministrador",null,"Fecha alta",html);var html="data:estado$";CoreUI.tableData.addColumn("listadoComunidadesAdministrador",null,"Estado",html),CoreUI.tableData.render("listadoComunidadesAdministrador","ComunidadesAdministrador",`administrador/${id}/comunidades`)}},renderTablaDocumentacion:async function(id){$("#listadoDocumentacionComunidad").length&&(CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoDocumentacionComunidad","requerimiento","Documento"),CoreUI.tableData.render("listadoDocumentacionComunidad","Comunidad[0].documentacioncomunidad",`comunidad/${id}`))},listadoDashboard:async function(){await comunidadesCore.getAll().then(async data=>{$(".statscomunidades .total").html(comunidadesCore.comunidades.total);var _iTotalDocumentos=0,_iTotalDocumentosPendientes=0,_iTotalDocumentosSubidos=0;if(comunidadesCore.comunidades.total>0)for(i=0;i<comunidadesCore.comunidades.length;i++)for(y=0;y<comunidadesCore.comunidades[i].documentacioncomunidad.length;y++)_iTotalDocumentos++,""==comunidadesCore.comunidades[i].documentacioncomunidad[y].idrelacion||null==comunidadesCore.comunidades[i].documentacioncomunidad[y].idrelacion?_iTotalDocumentosPendientes++:_iTotalDocumentosSubidos++;$(".totalDocumentosVerificados").text(_iTotalDocumentosSubidos),$(".totalDocumentosPendientes").text(_iTotalDocumentosPendientes),$(".totalDocumentos").text(_iTotalDocumentos),this.renderTabla()})},getComunidad:async function(comunidadId){await apiFincatech.get("comunidad/"+comunidadId).then(data=>(result=JSON.parse(data),responseStatus=result.status,responseData=result.data,comunidadesCore.comunidad=responseData.Comunidad[0],console.log(comunidadesCore.comunidad),comunidadesCore.comunidad))},getAll:async function(){await apiFincatech.get("comunidad/list").then(async data=>{result=JSON.parse(data),responseStatus=result.status,responseData=result.data,comunidadesCore.comunidades=responseData.Comunidad,comunidadesCore.comunidades.total=comunidadesCore.comunidades.length})},Import:{validacionPlantillaComunidades:function(){return!0},guardarComunidadDesdePlantilla(jsonExcel){var idAdministrador=$("#administradorCargaId option:selected").val(),porcentaje=0;for(x=0;x<jsonExcel.length;x++){var Comunidad={comunidadservicioscontratados:[]},infoServicio=new Object,infoServicio,infoServicio,infoServicio,infoServicio;Comunidad.codigo=jsonExcel[x].codigo,Comunidad.cif=jsonExcel[x].cif,Comunidad.codpostal=jsonExcel[x].codpostal,Comunidad.direccion=jsonExcel[x].direccion,Comunidad.nombre=jsonExcel[x].nombre,Comunidad.localidad=jsonExcel[x].localidad,Comunidad.presidente=jsonExcel[x].presidente,Comunidad.telefono=jsonExcel[x].telefono,Comunidad.emailcontacto=void 0===jsonExcel[x].emailcontacto?"":jsonExcel[x].emailcontacto,Comunidad.ibancomunidad=jsonExcel[x].ibancomunidad,Comunidad.usercreate=idAdministrador,Comunidad.usuarioId=idAdministrador,Comunidad.estado="A",infoServicio.idservicio=1,infoServicio.contratado=void 0===jsonExcel[x]["cae.contratado"]?0:jsonExcel[x]["cae.contratado"],infoServicio.precio=void 0===jsonExcel[x]["cae.pvp"]?0:jsonExcel[x]["cae.pvp"],infoServicio.preciocomunidad=void 0===jsonExcel[x]["cae.preciocomunidad"]?0:jsonExcel[x]["cae.preciocomunidad"],Comunidad.comunidadservicioscontratados.push(infoServicio),(infoServicio=new Object).idservicio=2,infoServicio.contratado=void 0===jsonExcel[x]["Rgpd.contratado"]?0:jsonExcel[x]["Rgpd.contratado"],infoServicio.precio=void 0===jsonExcel[x]["Rgpd.pvp"]?0:jsonExcel[x]["Rgpd.pvp"],infoServicio.preciocomunidad=void 0===jsonExcel[x]["Rgpd.preciocomunidad"]?0:jsonExcel[x]["Rgpd.preciocomunidad"],Comunidad.comunidadservicioscontratados.push(infoServicio),(infoServicio=new Object).idservicio=3,infoServicio.contratado=void 0===jsonExcel[x]["prl.contratado"]?0:jsonExcel[x]["prl.contratado"],infoServicio.precio=void 0===jsonExcel[x]["prl.pvp"]?0:jsonExcel[x]["prl.pvp"],infoServicio.preciocomunidad=void 0===jsonExcel[x]["prl.preciocomunidad"]?0:jsonExcel[x]["prl.preciocomunidad"],Comunidad.comunidadservicioscontratados.push(infoServicio),(infoServicio=new Object).idservicio=4,infoServicio.contratado=void 0===jsonExcel[x]["instalaciones.contratado"]?0:jsonExcel[x]["instalaciones.contratado"],infoServicio.precio=void 0===jsonExcel[x]["instalaciones.pvp"]?0:jsonExcel[x]["instalaciones.pvp"],infoServicio.preciocomunidad=void 0===jsonExcel[x]["instalaciones.preciocomunidad"]?0:jsonExcel[x]["instalaciones.preciocomunidad"],Comunidad.comunidadservicioscontratados.push(infoServicio),(infoServicio=new Object).idservicio=5,infoServicio.contratado=void 0===jsonExcel[x]["certificadosdigitales.contratado"]?0:jsonExcel[x]["certificadosdigitales.contratado"],infoServicio.precio=void 0===jsonExcel[x]["certificadosdigitales.pvp"]?0:jsonExcel[x]["certificadosdigitales.pvp"],infoServicio.preciocomunidad=void 0===jsonExcel[x]["certificadosdigitales.preciocomunidad"]?0:jsonExcel[x]["certificadosdigitales.preciocomunidad"],Comunidad.comunidadservicioscontratados.push(infoServicio),console.log(Comunidad),core.Modelo.Insert("comunidad",Comunidad,!1),porcentaje=(100*x/jsonExcel.length).toFixed(2),$(".wrapperProgresoCarga .progress-bar-striped").attr("aria-valuenow",`${porcentaje}%`),$(".wrapperProgresoCarga .progress-bar-striped").css("width",`${porcentaje}%`),$(".wrapperProgresoCarga .progress-bar-striped").html(`${porcentaje}%`),$(".wrapperProgresoCarga .progresoCarga").html(`(${x} de `+jsonExcel.length+")")}$(".wrapperProgresoCarga .progresoCarga").html("("+jsonExcel.length+" comunidad(es) importada(s))"),$(".btnCerrarProceso").show(),$(".wrapperProgresoCarga .progress-bar-striped").attr("aria-valuenow","100%"),$(".wrapperProgresoCarga .progress-bar-striped").css("width","100%"),$(".wrapperProgresoCarga .progress-bar-striped").html("100%")},leerPlantillaComunidades:function(xlsxflag){if("undefined"!=typeof FileReader){var readerExcel=new FileReader;readerExcel.onload=function(e){$(".wrapperProgresoCarga").show();var data=e.target.result;if(xlsxflag)var workbook=XLSX.read(data,{type:"binary"});else var workbook=XLS.read(data,{type:"binary"});var sheet_name_list=workbook.SheetNames,cnt=0;sheet_name_list.forEach((function(y){if(xlsxflag)var exceljson=XLSX.utils.sheet_to_json(workbook.Sheets[y]);else var exceljson=XLS.utils.sheet_to_row_object_array(workbook.Sheets[y]);$(".wrapperProgresoCarga .progress-bar").css("width","0%"),$(".wrapperProgresoCarga .progress-bar-striped").html("0%"),exceljson.length>0&&($(".wrapperProgresoCarga .progresoCarga").html("(0 de "+exceljson.length+")"),comunidadesCore.Import.guardarComunidadDesdePlantilla(exceljson))}))},xlsxflag?readerExcel.readAsArrayBuffer($("#ficheroAdjuntarExcel")[0].files[0]):readerExcel.readAsBinaryString($("#ficheroAdjuntarExcel")[0].files[0])}else alert("Sorry! Your browser does not support HTML5!")},importarComunidades:function(){if(!core.Files.isExcelFile("ficheroAdjuntarExcel"))return $(".wrapperMensajeErrorCarga .mensaje").html("El fichero no es válido. Seleccione un fichero de formato Excel (xls o xlsx)"),void $(".wrapperMensajeErrorCarga").show();if($(".wrapperMensajeErrorCarga").hide(),"-1"==$("#administradorCargaId option:selected").val())return $(".wrapperMensajeErrorCarga .mensaje").html("Debe seleccionar el administrador al que asignar las comunidades a importar"),void $(".wrapperMensajeErrorCarga").show();if(!comunidadesCore.Import.validacionPlantillaComunidades())return $(".wrapperMensajeErrorCarga .mensaje").html("El fichero no es válido. Utilice la plantilla de Fincatech."),void $(".wrapperMensajeErrorCarga").show();var xlsxflag=!1;$("#ficheroAdjuntarExcel").val().toLowerCase().indexOf(".xlsx")>0&&(xlsxflag=!0),$(".wrapperInformacion").hide(),$(".wrapperSelectorAdministrador").hide(),$(".wrapperSelectorFichero").hide(),$(".wrapperMensajeErrorCarga").hide(),comunidadesCore.Import.leerPlantillaComunidades(xlsxflag)}}};$(()=>{comunidadesCore.init()});