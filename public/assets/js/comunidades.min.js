let comunidadesCore={comunidades:Object(),comunidad:Object(),accessCae:!0,accessRgpd:!0,iTotalDocumentos:0,iTotalDocumentosPendientes:0,iTotalDocumentosSubidos:0,init:async function(){new Promise((async(a,e)=>{comunidadesCore.checkAccess(),a(!0)})).then((async a=>{if(comunidadesCore.events(),"list"==core.actionModel&&"comunidad"==core.model.toLowerCase()&&("SUDO"===core.Security.getRole()?comunidadesCore.Render.tablaListadoComunidades():await comunidadesCore.listadoDashboard()),"get"==core.actionModel&&"comunidad"==core.model.toLowerCase()){let a=`${core.Modelo.entity.Comunidad[0].codigo} - ${core.Modelo.entity.Comunidad[0].nombre}`;CoreUI.setTitulo(a),comunidadesCore.comprobarServiciosContratados()}"servicios-contratados"==core.actionModel&&(comunidadesCore.Render.paginacion.init(),comunidadesCore.Render.tablaServiciosContratadosComunidades()),$("#ibancomunidad").mask("SS00 0000 0000 00 0000000000"),"CONTRATISTA"==core.Security.getRole()&&$(".tabDatos").hide(),"SUDO"==core.Security.getRole()&&$(".tabDatos").show(),"add"==core.actionModel&&$(".tabDatos").show()}))},checkAccess:async function(){"comunidad"==core.model.toLowerCase()&&(comunidadesCore.accessCae=core.Security.userData.mostrarcae,comunidadesCore.accessRgpd=core.Security.userData.mostrarrgpd)},events:function(){$("body .form-comunidad").off(core.helper.clickEventType).on(core.helper.clickEventType,".btnSaveData",(a=>{a.stopImmediatePropagation(),comunidadesCore.guardarComunidad()})),$("body").on(core.helper.clickEventType,".btnVerComunidad",(a=>{a.stopImmediatePropagation(),comunidadesCore.verModalComunidad($(a.currentTarget).attr("data-id"),$(a.currentTarget).attr("data-nombre"))})),$("body").on(core.helper.clickEventType,".btnEliminarComunidad",(a=>{a.stopImmediatePropagation(),comunidadesCore.eliminar($(a.currentTarget).attr("data-id"),$(a.currentTarget).attr("data-nombre"))})),$("body").on(core.helper.clickEventType,".btnConfirmarEmpresaCAE",(function(a){comunidadesCore.asignarEmpresa($(this).attr("data-id"))})),$("body").on(core.helper.clickEventType,".btnEliminarEmpresaComunidad",(function(a){a.stopImmediatePropagation(),comunidadesCore.eliminarEmpresaComunidad($(this).attr("data-id"),$(this).attr("data-nombre"))})),$("body").on(core.helper.clickEventType,".btnAsociarEmpresaCAE",(function(a){window.tablelistadoEmpresaComunidad.data().length>=parseInt(core.Modelo.entity.Comunidad[0].limiteempresas)?CoreUI.Modal.Info(`Ha alcanzado el límite de asignación de empresas a una comunidad.<br>Si necesita asignar más de ${core.Modelo.entity.Comunidad[0].limiteempresas} empresas, por favor, póngase en contacto con nosotros.`):comunidadesCore.mostrarModalAsociarEmpresa()})),$("body .form-comunidad #nombre").on("keyup",(function(a){CoreUI.Utils.setTituloPantalla(null,null,`${$(".form-comunidad #codigo").val()} ${$(this).val()}`),$(".sidebar-item .comunidad-"+core.modelId).text(`${$(".form-comunidad #codigo").val()} ${$(this).val()}`)})),$("body .form-comunidad #codigo").on("keyup",(function(a){$(".sidebar-item .comunidad-"+core.modelId).text(`${$(this).val()} ${$(".form-comunidad #nombre").val()}`)})),$("body").on("blur","#ibancomunidad",(function(a){comunidadesCore.validarCuentaIBAN()})),$("body").on(core.helper.clickEventType,".enlaceDocumentacionComunidad",(function(a){documentalCore.Comunidad.renderTablaDocumentacionComunidad(core.modelId)})),$("body").on(core.helper.clickEventType,".enlaceKOCae",(function(a){CoreUI.Modal.Info("Actualmente no tiene contratado el servicio de CAE para esta comunidad.<br><br>Si desea contratarlo, por favor contacte con el departamento de administración de Fincatech o escriba a info@fincatech.es","Servicio no contratado")})),$("body").on(core.helper.clickEventType,".enlaceKORGPD",(function(a){CoreUI.Modal.Info("Actualmente no tiene contratado el servicio de RGPD para esta comunidad.<br><br>Si desea contratarlo, por favor contacte con el departamento de administración de Fincatech o escriba a info@fincatech.es","Servicio no contratado")})),$("body").on(core.helper.clickEventType,".enlaceKOCertificadoDigital",(function(a){CoreUI.Modal.Info("Actualmente no tiene contratado el servicio de Certificado Digital para esta comunidad.<br><br>Si desea contratarlo, por favor contacte con el departamento de administración de Fincatech o escriba a info@fincatech.es","Servicio no contratado")})),$("body").on(core.helper.clickEventType,"#chkTieneCamarasSeguridad",(function(a){var e=$(this).prop("checked")?1:0,o=Object();o.seleccionada=e,apiFincatech.post(`comunidad/${core.modelId}/camaraseguridad`,o).then((a=>{requerimientoCore.renderTablaCamarasSeguridad(core.modelId)}))})),$("body").on(core.helper.clickEventType,".btnAvisoEstado",(function(a){CoreUI.Modal.Info("En breve estará activada la comunidad","Comunidad pendiente activación")})),$("body").on(core.helper.clickEventType,".btnVerEmpleadosComunidad",(function(a){})),$("body").on(core.helper.clickEventType,".btnAdjuntarContrato",(async function(){documentalCore.idcomunidad=$(this).attr("data-idcomunidad"),documentalCore.idempresa=$(this).attr("data-idempresa"),documentalCore.idempleado=$(this).attr("data-idempleado"),documentalCore.idadministrador=$(this).attr("data-idadministrador"),documentalCore.idrequerimiento=$(this).attr("data-idrequerimiento"),documentalCore.idrelacionrequerimiento=$(this).attr("data-idrelacionrequerimiento"),documentalCore.entidad=$(this).attr("data-entidad");const{value:a}=await Swal.fire({title:"",html:Constantes.CargaDocumento,showCancelButton:!1,showConfirmButton:!1,showCloseButton:!0,didOpen:function(){core.Files.init()}})})),$("body").on(core.helper.clickEventType,".enlaceEmpresasExternas",(function(a){a.stopImmediatePropagation(),comunidadesCore.Render.tablaEmpresasConcurrentes()})),$("body").on(core.helper.clickEventType,"#tablaEmpresasConcurrentes tr",(function(){comunidadesCore.Render.tablaDocumentosEmpresaConcurrente($(this).attr("id"))})),$("#listadoComunidadesProveedores").length&&comunidadesCore.Render.tablaProveedores()},guardarComunidad:function(){if("ADMINFINCAS"!=core.Security.getRole()&&"SUDO"!=core.Security.getRole())return CoreUI.Modal.Error("Su tipo de usuario no tiene privilegios suficientes para poder modificar los datos de la comunidad","Permisos insuficientes"),!1;if(""!=$("#ibancomunidad").val()&&!comunidadesCore.validarCuentaIBAN())return CoreUI.Modal.Error("El código IBAN no es correcto. Por favor, revise el número proporcionado"),!1;if(core.Forms.Validate("form-comunidad")){if(core.Forms.mapDataToSave(),"ADMINFINCAS"!=core.Security.getRole()&&serviciosCore.mapServiciosContratados(),$("#chkServicioCae").length&&$("#chkServicioRGPD").length&&(core.Forms.data.servicioRGPD=$("#chkServicioRGPD").is(":checked")?1:0,core.Forms.data.servicioCAE=$("#chkServicioCae").is(":checked")?1:0),"ADMINFINCAS"==core.Security.getRole()&&0==core.Forms.data.servicioRGPD&&0==core.Forms.data.servicioCAE)return void CoreUI.Modal.Error("Debe seleccionar al menos un servicio para contratar","Alta de comunidad");core.Forms.Save(!0)}else CoreUI.Modal.Error("Rellene los campos obligatorios para poder guardar la comunidad","Formulario incompleto")},eliminar:function(a,e){core.Modelo.Delete("comunidad",a,e,"listadoComunidad")},validarCuentaIBAN:function(){var a=$("#ibancomunidad").unmask().val().trim();return $("#ibancomunidad").mask("SS00 0000 0000 00 0000000000"),core.Validator.checkIBAN(a)?($("body #ibancomunidad").css("border-color",""),!0):($("body #ibancomunidad").css("border-color","red"),!1)},asignarEmpresa:async function(a){var e=!1;if(core.Modelo.entity.Comunidad[0].empresascomunidad.length)for(y=0;y<core.Modelo.entity.Comunidad[0].empresascomunidad.length;y++)if(core.Modelo.entity.Comunidad[0].empresascomunidad[y].id==a){e=!0;break}e?CoreUI.Modal.Error("La empresa ya está asignada a esta comunidad",null,(function(){comunidadesCore.mostrarModalAsociarEmpresa()})):(datos=Object(),datos={idcomunidad:core.modelId,idempresa:a},await apiFincatech.post(`comunidad/${core.modelId}/empresa/${a}/asignar`,datos).then((async a=>{var e=JSON.parse(a);"ok"==e.status.response?(CoreUI.Modal.Success("La empresa se ha asignado correctamente y ha sido notificada mediante un e-mail para que indique que trabajador va a acceder a la comunidad."),window.tablelistadoEmpresaComunidad.ajax.reload()):Modal.Error("No se ha podido registrar el documento por el siguiente motivo:<br><br>"+e.status.response)})))},eliminarEmpresaComunidad:async function(a,e){core.Modelo.Delete(`comunidad/${core.modelId}/empresa`,a,e,"listadoEmpresaComunidad","¿Desea eliminar la relación de la empresa con la comunidad?").then((()=>{window.tablelistadoEmpresaComunidad.ajax.reload()}))},mostrarModalAsociarEmpresa:async function(){const{value:a}=await Swal.fire({title:"",html:Constantes.AsignacionEmpresa,showCancelButton:!1,showConfirmButton:!1,width:"75em",showCloseButton:!0,didOpen:function(a){}})},verModalComunidad:async function(a){comunidadesCore.getComunidad(a).then((a=>{a,apiFincatech.getView("modals","comunidades/modal_info").then((e=>{a=CoreUI.Utils.parse(e,comunidadesCore.comunidad),CoreUI.Modal.GetHTML("modalInfoComunidad",a,comunidadesCore.comunidad.nombre)}))}))},renderMenuLateral:async function(){apiFincatech.get("comunidad/listmenu").then((a=>{comunidadesCore.comunidades=JSON.parse(a),$(".sidebar-nav").html(""),$(".sidebar-nav").prepend('\n                <div class="row pl-3 pr-3 sticky-top" style="background: #222e3c;">\n                    <div class="col-12 pb-2 pt-2 mb-3 mt-2">\n                        <p class="text-uppercase mt-0 mb-1 text-white"><small><i class="bi bi-search pr-1"></i> Buscar comunidad</small></p>\n                        <div class="row">\n                            <div class="col-10 pr-0">\n                                <input type="text" class="form-control busquedaComunidad" placeholder="Escriba código o nombre" style="border-radius:12px;">\n                            </div>\n                            <div class="col-2 align-self-center">\n                                <a href="javascript:void(0);" class="btnLimpiarBusqueda"><i class="bi bi-x-circle text-white"></i></a>\n                            </div>\n                        </div>\n                    </div>\n                </div>'),comunidadesCore.comunidades.data.Comunidad.forEach((function(a,e,o){var i="P"==a.estado?"javascript:void(0);":`${config.baseURL}comunidad/${a.id}`,n="P"==a.estado?"btnAvisoEstado":"";if("H"!=a.estado){var t=`<li class="sidebar-item pl-3 pr-3 pb-2 pt-2" data-codigo="${a.codigo}" data-nombre="${a.nombre}">\n                                    <div class="row">\n                                        <div class="col-1 text-left pl-0 pr-0 align-self-center">\n                                           \x3c!-- <img src="${config.baseURL}public/assets/img/icon_edificio.png" class="img-responsive feather"> --\x3e\n                                           <i class="bi bi-building text-white"></i>\n                                        </div>\n\n                                        <div class="col-11 pr-2 pl-1">\n                                            <a href="${i}" class=" text-white d-block ${n}">   \n                                                <span class="align-middle comunidad-${a.id} d-block">${a.codigo} ${a.nombre}</span>\n                                            </a>\n                                        </div>\n\n                                        \x3c!--<div class="col-2 pr-0 text-center pl-0 align-self-center">\n                                            <a href="javascript:void(0);" class="btnEliminarComunidad" data-id="${a.id}" data-nombre="${a.nombre}">\n                                                <i data-feather="trash-2" class="text-danger"></i>\n                                            </a>\n                                        </div>--\x3e\n                                    </div>\n                            </li>`;$(".navComunidades").append(t)}$("body").on(core.helper.clickEventType,".btnLimpiarBusqueda",(function(a){$(".busquedaComunidad").val(""),CoreUI.Sidebar.Comunidades.buscarComunidad()})),$("body").on("keyup",".busquedaComunidad",(function(a){CoreUI.Sidebar.Comunidades.buscarComunidad()}))})),feather.replace()}))},renderTabla:async function(){if($("#listadoComunidad").length){CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoComunidad","codigo","COD",null,null,"120px"),CoreUI.tableData.addColumn("listadoComunidad","nombre","NOMBRE",null,null),1==core.Security.userData.mostrarcae&&CoreUI.tableData.addColumn("listadoComunidad",(function(a,e,o,i){var n="";return null==a.cumplimientocae?n='<p class="mb-0">No contratado</p>':(parseFloat(a.cumplimientocae)>=75?(bgcolor="success",border="success"):(bgcolor="warning",border="warning"),n=`\n                            <div class="mr-3 ml-3 border progress shadow-inset" style="background-color: white !important; border-radius: 8px;">\n                                <div class="progress-bar bg-${bgcolor}" role="progressbar" style="border:0 !important; width: ${a.cumplimientocae}%;" aria-valuenow="${a.cumplimientocae}" aria-valuemin="0" aria-valuemax="100"></div>\n                            </div> \n                            <p class="m-0 text-center"><small>${a.cumplimientocae}%</small></p>                   \n                            `),n}),"CUMP. CAE",null,"text-center","180px"),1==core.Security.userData.mostrarrgpd&&CoreUI.tableData.addColumn("listadoComunidad",(function(a,e,o,i){var n="";return null==a.cumplimientorgpd?n='<p class="mb-0">No contratado</p>':(parseFloat(a.cumplimientorgpd)>=75?(bgcolor="success",border="success"):(bgcolor="warning",border="warning"),n=`\n                            <div class="mr-3 ml-3 border progress shadow-inset" style="background-color: white !important;">\n                                <div class="progress-bar bg-${bgcolor}" role="progressbar" style="border:0 !important; width: ${a.cumplimientorgpd}%;" aria-valuenow="${a.cumplimientorgpd}" aria-valuemin="0" aria-valuemax="100"></div>\n                            </div> \n                            <p class="m-0 text-center"><small>${a.cumplimientorgpd}%</small></p>                   \n                            `),n}),"CUMP. RGPD",null,"text-center","180px");var a="data:estado$";CoreUI.tableData.addColumn("listadoComunidad",null,"Estado",a,"text-center","100px");a='<ul class="nav justify-content-center accionesTabla">';a+=`<li class="nav-item"><a href="${baseURL}comunidad/data:id$?view=1" class="btnEditarComunidad d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="edit" class="text-success img-fluid icono-accion" style="width:32px;height:32px;"></i></a></li>`,a+='<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarComunidad d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="trash-2" class="text-danger img-fluid icono-accion" style="width:26px;height:26px;"></i></li></ul>',CoreUI.tableData.addColumn("listadoComunidad",null,"",a,null,"60px"),CoreUI.tableData.render("listadoComunidad","Comunidad","comunidad/list",!1,!0,!0,null,!1,!1,null,!0)}},renderTablaComunidadesAdministrador:async function(a){if($("#listadoComunidadesAdministrador").length){CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoComunidadesAdministrador","codigo","COD"),CoreUI.tableData.addColumn("listadoComunidadesAdministrador","nombre","NOMBRE");var e='<a href="mailto:data:emailcontacto$" class="pl-1 pr-1">data:emailcontacto$</a>';CoreUI.tableData.addColumn("listadoComunidadesAdministrador",null,"EMAIL",e),CoreUI.tableData.addColumn("listadoComunidadesAdministrador","telefono","TELEFONO"),CoreUI.tableData.addColumn("listadoComunidadesAdministrador","ibancomunidad","Iban");e="data:created$";CoreUI.tableData.addColumn("listadoComunidadesAdministrador",null,"Fecha alta",e);e="data:estado$";CoreUI.tableData.addColumn("listadoComunidadesAdministrador",null,"Estado",e),CoreUI.tableData.render("listadoComunidadesAdministrador","ComunidadesAdministrador",`administrador/${a}/comunidades`)}},renderTablaDocumentacion:async function(a){$("#listadoDocumentacionComunidad").length&&(CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoDocumentacionComunidad","requerimiento","Documento"),CoreUI.tableData.render("listadoDocumentacionComunidad","Comunidad[0].documentacioncomunidad",`comunidad/${a}`))},listadoDashboard:async function(){this.renderTabla()},getComunidad:async function(a){await apiFincatech.get("comunidad/"+a).then((a=>(result=JSON.parse(a),responseStatus=result.status,responseData=result.data,comunidadesCore.comunidad=responseData.Comunidad[0],comunidadesCore.comunidad)))},getAll:async function(){await apiFincatech.get("comunidad/list").then((async a=>{result=JSON.parse(a),responseStatus=result.status,responseData=result.data,comunidadesCore.comunidades=responseData.Comunidad,comunidadesCore.comunidades.total=comunidadesCore.comunidades.length}))},comprobarContratoAdministradorComunidad:function(a,e){},comprobarServiciosContratados:function(){return;if(void 0!==core.Modelo.entity.Comunidad[0].comunidadservicioscontratados[0].contratado&&(caeContratado="0"!=core.Modelo.entity.Comunidad[0].comunidadservicioscontratados[0].contratado),void 0!==core.Modelo.entity.Comunidad[0].comunidadservicioscontratados[4].contratado&&(rgpdContratado="0"!=core.Modelo.entity.Comunidad[0].comunidadservicioscontratados[4].contratado),"CONTRATISTA"==core.Security.getRole()||"TECNICOCAE"==core.Security.getRole())return $(".enlaceRGPD").remove(),$(".btnAsociarEmpresaCAE").remove(),$(".empresasComunidadHeader").remove(),$(".wrapperEmpresasComunidad").remove(),void $(".wrapperEmpleadosEmpresaComunidad").remove();$(".enlaceCae").removeClass("text-success"),$(".enlaceCae").removeClass("text-danger"),!1===caeContratado?($(".enlaceCae").attr("href","#"),$(".enlaceCae").removeClass("enlaceCae").addClass("enlaceKOCae"),$(".enlaceKOCae").addClass("text-danger")):$(".enlaceCae").addClass("text-success"),$(".enlaceRGPD").removeClass("text-success"),$(".enlaceRGPD").removeClass("text-danger"),!1===rgpdContratado?($(".enlaceRGPD").attr("href","#"),$(".enlaceRGPD").removeClass("enlaceRGPD").addClass("enlaceKORGPD"),$(".enlaceKORGPD").addClass("text-danger")):$(".enlaceRGPD").addClass("text-success")},Import:{validacionPlantillaComunidades:function(){return!0},guardarComunidadDesdePlantilla:async function(a){var e=$("#administradorCargaId option:selected").val(),o=0;for(x=0;x<a.length;x++){var i={comunidadservicioscontratados:[]},n=new Object;i.codigo=a[x].codigo,i.cif=a[x].cif,i.codpostal=a[x].codpostal,i.direccion=a[x].direccion,i.nombre=a[x].nombre,i.localidad=a[x].localidad,i.provincia=a[x].provincia,i.presidente=a[x].presidente,i.telefono=a[x].telefono,i.emailcontacto=void 0===a[x].emailcontacto?"":a[x].emailcontacto,i.ibancomunidad=a[x].ibancomunidad,i.usercreate=e,i.usuarioId=e,i.importacion=1,i.estado="A",n.idservicio=1,n.contratado=void 0===a[x]["cae.contratado"]?0:a[x]["cae.contratado"],n.precio=0,void 0!==a[x]["cae.coste"]&&(n.precio=a[x]["cae.coste"]),void 0!==a[x]["cae.pvp"]&&(n.precio=a[x]["cae.pvp"]),n.preciocomunidad=void 0===a[x]["cae.preciocomunidad"]?0:a[x]["cae.preciocomunidad"],n.mesfacturacion=void 0===a[x]["cae.mesfacturacion"]?0:a[x]["cae.mesfacturacion"],i.comunidadservicioscontratados.push(n),(n=new Object).idservicio=2,n.contratado=void 0===a[x]["Rgpd.contratado"]?0:a[x]["Rgpd.contratado"],n.precio=0,void 0!==a[x]["Rgpd.coste"]&&(n.precio=a[x]["Rgpd.coste"]),void 0!==a[x]["Rgpd.pvp"]&&(n.precio=a[x]["Rgpd.pvp"]),n.preciocomunidad=void 0===a[x]["Rgpd.preciocomunidad"]?0:a[x]["Rgpd.preciocomunidad"],n.mesfacturacion=void 0===a[x]["Rgpd.mesfacturacion"]?0:a[x]["Rgpd.mesfacturacion"],i.comunidadservicioscontratados.push(n),(n=new Object).idservicio=3,n.contratado=0,void 0!==a[x]["doccae.contratado"]&&(n.contratado=a[x]["doccae.contratado"]),void 0!==a[x]["prl.contratado"]&&(n.contratado=a[x]["prl.contratado"]),n.precio=0,void 0!==a[x]["doccae.coste"]&&(n.precio=a[x]["doccae.coste"]),void 0!==a[x]["doccae.pvp"]&&(n.precio=a[x]["doccae.pvp"]),void 0!==a[x]["prl.coste"]&&(n.precio=a[x]["prl.coste"]),void 0!==a[x]["prl.pvp"]&&(n.precio=a[x]["prl.pvp"]),n.preciocomunidad=0,void 0!==a[x]["prl.preciocomunidad"]&&(n.preciocomunidad=a[x]["prl.preciocomunidad"]),void 0!==a[x]["doccae.preciocomunidad"]&&(n.preciocomunidad=a[x]["doccae.preciocomunidad"]),n.mesfacturacion=0,void 0!==a[x]["prl.mesfacturacion"]&&(n.mesfacturacion=a[x]["prl.mesfacturacion"]),void 0!==a[x]["doccae.mesfacturacion"]&&(n.mesfacturacion=a[x]["doccae.mesfacturacion"]),i.comunidadservicioscontratados.push(n),(n=new Object).idservicio=4,n.contratado=void 0===a[x]["instalaciones.contratado"]?0:a[x]["instalaciones.contratado"],n.precio=0,void 0!==a[x]["instalaciones.coste"]&&(n.precio=a[x]["instalaciones.coste"]),void 0!==a[x]["instalaciones.pvp"]&&(n.precio=a[x]["instalaciones.pvp"]),n.preciocomunidad=void 0===a[x]["instalaciones.preciocomunidad"]?0:a[x]["instalaciones.preciocomunidad"],n.mesfacturacion=void 0===a[x]["instalaciones.mesfacturacion"]?0:a[x]["instalaciones.mesfacturacion"],i.comunidadservicioscontratados.push(n),(n=new Object).idservicio=5,n.contratado=void 0===a[x]["certificadosdigitales.contratado"]?0:a[x]["certificadosdigitales.contratado"],n.precio=0,void 0!==a[x]["certificadosdigitales.coste"]&&(n.precio=a[x]["certificadosdigitales.coste"]),void 0!==a[x]["certificadosdigitales.pvp"]&&(n.precio=a[x]["certificadosdigitales.pvp"]),n.preciocomunidad=void 0===a[x]["certificadosdigitales.preciocomunidad"]?0:a[x]["certificadosdigitales.preciocomunidad"],n.mesfacturacion=void 0===a[x]["certificadosdigitales.mesfacturacion"]?0:a[x]["certificadosdigitales.mesfacturacion"],i.comunidadservicioscontratados.push(n),$(".importacionComunidad").html(`${i.codigo} - ${i.nombre}`),await core.Modelo.Insert("comunidad",i,!1,"",!1,!1),o=(100*x/a.length).toFixed(2),$(".wrapperProgresoCarga .progress-bar-striped").attr("aria-valuenow",`${o}%`),$(".wrapperProgresoCarga .progress-bar-striped").css("width",`${o}%`),$(".wrapperProgresoCarga .progress-bar-striped").html(`${o}%`),$(".wrapperProgresoCarga .progresoCarga").html(`(${x} de `+a.length+")")}$(".wrapperProgresoCarga .progresoCarga").html(a.length+" comunidad(es) importada(s)"),$(".importacionComunidad").hide(),$(".btnCerrarProceso").show(),$(".wrapperProgresoCarga .progress-bar-striped").attr("aria-valuenow","100%"),$(".wrapperProgresoCarga .progress-bar-striped").css("width","100%"),$(".wrapperProgresoCarga .progress-bar-striped").html("100%")},leerPlantillaComunidades:function(a){if("undefined"!=typeof FileReader){var e=new FileReader;e.onload=function(e){$(".wrapperProgresoCarga").show();var o=e.target.result;if(a)var i=XLSX.read(o,{type:"binary"});else i=XLS.read(o,{type:"binary"});var n=i.SheetNames;n.forEach((function(e){if(a)var o=XLSX.utils.sheet_to_json(i.Sheets[e]);else o=XLS.utils.sheet_to_row_object_array(i.Sheets[e]);$(".wrapperProgresoCarga .progress-bar").css("width","0%"),$(".wrapperProgresoCarga .progress-bar-striped").html("0%"),o.length>0&&($(".wrapperProgresoCarga .progresoCarga").html("(0 de "+o.length+")"),comunidadesCore.Import.guardarComunidadDesdePlantilla(o))}))},a?e.readAsArrayBuffer($("#ficheroAdjuntarExcel")[0].files[0]):e.readAsBinaryString($("#ficheroAdjuntarExcel")[0].files[0])}else alert("Sorry! Your browser does not support HTML5!")},importarComunidades:function(){if(!core.Files.isExcelFile("ficheroAdjuntarExcel"))return $(".wrapperMensajeErrorCarga .mensaje").html("El fichero no es válido. Seleccione un fichero de formato Excel (xls o xlsx)"),void $(".wrapperMensajeErrorCarga").show();if($(".wrapperMensajeErrorCarga").hide(),"-1"==$("#administradorCargaId option:selected").val())return $(".wrapperMensajeErrorCarga .mensaje").html("Debe seleccionar el administrador al que asignar las comunidades a importar"),void $(".wrapperMensajeErrorCarga").show();if(!comunidadesCore.Import.validacionPlantillaComunidades())return $(".wrapperMensajeErrorCarga .mensaje").html("El fichero no es válido. Utilice la plantilla de Fincatech."),void $(".wrapperMensajeErrorCarga").show();var a=!1;$("#ficheroAdjuntarExcel").val().toLowerCase().indexOf(".xlsx")>0&&(a=!0),$(".wrapperInformacion").hide(),$(".wrapperSelectorAdministrador").hide(),$(".wrapperSelectorFichero").hide(),$(".wrapperMensajeErrorCarga").hide(),$(".importacionAdministrador").html($("#administradorCargaId option:selected").text()),comunidadesCore.Import.leerPlantillaComunidades(a)}},Render:{pagina:0,nResultados:15,inicio:0,final:15,totalResultados:0,numeroPaginas:0,paginacion:{init:function(){$("body").on(core.helper.clickEventType,".btnPage",(function(){comunidadesCore.Render.pagina=$(this).attr("data-page"),comunidadesCore.Render.inicio=parseInt(comunidadesCore.Render.pagina-1)*parseInt(comunidadesCore.Render.nResultados),comunidadesCore.Render.final=comunidadesCore.Render.nResultados,comunidadesCore.Render.tablaServiciosContratadosComunidades()})),$("body").on(core.helper.clickEventType,".btnAnterior",(function(){comunidadesCore.Render.pagina-1!=0&&(comunidadesCore.Render.pagina--,comunidadesCore.Render.inicio=parseInt(comunidadesCore.Render.pagina-1)*parseInt(comunidadesCore.Render.nResultados),comunidadesCore.Render.final=comunidadesCore.Render.nResultados,comunidadesCore.Render.tablaServiciosContratadosComunidades())})),$("body").on(core.helper.clickEventType,".btnSiguiente",(function(){comunidadesCore.Render.pagina+1>comunidadesCore.Render.numeroPaginas||(comunidadesCore.Render.pagina++,comunidadesCore.Render.inicio=parseInt(comunidadesCore.Render.pagina-1)*parseInt(comunidadesCore.Render.nResultados),comunidadesCore.Render.final=comunidadesCore.Render.nResultados,comunidadesCore.Render.tablaServiciosContratadosComunidades())})),$("body").on("keyup","#search",(function(){comunidadesCore.Render.tablaServiciosContratadosComunidades()}))},construct:function(){var a=comunidadesCore.Render.numeroPaginas,e=comunidadesCore.Render.pagina,o="";$(".pagination").html(""),e>0&&(o='\n                            <li class="page-item">\n                                <a class="page-link btnPage" data-page="1" href="javascript:void(0);">1</a>\n                            </li>   \n                            <li class="page-item disabled">\n                                <a class="page-link btnPage" data-page="1" href="javascript:void(0);">...</a>\n                            </li>                                                    \n                            ');for(var i="",n=1;n<7;n++){4==n&&(i+=`\n                            <li class="page-item disabled">\n                                <a class="page-link btnPage bg-primary text-white shadow-neumorphic" href="javascript:void(0);">${0==e?1:e}</a>\n                            </li>`);var t=parseInt(e)+parseInt(n);t<a&&t!=a&&(i+=`\n                                <li class="page-item">\n                                    <a class="page-link btnPage" data-page="${t}" href="javascript:void(0);">${t}</a>\n                                </li>`)}var d=`\n                <li class="page-item lnkAnterior">\n                    <a class="page-link btnAnterior" href="javascript:void(0);">Anterior</a>\n                </li> ${o+=`\n                ${i}\n                    <li class="page-item disabled">\n                        <a class="page-link btnPage" data-page="1" href="javascript:void(0);">...</a>\n                    </li>                \n                    <li class="page-item">\n                        <a class="page-link btnPage" data-page="${a}" href="javascript:void(0);">${a}</a>\n                    </li>`}  \n                <li class="page-item lnkSiguiente">\n                    <a class="page-link btnSiguiente" href="javascript:void(0);">Siguiente</a>\n                </li>`;$(".pagination").html(d)},anterior:function(){},siguiente:function(){}},tablaListadoComunidadesInfoProgreso:function(){if($("#listadoComunidad").length){CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoComunidad","codigo","COD",null,null,"40px"),CoreUI.tableData.addColumn("listadoComunidad","nombre","NOMBRE",null,null,"40%"),"SUDO"==core.Security.getRole()&&(CoreUI.tableData.addColumn("listadoComunidad","administrador","Administrador"),CoreUI.tableData.addColumn("listadoComunidad","telefono","TELEFONO")),CoreUI.tableData.addColumn("listadoComunidad",(function(a,e,o,i){var n="";return null==a.cumplimientocae?n='<p class="mb-0">No contratado</p>':("100"==a.cumplimientocae?bgcolor="success":bgcolor="warning",n=`\n                            <div class="mr-3 ml-3 progress shadow-inset" style="background-color: white !important;">\n                                <div class="progress-bar bg-${bgcolor}" role="progressbar" style="border:0 !important; width: ${a.cumplimientocae}%;" aria-valuenow="${a.cumplimientocae}" aria-valuemin="0" aria-valuemax="100"></div>\n                            </div> \n                            <p class="m-0 text-center"><small>${a.cumplimientocae}%</small></p>                   \n                            `),n}),"CUMP. CAE",null,"text-center"),CoreUI.tableData.addColumn("listadoComunidad",(function(a,e,o,i){var n="";return null==a.cumplimientorgpd?n='<p class="mb-0">No contratado</p>':("100"==a.cumplimientorgpd?bgcolor="success":bgcolor="warning",n=`\n                            <div class="mr-3 ml-3 progress shadow-inset" style="background-color: white !important;">\n                                <div class="progress-bar bg-${bgcolor}" role="progressbar" style="border:0 !important; width: ${a.cumplimientorgpd}%;" aria-valuenow="${a.cumplimientorgpd}" aria-valuemin="0" aria-valuemax="100"></div>\n                            </div> \n                            <p class="m-0 text-center"><small>${a.cumplimientorgpd}%</small></p>                   \n                            `),n}),"CUMP. RGPD",null,"text-center");var a="data:estado$";CoreUI.tableData.addColumn("listadoComunidad","estado","Estado",a,null,"80px");a='<ul class="nav justify-content-center accionesTabla">';a+=`<li class="nav-item"><a href="${baseURL}comunidad/data:id$?view=1" class="btnEditarComunidad d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="edit" class="text-success img-fluid icono-accion" style="width:32px;height:32px;"></i></a></li>`,a+='<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarComunidad d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="trash-2" class="text-danger img-fluid icono-accion" style="width:26px;height:26px;"></i></li></ul>',CoreUI.tableData.addColumn("listadoComunidad",null,"",a),CoreUI.tableData.render("listadoComunidad","Comunidad","comunidad/list")}},tablaListadoComunidadesPendientes:function(){if($("#listadoComunidadesPendientes").length){let e="comunidad/list?status=P";CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoComunidadesPendientes","codigo","COD",null,null,"40px"),CoreUI.tableData.addColumn("listadoComunidadesPendientes","nombre","NOMBRE",null,null,"40%");var a="data:usuario.nombre$";CoreUI.tableData.addColumn("listadoComunidadesPendientes","administrador","Administrador",a);a="data:created$";CoreUI.tableData.addColumn("listadoComunidadesPendientes","created","Fecha alta",a);a='<ul class="nav justify-content-center accionesTabla">';a+=`<li class="nav-item"><a href="${baseURL}comunidad/data:id$?view=1" class="btnEditarComunidad d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="edit" class="text-success img-fluid pr-2" style="width:32px;height:32px;"></i></a></li>`,CoreUI.tableData.addColumn("listadoComunidadesPendientes",null,"",a),CoreUI.tableData.render("listadoComunidadesPendientes","Comunidad",e,!1,!0,!1,null,!1,!1,null,!1)}},tablaListadoComunidades:function(a=""){if($("#listadoComunidad").length){let o="comunidad/list"+(""!==a?"?status="+a:"");CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoComunidad","codigo","COD",null,null,"40px",null),CoreUI.tableData.addColumn("listadoComunidad","nombre","NOMBRE",null,null,"40%"),"SUDO"==core.Security.getRole()&&CoreUI.tableData.addColumn("listadoComunidad","cif","CIF/NIF",null,null,"10%");var e="data:usuario.nombre$";CoreUI.tableData.addColumn("listadoComunidad","administrador","Administrador",e);e="data:created$";CoreUI.tableData.addColumn("listadoComunidad","created","Fecha alta",e);e="data:estado$";CoreUI.tableData.addColumn("listadoComunidad","estado","Estado",e,null,"80px");e='<ul class="nav justify-content-center accionesTabla">';e+=`<li class="nav-item"><a href="${baseURL}comunidad/data:id$?view=1" class="btnEditarComunidad d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="edit" class="text-success img-fluid icono-accion" style="width:32px;height:32px;"></i></a></li>`,e+='<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarComunidad d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="trash-2" class="text-danger img-fluid icono-accion" style="width:26px;height:26px;"></i></li></ul>',CoreUI.tableData.addColumn("listadoComunidad",null,"",e),CoreUI.tableData.render("listadoComunidad","Comunidad",o,!1,!0,!0,null,!1,!1,null,!0)}},tablaServiciosContratadosComunidades:async function(){if($("#listadoServiciosContratadosComunidades").length){$("#listadoServiciosContratadosComunidades thead").html(""),$("#listadoServiciosContratadosComunidades tbody").html("");$("#listadoServiciosContratadosComunidades thead").html('\n                <tr class="align-middle text-center font-weight-light">\n                    <th class="font-weight-light">Código</th>\n                    <th class="font-weight-light" style="min-width:300px;">Comunidad</th>\n                    <th class="font-weight-light">Administrador</th>\n                    <th class="pl-3 pr-3">CAE</th>\n                        <th class="font-weight-light pl-3 pr-3">Mes Facturación</th>\n                        <th class="font-weight-light pl-3 pr-3">Precio</th>\n                        <th class="font-weight-light pl-3 pr-3">Precio comunidad</th>\n                    <th class="pl-3 pr-3">RGPD</th>\n                        <th class="font-weight-light pl-3 pr-3">Mes Facturación</th>\n                        <th class="font-weight-light pl-3 pr-3">Precio</th>\n                        <th class="font-weight-light pl-3 pr-3">Precio comunidad</th>\n                    <th class="pl-3 pr-3">Certificados digitales</th>\n                        <th class="font-weight-light pl-3 pr-3">Mes Facturación</th>\n                        <th class="font-weight-light pl-3 pr-3">Precio</th>\n                        <th class="font-weight-light pl-3 pr-3">Precio comunidad</th>\n                    <th class="pl-3 pr-3">PRL</th>\n                        <th class="font-weight-light pl-3 pr-3">Mes Facturación</th>\n                        <th class="font-weight-light pl-3 pr-3">Precio</th>\n                        <th class="font-weight-light pl-3 pr-3">Precio comunidad</th>\n                    <th class="pl-3 pr-3">Instalaciones</th>\n                        <th class="font-weight-light pl-3 pr-3">Mes Facturación</th>                    \n                        <th class="font-weight-light pl-3 pr-3">Precio</th>\n                        <th class="font-weight-light pl-3 pr-3">Precio comunidad</th>\n                </tr>');var a="comunidad/servicioscontratados/list?start="+comunidadesCore.Render.inicio+"&length="+comunidadesCore.Render.final+"&search="+$("#search").val();apiFincatech.get(a).then((a=>{var e=JSON.parse(a);e=e.data,comunidadesCore.Render.totalResultados=e.total,comunidadesCore.Render.numeroPaginas=parseInt(comunidadesCore.Render.totalResultados/comunidadesCore.Render.nResultados)+1;for(var o=0;o<e.Comunidad.length;o++){var i,n=e.Comunidad[o],t=1==n.cae_contratado?' checked="checked" ':"",d=1==n.rgpd_contratado?' checked="checked" ':"",r=1==n.prl_contratado?' checked="checked" ':"",s=1==n["certificados digitales_contratado"]?' checked="checked" ':"",c=1==n.instalaciones_contratado?' checked="checked" ':"";i=`\n                        <tr class="bg-white servicios-comunidad-${n.id}" data-idcomunidad="${n.id}">\n                            <td class="bg-white text-center pl-3 pr-3">\n                                <p>${n.codigo}</p>\n                            </td>\n                            <td class="bg-white pl-3 pr-3">\n                                <p>${n.comunidad}</p>\n                            </td>\n                            <td class="bg-white pl-3 pr-3">\n                                <p>${n.administrador}</p>\n                            </td>\n\n                        \x3c!-- CAE --\x3e\n\n                            ${serviciosCore.Render.ServiceInfo("cae",n.cae,t,n.id,n.cae_idtiposervicio,n.cae_mesfacturacion,n.cae_precio,n.cae_preciocomunidad)}\n\n                        \x3c!-- RGPD Contratado --\x3e\n\n                            ${serviciosCore.Render.ServiceInfo("rgpd",n.rgpd,d,n.id,n.rgpd_idtiposervicio,n.rgpd_mesfacturacion,n.rgpd_precio,n.rgpd_preciocomunidad)}\n\n                        \x3c!-- Certificados digitales --\x3e\n\n                            ${serviciosCore.Render.ServiceInfo("certificados",n["certificados digitales"],s,n.id,n["certificados digitales_idtiposervicio"],n["certificados digitales_mesfacturacion"],n["certificados digitales_precio"],n["certificados digitales_preciocomunidad"])}\n\n                        \x3c!-- PRL --\x3e\n\n                            ${serviciosCore.Render.ServiceInfo("prl",n.prl,r,n.id,n.prl_idtiposervicio,n.prl_mesfacturacion,n.prl_precio,n.prl_preciocomunidad)}\n\n                        \x3c!-- Instalaciones --\x3e\n\n                            ${serviciosCore.Render.ServiceInfo("instalaciones",n.instalaciones,c,n.id,n.instalaciones_idtiposervicio,n.instalaciones_mesfacturacion,n.instalaciones_precio,n.instalaciones_preciocomunidad)}\n\n                        `,$("#listadoServiciosContratadosComunidades tbody").append(i),comunidadesCore.Render.paginacion.construct()}$(".servicio-mesfacturacion").each((function(){let a=$(this).children("option:selected").val();$(this).select2({theme:"bootstrap4"}),$(this).val(a).trigger("change")}))}))}},tablaEmpresasConcurrentes:function(){CoreUI.tableData.init(),CoreUI.tableData.addColumn("tablaEmpresasConcurrentes","razonsocial","Empresa",null,null,"40%"),CoreUI.tableData.addColumn("tablaEmpresasConcurrentes","telefono","Teléfono",null,null,"40px"),CoreUI.tableData.addColumn("tablaEmpresasConcurrentes","email","E-mail"),CoreUI.tableData.addColumn("tablaEmpresasConcurrentes","personacontacto","Persona de contacto"),CoreUI.tableData.render("tablaEmpresasConcurrentes","empresascomunidad",`comunidad/${core.modelId}/empresas`,!1,!1,!1,null,!1,!1,null,!1)},tablaDocumentosEmpresaConcurrente:async function(a){if($("#tablaCAEEmpresasConcurrentes").length){var e=window.tabletablaEmpresasConcurrentes.row(a).data().razonsocial;$(".empresaConcurrenteNombre").text(e);a=window.tabletablaEmpresasConcurrentes.row(a).data().idusuario;CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("tablaCAEEmpresasConcurrentes","requerimiento","Requerimiento",null,"text-left"),CoreUI.tableData.addColumn("tablaCAEEmpresasConcurrentes",(function(a,e,o,i){return""!=a.fechasubida&&"null"!=a.fechasubida&&a.fechasubida?'<p class="mb-0 text-center">'+moment(a.fechasubida).locale("es").format("L")+"</p>":"No se ha realizado ninguna actuación"}),"Fecha última actuación",null,"text-center"),CoreUI.tableData.addColumn("tablaCAEEmpresasConcurrentes",(function(a,e,o,i){var n,t=a.idestado;switch(t=t?parseInt(t):1){case 1:n="no adjuntado";break;case 2:n="no descargado";break;case 3:n="no verificado";break;case 4:n="verificado";break;case 5:n="descargado";break;case 6:n="verificado";break;case 7:n="rechazado";break}return CoreUI.Utils.renderLabelByEstado(n)}),"Estado",null,"text-center"),CoreUI.tableData.addColumn("tablaCAEEmpresasConcurrentes",(function(a,e,o,i){var n=!1,t="";("CONTRATISTA"==core.Security.getRole()&&(n=!0),ficheroAdjuntado=!!a.idficherorequerimiento,ficheroAdjuntado)&&(t+=` <td class="text-center">\n                                            <a href="${config.baseURL+"public/storage/"+a.storageficherorequerimiento}" target="_blank" title="Ver documento">\n                                                <i class="bi bi-cloud-arrow-down text-primary mr-1" style="font-size: 30px;"></i>\n                                            </a>\n                                        </td>`);null==a.idempresa||a.idempresa;return ficheroAdjuntado||n||(t+="<td>&nbsp;</td>"),t}),"&nbsp;",null,"text-center");var o=new Array(10,11,12);CoreUI.tableData.render("tablaCAEEmpresasConcurrentes","documentacioncae",`empresa/${a}/documentacion`,null,!1,!1),window.tabletablaCAEEmpresasConcurrentes.on("draw",(function(){$("#tablaCAEEmpresasConcurrentes tbody tr").each((function(){if(void 0!==window.tabletablaCAEEmpresasConcurrentes.row($(this).attr("id")).data()){var a=window.tabletablaCAEEmpresasConcurrentes.row($(this).attr("id")).data().idrequerimiento;o.indexOf(parseInt(a))<0&&$(this).remove()}}))}))}},tablaProveedores:function(){$("#listadoComunidadesProveedores").length&&(CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn("listadoComunidadesProveedores","codigocomunidad","CÓD",null,"text-left","30px"),CoreUI.tableData.addColumn("listadoComunidadesProveedores","comunidad","Comunidad",null,"text-left"),CoreUI.tableData.addColumn("listadoComunidadesProveedores","empresa","Proveedor Asignado",null,"text-left"),CoreUI.tableData.addColumn("listadoComunidadesProveedores","email","E-mail",null,"text-left"),CoreUI.tableData.render("listadoComunidadesProveedores","proveedores","comunidad/proveedoresasignados/list",!1,!0,!0,null,!0,!0,"comunidad",!1,"GET",!0,!0).then((()=>{window.tablelistadoComunidadesProveedores.table(0).columns(0).visible(!1),window.tablelistadoComunidadesProveedores.table(0).columns(1).visible(!1)})),$("#listadoComunidadesProveedores").show())}}};function sleep(a){return new Promise((e=>setTimeout(e,a)))}document.addEventListener("coreInitialized",(function(a){comunidadesCore.renderTablaComunidadesAdministrador(core.modelId),comunidadesCore.events()})),document.addEventListener("modelLoaded",(function(a){if(comunidadesCore.init(),"get"==core.actionModel&&"comunidad"==core.model.toLowerCase()){let a=`${core.Modelo.entity.Comunidad[0].codigo} - ${core.Modelo.entity.Comunidad[0].nombre}`;CoreUI.Utils.setTituloPantalla(null,null,a)}}));