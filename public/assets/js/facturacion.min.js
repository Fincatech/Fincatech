let facturacion={Init:function(){facturacion.Events(),"liquidaciones"==core.model.toLowerCase()&&facturacion.Liquidaciones.Init()},Events:function(){$("#iban").length&&($("#iban").mask("SS00 0000 0000 00 0000000000"),$("#iban").on("blur",(function(a){$("#iban").val().length>0&&(core.Validator.checkIBAN($("#iban").val())||(a.stopImmediatePropagation(),CoreUI.Modal.Error("El código IBAN no es correcto. Por favor, revíselo.")))}))),$("body").on(core.helper.clickEventType,".btnGenerarInformePrefacturacion",(function(){facturacion.Prefacturacion.generarInformePrefacturacion()})),facturacion.Bank.Events(),facturacion.Remesa.Events()},Bank:{Events:function(){$("#bancoRemesa").on("change",(function(a){new Promise((async(a,t)=>{await facturacion.Bank.Controller.Get($("#bancoRemesa option:selected").val()),a(!0)})).then((()=>{let a=facturacion.Bank.Model.Bank.nombre,t=null==facturacion.Bank.Model.Bank.iban?"No establecido":facturacion.Bank.Model.Bank.iban,e=null==facturacion.Bank.Model.Bank.creditorid?"No establecido":facturacion.Bank.Model.Bank.creditorid;$(".info-banco").html(`${a}`),$(".info-iban").html(`${t}`),$(".info-creditorid").html(`${e}`)}))}))},Controller:{Get:async function(a){await apiFincatech.get(`bank/${a}`).then((a=>{let t=JSON.parse(a);facturacion.Bank.Model.Bank=t.data.Bank[0],facturacion.Bank.Model.CuentaAsociada=null!==facturacion.Bank.Model.Bank.iban}))}},Model:{Bank:null,CuentaAsociada:!1},View:{}},Facturacion:{Constants:{ESTADO_FACTURADO:"F",ESTADO_PENDIENTE_FACTURACION:"P",ESTADO_FACTURAS_DEVUELTAS:"D"},Events:function(){"emision"==core.actionModel&&core.Forms.initializeSelectData(),$(".stats-facturacion-anual").length&&facturacion.Facturacion.Controller.LoadStatsDashboard(),facturacion.Facturacion.Controller.RenderList(),$("body .form-banco").off(core.helper.clickEventType).on(core.helper.clickEventType,".btnSaveData",(a=>{a.stopImmediatePropagation(),facturacion.Facturacion.Controller.Bank.Save()})),$("body").on(core.helper.clickEventType,".btnEliminarBanco",(function(a){let t=$(this).attr("data-nombre"),e=$(this).attr("data-id");facturacion.Facturacion.Controller.Bank.Delete(e,t)})),$("body").on(core.helper.clickEventType,".btnGenerarFactura",(function(a){facturacion.Facturacion.Controller.GenerarFacturacion()})),$("#mesFacturacion").on("change",(function(a){$(".mes-facturacion").html($("#mesFacturacion option:selected").text()),facturacion.Facturacion.Controller.InfoFacturacion()})),$("#usuarioId").on("change",(function(a){if("Facturacion"!==core.model)return;let t=$("#usuarioId option:selected").val(),e="Ninguno";parseInt(t)>0&&(e=$("#usuarioId option:selected").text()),$(".administrador-seleccionado").html(e),facturacion.Facturacion.Controller.InfoFacturacion()})),$(".chkServicio").on("change",(function(a){$(this).is(":checked")?facturacion.Facturacion.View.AddServicioToInfo($(this).val(),$(this).attr("data-nombre")):facturacion.Facturacion.View.RemoveServicioFromInfo($(this).val()),facturacion.Facturacion.Controller.InfoFacturacion()})),$("#formConfiguracion").length&&($(".btnSaveData").off(core.helper.clickEventType).on(core.helper.clickEventType,(function(a){facturacion.Facturacion.Controller.SaveConfiguration()})),facturacion.Facturacion.Controller.LoadConfiguration()),$("body").on(core.helper.clickEventType,".btnProcesoTerminado",(function(a){CoreUI.Progress.Hide()})),$("body").on(core.helper.clickEventType,".btnEliminarIngresoCuenta",(a=>{a.stopImmediatePropagation(),facturacion.Facturacion.Controller.IngresosCuenta.Delete($(a.currentTarget).attr("data-id"),$(a.currentTarget).attr("data-concepto"),$(a.currentTarget).attr("data-procesado"),$(a.currentTarget).attr("data-importe"),$(a.currentTarget).attr("data-fecha"),$(a.currentTarget).attr("data-administrador"))})),$("body .form-ingreso-cuenta").off(core.helper.clickEventType).on(core.helper.clickEventType,".btnSaveData",(a=>{a.stopImmediatePropagation(),facturacion.Facturacion.Controller.IngresosCuenta.Save()})),$("body").on(core.helper.clickEventType,".btnCrearFacturaRectificativa",(function(a){let t=$(this).attr("data-id"),e=$(this).attr("data-idrectificativa");if(!facturacion.Facturacion.Controller.ValidarFacturaRectificativa(e))return;let o=Object();o.id=t,o.numero=$(this).attr("data-numero"),o.total=$(this).attr("data-importe"),o.email=$(this).attr("data-email"),o.administrador=$(this).attr("data-administrador"),o.comunidad=$(this).attr("data-comunidad");new Promise((async(a,t)=>{await apiFincatech.getView("facturacion","modal_rectificativa",JSON.stringify(o)).then((t=>{CoreUI.Modal.CustomHTML(t,"Factura Rectificativa",(function(){$(".emailbody").trumbowyg()}),"70%"),a(!0)}))}))})),$("body").on(core.helper.clickEventType,".btnModalCrearFacturaRectificativa",(function(a){let t=$(this).attr("data-id");facturacion.Facturacion.Controller.GenerarFacturaRectificativa(t,"null")})),$("body").on(core.helper.clickEventType,".btnEnviarFactura",(function(a){let t=$(this).attr("data-id"),e=$(this).attr("data-idrectificativa"),o=$(this).attr("data-rectificativa"),i=Object();i.id=t,i.idrectificativa=e,i.numerorectificativa=o,i.numero=$(this).attr("data-numero"),i.total=$(this).attr("data-importe"),i.email=$(this).attr("data-email"),i.administrador=$(this).attr("data-administrador"),i.comunidad=$(this).attr("data-comunidad"),i.fecha=$(this).attr("data-fecha");new Promise((async(a,t)=>{await apiFincatech.getView("facturacion","modal_envio",JSON.stringify(i)).then((t=>{CoreUI.Modal.CustomHTML(t,"Enviar Factura por E-mail",(function(){$(".emailbody").trumbowyg()}),"70%"),a(!0)}))}))})),$("body").on(core.helper.clickEventType,".btnModalEnviarFactura",(function(a){let t=$(this).attr("data-id");facturacion.Facturacion.Controller.EnviarFactura(t)}))},Controller:{EstadoFacturacion:function(){return void 0!==facturacion.Facturacion.Model.InfoFacturacion.estadofacturacion.label_estado?facturacion.Facturacion.Model.InfoFacturacion.estadofacturacion.label_estado:facturacion.Facturacion.Constants.ESTADO_PENDIENTE_FACTURACION},Anyo:function(){return facturacion.Facturacion.Model.Anyo},SetAnyo:function(a){facturacion.Facturacion.Model.Anyo=a},Mes:function(){return facturacion.Facturacion.Model.Mes},SetMes:function(a){facturacion.Facturacion.Model.Mes=a},SetFacturacionAnual:function(a){facturacion.Facturacion.Model.FacturacionAnual=a},FacturacionAnual:function(){return facturacion.Facturacion.Model.FacturacionAnual},SetFacturacionMes:function(a){facturacion.Facturacion.Model.FacturacionMes=a},FacturacionMes:function(){return facturacion.Facturacion.Model.FacturacionMes},SetMonthCalculo:function(a){facturacion.Facturacion.Model.MonthCalculo=a},MonthCalculo:function(){return facturacion.Facturacion.Model.MonthCalculo},SetYearCalculo:function(a){facturacion.Facturacion.Model.YearCalculo=a},YearCalculo:function(){return facturacion.Facturacion.Model.YearCalculo},SetTotalIngresosCuentaPendiente:function(a){facturacion.Facturacion.Model.IngresosCuentaPendiente=a},TotalIngresosCuentaPendiente:function(){return facturacion.Facturacion.Model.IngresosCuentaPendiente},SetTotalFacturasMesEmitidas:function(a){facturacion.Facturacion.Model.FacturasMesEmitidas=a},TotalFacturasMesEmitidas:function(){return facturacion.Facturacion.Model.FacturasMesEmitidas},SetTotalFacturasMesDevueltas:function(a){facturacion.Facturacion.Model.FacturasMesDevueltas=a},TotalFacturasMesDevueltas:function(){return facturacion.Facturacion.Model.FacturasMesDevueltas},SetTotalLiquidaciones:function(a){facturacion.Facturacion.Model.TotalLiquidaciones=a},TotalLiquidaciones:function(){return facturacion.Facturacion.Model.TotalLiquidaciones},SetTotalRemesas:function(a){facturacion.Facturacion.Model.TotalRemesas=a},TotalRemesas:function(){return facturacion.Facturacion.Model.TotalRemesas},SetBestCustomer:function(a){facturacion.Facturacion.Model.BestCustomer=a},BestCustomer:function(){return facturacion.Facturacion.Model.BestCustomer},SetBestCustomerTotal:function(a){facturacion.Facturacion.Model.BestCustomerTotal=a},BestCustomerTotal:function(){return facturacion.Facturacion.Controller.Utils.FormatearNumero(facturacion.Facturacion.Model.BestCustomerTotal)},SetFacturasDevueltas:function(a){facturacion.Facturacion.Model.FacturasDevueltas=a},FacturasDevueltas:function(){return facturacion.Facturacion.Model.FacturasDevueltas},FacturasDevueltasTotal:function(){return facturacion.Facturacion.Controller.Utils.FormatearNumero(facturacion.Facturacion.Model.FacturasDevueltasTotal)},SetFacturasDevueltasTotal:function(a){facturacion.Facturacion.Model.FacturasDevueltasTotal=a},LoadStatsDashboard:async function(){facturacion.Facturacion.Controller.SetAnyo(moment().format("Y")),facturacion.Facturacion.Controller.SetMes(moment().format("M")),new Promise((async(a,t)=>{await facturacion.Facturacion.Controller.TotalFacturacionAnual(facturacion.Facturacion.Controller.Mes(),facturacion.Facturacion.Controller.Anyo()),a(!0)})).then((a=>{facturacion.Facturacion.Controller.Render()}))},TotalFacturacionAnual:async function(a,t){let e=Object();e.year=facturacion.Facturacion.Controller.Anyo(),e.month=facturacion.Facturacion.Controller.Mes(),await apiFincatech.post("facturacion/totalfacturacion",e).then((a=>{a=JSON.parse(a),facturacion.Facturacion.Controller.SetFacturacionAnual(a.data.facturacion_anual),facturacion.Facturacion.Controller.SetFacturacionMes(a.data.facturacion_mes),facturacion.Facturacion.Controller.SetMonthCalculo(a.data.month),facturacion.Facturacion.Controller.SetYearCalculo(a.data.year),facturacion.Facturacion.Controller.SetTotalIngresosCuentaPendiente(a.data.ingresoscuentapendiente),facturacion.Facturacion.Controller.SetTotalLiquidaciones(a.data.totalliquidaciones),facturacion.Facturacion.Controller.SetTotalRemesas(a.data.totalremesas),facturacion.Facturacion.Controller.SetFacturasDevueltasTotal(a.data.totalfacturasdevueltas),facturacion.Facturacion.Controller.SetFacturasDevueltas(a.data.facturasdevueltas),facturacion.Facturacion.Controller.SetTotalRemesas(a.data.totalremesas),facturacion.Facturacion.Controller.SetBestCustomer(a.data.bestcustomer),facturacion.Facturacion.Controller.SetBestCustomerTotal(a.data.bestcustomer_total_facturacion)}))},LoadConfiguration:async function(){await apiFincatech.get("facturacion/configuracion").then((a=>{a=JSON.parse(a),core.Forms.mapDataFromModel("formConfiguracion",a.data)}))},SaveConfiguration:async function(){if(core.Forms.prepareFormDataBeforeSend("formConfiguracion"),core.Forms.Validate()){new Promise((async(a,t)=>{await apiFincatech.post("facturacion/configuracion",core.Forms.data).then((t=>{a(t)}))})).then((a=>{let t=JSON.parse(a);"error"==t.status.response?CoreUI.Modal.Error(t.status.error):CoreUI.Modal.Success("La configuración se ha actualizado correctamente")}))}else CoreUI.Modal.Error(`<p class="text-left">Corrija los errores señalados para poder guardar la configuración actual:<br> ${core.Forms.errorMessage}</p>`,"Error de validación")},GetOptions:function(){let a=Object();return a.servicios=Array(),$(".chkServicio").each((function(t){$(this).is(":checked")&&a.servicios.push($(this).val())})),a.idadministrador=null==$("#usuarioId").val()?-1:$("#usuarioId").val(),a.mesfacturacion=$("#mesFacturacion").val(),a.idBanco=$("#bancoRemesa option:selected").val(),a.envioEmailAdministrador=1,a.agruparServicios=$("#chkAgrupaServicios").is(":checked"),a.agruparFacturas=1,a.envioAPI=$("#chkAPIComunidad").is(":checked"),a.conceptoCAE=$("#conceptoCAE").val(),a.conceptoDOCCAE=$("#conceptoDOCCAE").val(),a.conceptoDPD=$("#conceptoDPD").val(),a.conceptoCertificadoDigital=$("#conceptoCertificadosDigitales").val(),a.emailBody=$(".emailbody").trumbowyg("html"),a},GenerarFacturacion:function(){if($("body").removeClass("progress"),!0===facturacion.Facturacion.Controller.ValidateFacturacion()){CoreUI.Progress.Show();let a=facturacion.Facturacion.Controller.GetOptions();apiFincatech.postWithProgress("facturacion/generar",a,!1).then((a=>{try{let t=JSON.parse(a);"error"==t.data?CoreUI.Modal.Error("Error: "+t.data,"Error"):(CoreUI.Progress.SetMessage(t.data),CoreUI.Progress.Completed(),facturacion.Facturacion.Controller.InfoFacturacion())}catch(a){CoreUI.Modal.Error("Error al procesar la respuesta: "+a.message,"Error")}})).catch((a=>{CoreUI.Progress.Hide(),CoreUI.Modal.Error("Error: "+a.status.error,"Error")}))}},ValidarFacturaRectificativa:function(a){return"null"===a||(CoreUI.Modal.Error("Esta factura ya tiene asociada una factura rectificativa por lo tanto no se puede generar una nueva"),!1)},GenerarFacturaRectificativa:function(a,t){if("null"===t){let t=Object();t.concepto=$("body #conceptoFacturaRectificativa").val(),t.importe=$("body #importeFacturaRectificativa").val(),t.cuerpo=$(".emailbody").trumbowyg("html"),new Promise((async(e,o)=>{await apiFincatech.post(`factura/${a}/rectificativa/create`,t).then((a=>{e(JSON.parse(a))}))})).then((a=>{"error"==a.data?CoreUI.Modal.Error(a.status.error):CoreUI.Modal.Success("La factura rectificativa ha sido generada correctamente con número: "+a.data,"",(function(){$("#listadoFacturacion").length&&$("#listadoFacturacion").DataTable().ajax.reload(),$("#listadoFacturasEmitidas").length&&$("#listadoFacturasEmitidas").DataTable().ajax.reload(),$("#listadoFacturasEmitidasPendiente").length&&$("#listadoFacturasEmitidasPendiente").DataTable().ajax.reload()}))}))}else CoreUI.Modal.Error("Esta factura ya tiene asociada una factura rectificativa por lo tanto no se puede generar una nueva")},EnviarFactura:function(a){let t=$("body .emailbody").trumbowyg("html"),e=$("body #asuntoEnvioFactura").val(),o=$("body #emailEnvioFactura").val();if(facturacion.Facturacion.Controller.ValidateBeforeSendInvoice()){let i=Object();i.id=a,i.asunto=e,i.email=o,i.cuerpo=t,apiFincatech.post(`factura/${a}/send`,i).then((a=>{let t=JSON.parse(a);"ok"==t.data?CoreUI.Modal.Success("La Factura ha sido enviada por e-mail satisfactoriamente","Factura enviada"):CoreUI.Forms.Errors.SetMessage("resultado","Ha ocurrido un error al intentar enviar la factura por e-mail: "+t.status.error)}))}},InfoFacturacion:async function(){let a=facturacion.Facturacion.Controller.GetOptions();facturacion.Facturacion.Model.ContratadoCae=!1,facturacion.Facturacion.Model.ContratadoDpd=!1,facturacion.Facturacion.Model.ContratadoCertificadosDigitales=!1,$(".numero-comunidades").html("0"),$(".importe-facturacion").html("0,00"),apiFincatech.post("facturacion/info",a).then((a=>{let t=JSON.parse(a);"error"==t.status.response?(facturacion.Facturacion.Model.ContratadoCae=!1,facturacion.Facturacion.Model.ContratadoDocCae=!1,facturacion.Facturacion.Model.ContratadoDpd=!1,facturacion.Facturacion.Model.ContratadoCertificadosDigitales=!1,facturacion.Facturacion.View.RemoveAllSelectedServices(),facturacion.Facturacion.View.ShowAvailableServices(),CoreUI.Modal.Error(`<p class="text-center mb-0">${t.status.error}</p>`)):(facturacion.Facturacion.Model.InfoFacturacion=t.data,facturacion.Facturacion.View.RenderInfoFacturacion())}))},ValidateFacturacion:function(){let a=!0,t="",e=null==$("#usuarioId").val()?-1:$("#usuarioId").val();return parseInt(e)<=0&&(t=`${t}-No ha seleccionado ningún administrador<br>`),$(".info-servicios .badge").length<=0&&(t=`${t}-Debe seleccionar al menos 1 servicio<br>`),0==parseInt($(".numero-comunidades").html())&&(t=`${t}-No hay comunidades para facturar<br>`),facturacion.Bank.Model.CuentaAsociada||(t=`${t}-El banco seleccionado no tiene informado el IBAN<br>`),""!==t&&(a=!1,CoreUI.Modal.Error(`<p class="text-left">No se ha podido generar la facturación debido a los siguientes problemas:</p><p class="text-left mb-0">${t}</p>`,"Error de validación")),a},Render:function(){let a=facturacion.Facturacion.Controller.FacturacionAnual(),t=facturacion.Facturacion.Controller.Utils.FormatearNumero(a.total_cae),e=facturacion.Facturacion.Controller.Utils.FormatearNumero(a.total_doccae),o=facturacion.Facturacion.Controller.Utils.FormatearNumero(a.total_dpd),i=facturacion.Facturacion.Controller.Utils.FormatearNumero(a.total_certificados),r=facturacion.Facturacion.Controller.Utils.FormatearNumero(a.total);$(".stats-facturacion-anual .total_cae").html(t),$(".stats-facturacion-anual .total_doccae").html(e),$(".stats-facturacion-anual .total_dpd").html(o),$(".stats-facturacion-anual .total_certificados").html(i),$(".stats-facturacion-anual .total_anual").html(r);let c=0,n=0,l=facturacion.Facturacion.Controller.FacturacionMes(),s=0;s+=parseFloat(l.facturacion_cobradas.total_cae)||0,s+=parseFloat(l.facturacion_cobradas.total_dpd)||0,s+=parseFloat(l.facturacion_cobradas.total_certificados)||0,s+=parseFloat(l.facturacion_cobradas.total_doccae)||0,s=facturacion.Facturacion.Controller.Utils.FormatearNumero(s),$(".stats-facturacion-mes .total_mes_facturas_emitidas").html(s),r=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_estimada.total),t=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_estimada.total_cae),c=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_cobradas.total_cae),n=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_devueltas.total_cae),$(".stats-facturacion-mes .total_cae").html(t),$(".stats-facturacion-mes .total_cae_emitidas").html(c),$(".stats-facturacion-mes .total_cae_devueltas").html(n),e=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_estimada.total_doccae),c=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_cobradas.total_doccae),n=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_devueltas.total_doccae),$(".stats-facturacion-mes .total_doccae").html(e),$(".stats-facturacion-mes .total_doccae_emitidas").html(c),$(".stats-facturacion-mes .total_doccae_devueltas").html(n),o=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_estimada.total_dpd),c=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_cobradas.total_dpd),n=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_devueltas.total_dpd),$(".stats-facturacion-mes .total_dpd").html(o),$(".stats-facturacion-mes .total_dpd_emitidas").html(c),$(".stats-facturacion-mes .total_dpd_devueltas").html(n),i=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_estimada.total_certificados),c=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_cobradas.total_certificados),n=facturacion.Facturacion.Controller.Utils.FormatearNumero(l.facturacion_devueltas.total_certificados),$(".stats-facturacion-mes .total_certificados").html(i),$(".stats-facturacion-mes .total_certificados_emitidas").html(c),$(".stats-facturacion-mes .total_certificados_devueltas").html(n),$(".stats-facturacion-mes .total_mes").html(r),$(".stats-facturacion-mes .month").html(facturacion.Facturacion.Controller.MonthCalculo()),$(".stats-facturacion-mes .year").html(facturacion.Facturacion.Controller.YearCalculo());let u=facturacion.Facturacion.Controller.TotalIngresosCuentaPendiente(),d=facturacion.Facturacion.Controller.TotalLiquidaciones(),f=facturacion.Facturacion.Controller.FacturasDevueltas(),m=facturacion.Facturacion.Controller.FacturasDevueltasTotal();u=facturacion.Facturacion.Controller.Utils.FormatearNumero(u),d=facturacion.Facturacion.Controller.Utils.FormatearNumero(d),$(".stats-facturacion-anual .total_ingresoscuenta_pendiente").html(u),$(".stats-facturacion-anual .total_liquidaciones").html(d),$(".stats-facturacion-anual .facturas_devueltas").html(f),$(".stats-facturacion-anual .facturas_devueltas_importe").html(m),$(".stats-facturacion-anual .total_remesas").html(facturacion.Facturacion.Controller.TotalRemesas());let C=facturacion.Facturacion.Controller.BestCustomer()+" [ "+facturacion.Facturacion.Controller.BestCustomerTotal()+"&euro; ]";$(".stats-facturacion-anual .best_customer").html(C)},ValidateBeforeSendInvoice:function(){let a="";if($(".emailEnvioFactura-msg-error").removeClass("d-none").addClass("d-none"),""==$("#swal2-html-container #emailEnvioFactura").val()&&(a="Debe escribir el e-mail al que desea enviar la factura"),""!==$("#swal2-html-container #emailEnvioFactura").val()){let t=$("#swal2-html-container #emailEnvioFactura").val().split(";");for(let e=0;e<t.length;e++)core.helper.validarEmail(t[e])||(a=`${a}El e-mail ${t[e]} no es válido<br>`)}return CoreUI.Forms.Errors.SetMessage("emailEnvioFactura",a),""===a},RenderList:function(){$("#listadoBank").length&&facturacion.Facturacion.View.ListBanks(),$("#listadoFacturasEmitidas").length&&facturacion.Facturacion.View.TableFacturasEmitidas(),$("#listadoFacturasEmitidasPendiente").length&&facturacion.Facturacion.View.TableFacturasEmitidasPendiente(),$("#listadoFacturacionRectificativas").length&&facturacion.Facturacion.View.TableFacturasRectificativas(),$("#listadoRemesas").length&&facturacion.Facturacion.View.TableRemesas(),$("#listadoFacturacion").length&&facturacion.Facturacion.View.TableFacturacion("listadoFacturacion"),$("#listadoRecibos").length&&facturacion.Facturacion.View.TableRecibos(),$("#listadoIngresosCuenta").length&&facturacion.Facturacion.View.TableIngresosCuenta(),$("#listadoLiquidaciones").length&&facturacion.Facturacion.View.TableLiquidaciones()},Bank:{Save:function(){let a=$("#bic").val();facturacion.Facturacion.Controller.Utils.ValidateBIC(a)?core.Forms.Validate("form-banco")?(core.Forms.mapDataToSave(),core.Forms.Save(!0)):CoreUI.Modal.Error("Rellene los campos obligatorios para poder guardar el banco","Formulario incompleto"):CoreUI.Modal.Error("El código SWIFT/BIC no es válido. Por favor, revíselo para poder continuar","Error BIC/Swift")},Delete:function(a,t){core.Modelo.Delete("bank",a,t,"listadoBank")}},IngresosCuenta:{ValidateBeforeSave:function(){return core.Forms.Validate(),"-1"==$("#usuarioId option:selected").val()&&core.Forms.SetError("Debe seleccionar un administrador"),isNaN($("#total").val())&&core.Forms.SetError("El valor del importe no es correcto"),""===core.Forms.GetErrorMessage()||(core.Forms.ShowErrorMessage(),!1)},Save:function(){facturacion.Facturacion.Controller.IngresosCuenta.ValidateBeforeSave()&&(core.Forms.mapFormDataToSave(),core.Forms.Save(!0))},Delete:function(a,t,e,o,i,r){if(!0===Boolean(parseInt(e)))CoreUI.Modal.Error("Este ingreso ya ha sido procesado en una liquidación por lo tanto no puede ser eliminado");else{let e=`<p class="mb-0 text-left"><span class="font-weight-bold">Administrador</span>: ${r}</p>\n                        <p class="mb-0 text-left"><span class="font-weight-bold">Concepto del ingreso a cuenta</span>: ${t}</p>\n                        <p class="mb-0 text-left"><span class="font-weight-bold">Importe</span>: ${Number(o).toFixed(2)}&euro;</p>\n                        <p class="mb-0 text-left"><span class="font-weight-bold">Fecha del apunte</span>: ${i}</p>`;Swal.fire({title:"¿Desea eliminar el ingreso a cuenta?",html:'<p class="font-weight-bold text-danger">Atención: Esta acción es irreversible</p>'+e,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"}).then((t=>{t.isConfirmed&&apiFincatech.delete("ingresoscuenta",a).then((a=>{"error"==(a=JSON.parse(a)).data?CoreUI.Modal.Error(a.status.error):(CoreUI.Modal.Success("El apunte de ingreso a cuenta se ha eliminado correctamente"),facturacion.Facturacion.View.TableIngresosCuenta())}))}))}}},Utils:{FormatearNumero:function(a){let t=parseFloat(a).toFixed(2).split("."),e=t[0],o=t[1];return e=e.replace(/\B(?=(\d{3})+(?!\d))/g,"."),e+","+o},ValidateBIC:function(a){return/^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?$/.test(a)}}},Model:{Anyo:null,Mes:null,MonthCalculo:null,YearCalculo:null,FacturacionAnual:null,FacturacionMes:null,FacturasEmitidas:null,FacturasPendientesCobro:null,Remesas:null,IngresosCuentaPendiente:0,TotalLiquidaciones:0,TotalRemesas:0,BestCustomer:"",BestCustomerTotal:0,FacturasDevueltas:0,FacturasDevueltasTotal:0,FacturasMesEmitidas:0,FacturasMesDevueltas:0,InfoFacturacion:null,ContratadoCae:!1,ContratadoDocCae:!1,ContratadoDpd:!1,ContratadoCertificadosDigitales:!1},View:{ListBanks:function(){if($("#listadoBank").length){CoreUI.tableData.init(),CoreUI.tableData.addColumn("listadoBank","nombre","NOMBRE",null,"","60%"),CoreUI.tableData.addColumn("listadoBank","bic","BIC/SWIFT"),CoreUI.tableData.addColumn("listadoBank","codigo","Código Entidad"),CoreUI.tableData.addColumn("listadoBank","creditorid","Creditor ID"),CoreUI.tableData.addColumn("listadoBank","iban","IBAN");'<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarBanco d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="trash-2" class="text-danger img-fluid icono-accion" style="width:26px;height:26px;"></i></li></ul>',CoreUI.tableData.addColumn("listadoBank",null,"",'<ul class="nav justify-content-center accionesTabla"><li class="nav-item"><a href="javascript:void(0);" class="btnEliminarBanco d-inline-block" data-id="data:id$" data-nombre="data:nombre$"><i data-feather="trash-2" class="text-danger img-fluid icono-accion" style="width:26px;height:26px;"></i></li></ul>',"","80px"),CoreUI.tableData.render("listadoBank","Bank","bank/list")}},TableFacturacion:function(a){let t=a;CoreUI.tableData.init(),CoreUI.tableData.addColumn(t,"numero","Nº Fra.",null,"text-center","60px"),CoreUI.tableData.addColumn(t,"administrador","Administrador"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i="";return a.comunidad&&(i=`${a.comunidad[0].codigo} - ${a.comunidad[0].nombre}`),i}),"Comunidad",null),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i="";return a.comunidad&&(i=`${a.comunidad[0].cif}`),i}),"CIF Comunidad",null,"text-center"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i="";return i=`${moment(a.dateinvoice).locale("es").format("L")}`,i}),"Fecha Fra.",null,"text-center","120px"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i,r;return r=a.datepaid?moment(a.datepaid).locale("es").format("L"):"-",i=`${r}`,i}),"Fecha de Cobro",null,"text-center","120px"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i,r;return r=a.datereturned?moment(a.datereturned).locale("es").format("L"):"-",i=`${r}`,i}),"Fecha Devolución",null,"text-center","120px"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i="";return i=`${parseFloat(a.total_taxes_inc).toFixed(2)}&euro;`,i}),"Importe",null,"text-center"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){if(a.idrectificativa){return`\n                            <div class="d-flex align-items-center justify-content-center">\n                                <a href="${`https://factura.fincatech.es/pdf/${a.invoicerectificativa[0].nombrefichero}`}" title="Ver PDF generado" target="_blank"><i class="bi bi-filetype-pdf text-dark img-fluid icono-accion" style="font-size: 21px;"></i></a>\n                            </div>`}return'<span class="badge bg-success">No</span>'}),"Fra. Rectificativa",null,"text-center"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i="";return i=1==a.liquidada?'<span class="badge bg-success">Sí</span>':'<span class="badge bg-warning">No</span>',i}),"Liquidada",null,"text-center"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i,r,c;switch(a.estado){case"P":r="warning",c="Pendiente";break;case"D":r="danger",c="Devuelta";break;case"C":r="success",c="Cobrada";break}return i=`<span class="badge bg-${r}">${c}</span>`,i}),"Estado",null,"text-center"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i="";a.invoicerectificativa.length>0&&(i=a.invoicerectificativa[0].numero);let r=`data-id="${a.id}" data-numero="${a.numero}" data-email="${a.email}" data-administrador="${a.administrador}" data-numero="${a.id}"`;r=`${r} data-comunidad="${a.comunidad[0].nombre}" data-rectificativa="${i}" data-fecha="${moment(a.dateinvoice).locale("es").format("L")}" data-importe="${a.total_taxes_exc}" data-idrectificativa="${a.idrectificativa}"`;var c='<ul class="nav justify-content-center accionesTabla">';return c+=`<li class="nav-item"><a href="${`https://factura.fincatech.es/pdf/${a.fichero}.pdf`}" title="Ver PDF generado" target="_blank"><i class="bi bi-filetype-pdf text-success img-fluid icono-accion" style="font-size: 18px;"></i></a></li>`,c+=`<li class="nav-item"><a href="invoice/${a.id}" data-id="${a.id}" title="Ver factura"><i data-feather="eye" class="text-success img-fluid icono-accion" style="width:18px;height:18px;"></i></li>`,c+=`<li class="nav-item"><a href="javascript:void(0);" class="btnEnviarFactura" ${r} title="Enviar factura por e-mail"><i data-feather="mail" class="text-success img-fluid icono-accion" style="width:18px;height:18px;"></i></li>`,c+=`<li class="nav-item"><a href="javascript:void(0);" class="btnCrearFacturaRectificativa ml-1" ${r} title="Generar factura rectificativa"><i data-feather="rotate-ccw" class="text-danger img-fluid"></i></a></li>`,c+="</ul>"}),"&nbsp;",null,"text-center","100px"),$("#"+t).addClass("no-clicable"),CoreUI.tableData.render(t,"Invoice","invoice/list",!1,!0,!0,null,!0,!1,!1,!0,"GET",!1,!0)},TableFacturas:function(a,t){let e=a;CoreUI.tableData.init(),CoreUI.tableData.addColumn(e,(function(a,t,e,o){let i;return i=`<p class="mb-0">${a.numero}</p>`,i}),"Nº Fra.",null,"text-center","80px"),CoreUI.tableData.addColumn(e,"administrador","Administrador"),CoreUI.tableData.addColumn(e,"comunidad[0].nombre","Comunidad"),CoreUI.tableData.addColumn(e,(function(a,t,e,o){let i;return i=moment(a.dateinvoice).format("DD/MM/YYYY"),i}),"Fecha Fra.",null,"text-center"),CoreUI.tableData.addColumn(e,"total_taxes_inc","Importe"),CoreUI.tableData.addColumn(e,(function(a,t,e,o){let i,r,c;switch(a.estado){case"P":r="danger",c="Pendiente";break;case"D":r="warning",c="Devuelta";break;case"C":r="success",c="Cobrada";break}return i=`<span class="badge bg-${r}">${c}</span>`,i}),"Estado",null,"text-center"),CoreUI.tableData.addColumn(e,(function(a,t,e,o){let i,r;return a.idrectificativa&&(r='<p class="mb-0 text-center">\n                            <a href="" title="Ver PDF Fra. Rectificativa" target="_blank"><i class="bi bi-filetype-pdf text-danger" style="font-size: 21px;"></i></a>\n                        </p>'),i='\n                    <p class="mb-0 text-center">\n                        <a href="" title="Ver PDF generado" target="_blank"><i class="bi bi-filetype-pdf text-primary" style="font-size: 21px;"></i></a>\n                    </p>','\n                    <p class="mb-0 text-center">\n                        <a href="" title="Ver PDF generado" target="_blank"><i class="bi bi-filetype-pdf text-primary" style="font-size: 21px;"></i></a>\n                    </p>'}),"DOC.",null,"text-center"),CoreUI.tableData.addColumn(e,(function(a,t,e,o){let i="";a.invoicerectificativa.length>0&&(i=a.invoicerectificativa[0].numero);let r=`data-id="${a.id}" data-numero="${a.numero}" data-email="${a.email}" data-administrador="${a.administrador}" data-numero="${a.id}"`;r=`${r} data-comunidad="${a.comunidad[0].nombre}" data-rectificativa="${i}" data-fecha="${moment(a.dateinvoice).locale("es").format("L")}" data-importe="${a.total_taxes_exc}" data-idrectificativa="${a.idrectificativa}"`;var c='<ul class="nav justify-content-center accionesTabla">';return c+=`<li class="nav-item"><a href="invoice/${a.id}" data-id="${a.id}" title="Ver factura"><i data-feather="eye" class="text-success img-fluid icono-accion" style="width:18px;height:18px;"></i></li>`,c+=`<li class="nav-item"><a href="javascript:void(0);" class="btnEnviarFactura" ${r} title="Enviar factura por e-mail"><i data-feather="mail" class="text-success img-fluid icono-accion" style="width:18px;height:18px;"></i></li>`,c+=`<li class="nav-item"><a href="javascript:void(0);" class="btnCrearFacturaRectificativa ml-1" ${r} title="Generar factura rectificativa"><i data-feather="rotate-ccw" class="text-danger img-fluid"></i></a></li>`,c+="</ul>"}),"&nbsp;",null,"text-center","100px"),$("#"+e).addClass("no-clicable"),CoreUI.tableData.render(e,"Invoice",`facturacion/listado/${t}`,!1,!0,!0)},TableFacturasEmitidas:function(){facturacion.Facturacion.View.TableFacturas("listadoFacturasEmitidas","c")},TableFacturasEmitidasPendiente:function(){facturacion.Facturacion.View.TableFacturas("listadoFacturasEmitidasPendiente","D")},TableFacturasRectificativas:function(){let a="listadoFacturacionRectificativas";CoreUI.tableData.init(),CoreUI.tableData.addColumn(a,"numero","Nº Fra.",null,"text-start","120px"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){return`\n                        <div class="d-flex align-items-center">\n                            <a href="${`https://factura.fincatech.es/pdf/${a.nombrefichero}.pdf`}" title="Ver PDF generado" target="_blank"><i class="bi bi-filetype-pdf text-dark img-fluid icono-accion" style="font-size: 21px;"></i></a>\n                            <p class="mb-0 text-center">${a.invoice[0].numero}</p>\n                        </div>`}),"Fra. Asociada",null,"text-start","120px"),CoreUI.tableData.addColumn(a,"administrador","Administrador"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="";return a.comunidad&&(i=`${a.comunidad[0].cif}`),i}),"CIF Comunidad",null,"text-center"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="";return a.comunidad&&(i=`${a.comunidad[0].codigo} - ${a.comunidad[0].nombre}`),i}),"Comunidad",null),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="";return i=`${moment(a.created).locale("es").format("L")}`,i}),"Fecha",null,"text-center","120px"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="";return i=`${parseFloat(a.total_taxes_inc).toFixed(2)}&euro;`,i}),"Importe",null,"text-center"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i=`data-id="${a.id}" data-numero="${a.numero}" data-email="${a.email}" data-administrador="${a.administrador}" data-numero="${a.id}"`;i=`${i} data-comunidad="${a.comunidad[0].nombre}" data-invoice="${a.idinvoice}" data-fecha="${moment(a.creeated).locale("es").format("L")}" data-importe="${a.total_taxes_exc}" data-idrectificativa="${a.id}"`;var r='<ul class="nav justify-content-center accionesTabla">';return r+=`<li class="nav-item"><a href="${`https://factura.fincatech.es/pdf/${a.nombrefichero}.pdf`}" title="Ver PDF generado" target="_blank"><i class="bi bi-filetype-pdf text-success img-fluid icono-accion" style="font-size: 18px;"></i></a></li>`,r+=`<li class="nav-item"><a href="invoicerectificativa/${a.id}" data-id="${a.id}" title="Ver factura"><i data-feather="eye" class="text-success img-fluid icono-accion" style="width:18px;height:18px;"></i></li>`,r+=`<li class="nav-item"><a href="javascript:void(0);" class="btnEnviarFactura" ${i} title="Enviar factura por e-mail"><i data-feather="mail" class="text-success img-fluid icono-accion" style="width:18px;height:18px;"></i></li>`,r+="</ul>"}),"&nbsp;",null,"text-center","100px"),$("#"+a).addClass("no-clicable"),CoreUI.tableData.render(a,"InvoiceRectificativa","invoicerectificativa/list",!1,!0,!0,null,!0,!1,!1,!0,"GET",!1,!0)},TableRemesas:function(){let a="listadoRemesas";CoreUI.tableData.init(),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="";return i=moment(a.created).format("DD/MM/YYYY"),i}),"Fecha de remesa",null,"text-center","120px"),CoreUI.tableData.addColumn(a,"referencia","Referencia",null),CoreUI.tableData.addColumn(a,"customername","Administrador",null),CoreUI.tableData.addColumn(a,"creditoraccountiban","Banco de cobro"),CoreUI.tableData.addColumn(a,"totalrecibos","Nº de recibos",null,"text-center","100px"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){return'<p class="mb-0">'+(Number(a.totalremesa).toFixed(2)+"&euro;")+"</p>"}),"Total Remesa",null,"text-center","100px"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){var i='<ul class="nav justify-content-center accionesTabla">';return i+=`<li class="nav-item"><a href="${baseURL}remesa/${a.id}" class="btnEditarRemesa d-inline-block"><i data-feather="eye" class="text-success img-fluid icono-accion" style="width:32px;height:32px;"></i></a></li>`,i+=`<li class="nav-item"><a href="${baseURL}public/storage/remesas/${a.referencia}.xml" target="_blank" class="btnDescargarRemesa d-inline-block" download><i data-feather="download-cloud" class="text-primary img-fluid icono-accion" style="width:26px;height:26px;"></i></li></ul>`}),"",null,"text-center","80px"),CoreUI.tableData.render(a,"Remesa","remesa/list")},TableRecibos:function(){let a=core.modelId,t="listadoRecibos";CoreUI.tableData.init(),CoreUI.tableData.addColumn(t,"customername","Comunidad",null,""),CoreUI.tableData.addColumn(t,"descripcion","Concepto",null,""),CoreUI.tableData.addColumn(t,"customeriban","CC domiciliación",null,""),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i="";return i=Number(a.amount).toFixed(2)+"&euro;",i}),"Importe",null,"text-center"),CoreUI.tableData.addColumn(t,(function(a,t,e,o){let i,r,c,n="";switch(a.estado){case"C":r="Cobrado",c="success";break;case"D":r="Devuelto",c="danger",n=moment(a.datereturned).format("DD/MM/YYYY");break}return i=`<span class="badge bg-${c}">${r}</span>`,""!==n&&(i+='<p class="mb-0 d-block"><small>'+n+"</p>"),i}),"Estado",null,"text-center"),$("#"+t).addClass("no-clicable"),CoreUI.tableData.render(t,"Recibos",`remesa/${a}/recibos`)},TableIngresosCuenta:function(){let a="listadoIngresosCuenta";CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="";return i=moment(a.fechaingreso).format("DD/MM/YYYY"),i}),"Fecha Ingreso",null,"text-center","100px"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){return a.usuario[0].nombre}),"Administrador",null),CoreUI.tableData.addColumn(a,"concepto","Concepto",null,""),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="";return i=`<p class="mb-0 text-right">${CoreUI.Utils.formatNumberToCurrency(a.total)}&euro;</p>`,i}),"Importe",null,"text-center"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="",r="",c="";return 0==a.procesado?(c="No",r="danger"):(c="Sí",r="success"),i=`<span class="badge bg-${r}">${c}</span>`,i}),"Liquidado",null,"text-center"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){var i='<ul class="nav justify-content-center accionesTabla">';return i+=`<li class="nav-item"><a href="${baseURL}ingresoscuenta/${a.id}" class="btnEditarIngreso d-inline-block"><i data-feather="edit" class="text-success img-fluid icono-accion" style="width:32px;height:32px;"></i></a></li>`,i+=`<li class="nav-item"><a href="javascript:void(0);" class="btnEliminarIngresoCuenta d-inline-block" data-id="${a.id}" data-administrador="${a.usuario[0].nombre}" data-importe="${a.total}" data-fecha="${moment(a.fechaingreso).format("DD/MM/YYYY")}" data-procesado="${a.procesado}" data-concepto="${a.concepto}"><i data-feather="trash-2" class="text-danger img-fluid icono-accion" style="width:26px;height:26px;"></i></li></ul>`,i+="</ul>"}),"",null,"text-center","80px"),CoreUI.tableData.render(a,"IngresosCuenta","IngresosCuenta/list")},TableLiquidaciones:function(){let a="listadoLiquidaciones";CoreUI.tableData.init(),CoreUI.tableData.columns=[],CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="";return i=moment(a.created).format("DD/MM/YYYY"),i}),"Fecha Generación",null,"text-center","100px"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i;return i=a.datefrom?`Desde ${moment(a.datefrom).format("DD/MM/YYYY")} hasta`:"Todo hasta",i=`${i} ${moment(a.dateto).format("DD/MM/YYYY")}`,i}),"Período liquidado",null,"text-center","200px"),CoreUI.tableData.addColumn(a,"referencia","Referencia",null,null,"270px"),CoreUI.tableData.addColumn(a,"administrador","Administrador",null,""),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="",r="",c="",n="";return a.fechapago?(c="Pagada",r="success",n=moment(a.fechapago).format("DD/MM/AAAA")):(c="Pendiente de pago",r="danger"),i=`<span class="badge bg-${r}">${c}</span>`,""!==n&&(i=`${i}<p class="mb-0 d-block">${n}</p>`),i}),"Estado",null,"text-center","100px"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){return`<span class="badge bg-primary">${a.liquidaciondetalle.length}</span>`}),"Nº Facturas",null,"text-center","100px"),CoreUI.tableData.addColumn(a,(function(a,t,e,o){let i="";return i=`<p class="mb-0 text-right pr-2">${CoreUI.Utils.formatNumberToCurrency(a.total_taxes_exc)}&euro;</p>`,i}),"Total",null,"text-right","100px"),$("#"+a).addClass("no-clicable"),CoreUI.tableData.render(a,"Liquidacion","liquidaciones/list")},RenderInfoFacturacion:function(){$(".numero-comunidades").html(facturacion.Facturacion.Model.InfoFacturacion.numerocomunidades),$(".importe-facturacion").html(facturacion.Facturacion.Model.InfoFacturacion.totalfacturacion),$(".total-servicios .total-1 .importe").html(facturacion.Facturacion.Model.InfoFacturacion.total_cae),$(".total-servicios .total-2 .importe").html(facturacion.Facturacion.Model.InfoFacturacion.total_dpd),$(".total-servicios .total-3 .importe").html(facturacion.Facturacion.Model.InfoFacturacion.total_doccae),$(".total-servicios .total-5 .importe").html(facturacion.Facturacion.Model.InfoFacturacion.total_certificados);let a=facturacion.Facturacion.Model.InfoFacturacion.estadofacturacion.devueltas,t=facturacion.Facturacion.Model.InfoFacturacion.estadofacturacion.cobradas,e=facturacion.Facturacion.Model.InfoFacturacion.estadofacturacion.pendientes;$("#chkAgrupaServicios").prop("checked",facturacion.Facturacion.Model.InfoFacturacion.configuracion.optagrupaservicios),$("#chkAPIComunidad").prop("checked",facturacion.Facturacion.Model.InfoFacturacion.configuracion.optenvioapi),facturacion.Facturacion.Model.ContratadoCae=Boolean(Number(facturacion.Facturacion.Model.InfoFacturacion.servicios.cae)),facturacion.Facturacion.Model.ContratadoDocCae=Boolean(Number(facturacion.Facturacion.Model.InfoFacturacion.servicios.doccae)),facturacion.Facturacion.Model.ContratadoDpd=Boolean(Number(facturacion.Facturacion.Model.InfoFacturacion.servicios.dpd)),facturacion.Facturacion.Model.ContratadoCertificadosDigitales=Boolean(Number(facturacion.Facturacion.Model.InfoFacturacion.servicios.certificadosdigitales)),facturacion.Facturacion.View.RemoveAllSelectedServices(),facturacion.Facturacion.View.ShowAvailableServices(),!0===facturacion.Facturacion.Model.ContratadoCae&&(facturacion.Facturacion.View.AddServicioToInfo(1,"CAE"),$(".servicio-cae").show()),!0===facturacion.Facturacion.Model.ContratadoDocCae&&(facturacion.Facturacion.View.AddServicioToInfo(3,"DOCCAE"),$(".servicio-doccae").show()),!0===facturacion.Facturacion.Model.ContratadoDpd&&(facturacion.Facturacion.View.AddServicioToInfo(2,"DPD"),$(".servicio-dpd").show()),!0===facturacion.Facturacion.Model.ContratadoCertificadosDigitales&&($(".servicio-certificadosdigitales").show(),facturacion.Facturacion.View.AddServicioToInfo(5,"Certificados digitales"));let o="success",i="",r="white";switch(facturacion.Facturacion.Controller.EstadoFacturacion()){case facturacion.Facturacion.Constants.ESTADO_FACTURADO:o="success",i=`${t} Facturadas`;break;case facturacion.Facturacion.Constants.ESTADO_FACTURAS_DEVUELTAS:o="warning",i=`${a} Facturas devueltas`,r="dark";break;case facturacion.Facturacion.Constants.ESTADO_PENDIENTE_FACTURACION:o="danger",i=`${e} Pendiente de cobrar`;break}$(".estado-facturacion").html(`<span class="badge px-3 font-weight-normal text-${r} bg-${o}">${i}</span>`)},AddServicioToInfo:function(a,t){if(0==$(".info-servicios .badge").length&&$(".info-servicios").html(""),$(`.info-servicios .servicio-${a}`).length<=0){let e=`<span class="badge mr-2 rounded-pill bg-info font-weight-normal text-white servicio-${a}">${t}</span>`;$(".info-servicios").append(e),$(".total-servicios").removeClass("d-none"),$(`.total-servicios .total-${a}`).removeClass("d-none")}},RemoveServicioFromInfo:function(a){let t=0;if($(`body .info-servicios .servicio-${a}`).remove(),$(".chkServicio").each((function(a){$(this).is(":checked")&&t++})),t<=0){$(".info-servicios").html("No ha seleccionado ningún servicio"),$(".total-servicios").addClass("d-none");for(let a=1;a<=5;a++)$(`.total-servicios .total-${a}`).removeClass("d-none").addClass("d-none")}},RemoveAllSelectedServices:function(){$(".servicio-doccae").hide(),$(".servicio-cae").hide(),$(".servicio-doccae").hide(),$(".servicio-dpd").hide(),$(".servicio-certificadosdigitales").hide(),facturacion.Facturacion.View.RemoveServicioFromInfo(1),facturacion.Facturacion.View.RemoveServicioFromInfo(2),facturacion.Facturacion.View.RemoveServicioFromInfo(3),facturacion.Facturacion.View.RemoveServicioFromInfo(5)},ShowAvailableServices:function(){$(".btnGenerarFactura").removeClass("disabled"),0==facturacion.Facturacion.Model.ContratadoCae&&0==facturacion.Facturacion.Model.ContratadoDpd&&0==facturacion.Facturacion.Model.ContratadoCertificadosDigitales?($(".emision--servicios-info").hide(),$(".emision--servicios-noinfo .mensaje").text("Este administrador no tiene servicios contratados"),$(".emision--servicios-noinfo").show(),$(".btnGenerarFactura").addClass("disabled")):($(".emision--servicios-info").show(),$(".emision--servicios-noinfo").hide())}}},Liquidaciones:{Init:function(){facturacion.Liquidaciones.Events()},Events:function(){$("#dateto").val(moment().format("YYYY-MM-DD")),facturacion.Liquidaciones.Model.dateTo=moment($("#dateto").val()).format("YYYY-MM-DD"),$("#dateto").on("change",(function(a){let t=facturacion.Liquidaciones.Validator.SelectedDates();!0!==t?(CoreUI.Modal.Error(`<p>Se han encontrado los siguientes errores:</p> ${t}`),facturacion.Liquidaciones.Model.dateTo=""):(facturacion.Liquidaciones.Model.dateTo=$("#dateto").val(),facturacion.Liquidaciones.Controller.LoadInfo()),facturacion.Liquidaciones.View.RenderInformation()})),$("#datefrom").on("change",(function(a){let t=facturacion.Liquidaciones.Validator.SelectedDates();!0!==t?(CoreUI.Modal.Error(`<p>Se han encontrado los siguientes errores:</p> ${t}`),facturacion.Liquidaciones.Model.dateFrom=""):(facturacion.Liquidaciones.Model.dateFrom=$("#datefrom").val(),facturacion.Liquidaciones.Controller.LoadInfo()),facturacion.Liquidaciones.View.RenderInformation()})),$("#usuarioId").on("change",(function(a){facturacion.Liquidaciones.Model.administrador=$("#usuarioId option:selected").text(),facturacion.Liquidaciones.Model.idadministrador=$("#usuarioId option:selected").val(),facturacion.Liquidaciones.View.RenderInformation(),facturacion.Liquidaciones.Controller.LoadInfo()})),$("body").on(core.helper.clickEventType,".btnGenerarLiquidacion",(function(a){facturacion.Liquidaciones.Model.administrador=$("#usuarioId option:selected").text(),facturacion.Liquidaciones.Model.idadministrador=$("#usuarioId option:selected").val(),facturacion.Liquidaciones.Controller.Generate()}))},Controller:{Generate:function(){new Promise((async(a,t)=>{let e=Object();e.idadministrador=facturacion.Liquidaciones.Model.idadministrador,e.datefrom=facturacion.Liquidaciones.Model.dateFrom,e.dateto=facturacion.Liquidaciones.Model.dateTo,await apiFincatech.post("liquidaciones/generate",e).then((t=>{let e=JSON.parse(t);"error"==e.data?CoreUI.Modal.Error(e.status.error,"Error"):CoreUI.Modal.Success(`La liquidación se ha generado correctamente<br><br>${e.data}`,"Liquidación",(function(){facturacion.Liquidaciones.Controller.LoadInfo()})),a(!0)}))})).then((a=>{}))},LoadInfo:function(){new Promise((async(a,t)=>{let e=Object();e.idadministrador=facturacion.Liquidaciones.Model.idadministrador,e.datefrom=facturacion.Liquidaciones.Model.dateFrom,e.dateto=facturacion.Liquidaciones.Model.dateTo,await apiFincatech.post("liquidaciones/info",e).then((t=>{let e=JSON.parse(t);e=e.data,facturacion.Liquidaciones.Model.numeroComunidades=e.total_comunidades,facturacion.Liquidaciones.Model.totalTaxesExc=e.total_taxes_exc,facturacion.Liquidaciones.Model.totalTaxesInc=e.total_taxes_inc,facturacion.Liquidaciones.Model.totalIngresosCuenta=e.total_ingreso_cuenta,facturacion.Liquidaciones.Model.totalPendienteLiquidacion=e.total_liquidacion,a(!0)}))})).then((a=>{facturacion.Liquidaciones.View.RenderInformation()}))}},Model:{numeroComunidades:0,idadministrador:-1,administrador:"Ninguno",estado:"-",totalPendienteLiquidacion:0,totalIngresosCuenta:0,totalTaxesInc:0,totalTaxesExc:0,pendienteLiquidacion:0,dateFrom:"",dateTo:""},Validator:{SelectedDates:function(){let a="",t=moment();if(""==$("#dateto").val()&&(a=`${a}<p class="mb-0">- <strong>Fecha Hasta</strong> está vacía o es incorrecta</p>`),""!==$("#dateto").val()){moment($("#dateto").val(),"YYYY-MM-DD").isAfter(t)&&(a=`${a}<p class="mb-0">La fecha hasta debe ser igual o inferior a la fecha de hoy</p>`,$("#dateto").val(moment().format("YYYY-MM-DD")),facturacion.Liquidaciones.Model.dateTo=moment($("#dateto").val()).format("YYYY-MM-DD"))}if(""!==$("#datefrom").val()&&""!==$("#dateto").val()){let t=moment($("#datefrom").val(),"YYYY-MM-DD"),e=moment($("#dateto").val(),"YYYY-MM-DD");t.isAfter(e)&&(a=`${a}<p class="mb-0">- <strong>Fecha Desde</strong> debe ser inferior a la <strong>Fecha Hasta</strong></p>`,$("#datefrom").val(""))}return""==a||a}},View:{RenderInformation:function(){if($(".administrador-seleccionado").html(facturacion.Liquidaciones.Model.administrador),$(".numero-comunidades").html(facturacion.Liquidaciones.Model.numeroComunidades),!0===facturacion.Liquidaciones.Validator.SelectedDates()){let a=moment($("#datefrom").val()).format("DD/MM/YYYY"),t=moment($("#dateto").val()).format("DD/MM/YYYY");$(".periodo-liquidacion").html(`Desde ${a} hasta ${t} inclusive`)}""==facturacion.Liquidaciones.Model.dateFrom&&""!==facturacion.Liquidaciones.Model.dateTo&&$(".periodo-liquidacion").html("Todo hasta el día "+moment($("#dateto").val()).format("DD/MM/YYYY")),""==facturacion.Liquidaciones.Model.dateFrom&&""==facturacion.Liquidaciones.Model.dateTo&&$(".periodo-liquidacion").html("No ha seleccionado fechas"),$(".importe-pendiente-liquidacion").html(facturacion.Liquidaciones.Model.totalPendienteLiquidacion),$(".importe-ingresos-cuenta").html(facturacion.Liquidaciones.Model.totalIngresosCuenta),$(".total_taxes_inc").html(facturacion.Facturacion.Controller.Utils.FormatearNumero(facturacion.Liquidaciones.Model.totalTaxesInc)),$(".total_taxes_exc").html(facturacion.Facturacion.Controller.Utils.FormatearNumero(facturacion.Liquidaciones.Model.totalTaxesExc))},RenderTable:{}}},Prefacturacion:{generarInformePrefacturacion:function(){var a=$(".fechaDesde").val(),t=$(".fechaHasta").val(),e=$("#usuarioId option:selected").val(),o=$("#usuarioId option:selected").text();if(""==t||""!=a){var i=Object();i.fechaDesde=a,i.fechaHasta=t,i.nombreAdministrador=o,apiFincatech.post(`facturacion/prefacturacion/${e}`,i).then((a=>{var t=JSON.parse(a);"error"==t.status.response?CoreUI.Modal.Error(t.status.error):window.open(t.data)}))}else CoreUI.Modal.Error("Proporcione la fecha desde para generar el informe")}},Remesa:{Events:function(){$("body").on(core.helper.clickEventType,".btnProcesarRemesaDevolucion",(function(a){apiFincatech.getView("facturacion","modal_devolucion_remesa").then((a=>{CoreUI.Modal.CustomHTML(a,null,(function(){core.Files.init()}))}))})),$("body").on(core.helper.clickEventType,".btnUploadXML",(function(a){facturacion.Remesa.ProcesarDevolucion()}))},ProcesarDevolucion:function(){let a=document.getElementById("ficheroadjuntar");if($(".wrapperMensajeErrorCarga").hide(),0===a.files.length)return $(".wrapperMensajeErrorCarga .mensaje").html("Debe adjuntar el fichero que desea procesar"),void $(".wrapperMensajeErrorCarga").show();let t=a.files[0],e=new FormData;e.append("file",t),new Promise((async(a,t)=>{apiFincatech.post("remesa/devolucion",e).then((t=>{let e=JSON.parse(t);"error"==e.status.response?CoreUI.Modal.Error("Ha ocurrido el siguiente error:<br><br>"+e.status.error):CoreUI.Modal.Success(e.data),a(t)}))})).then((a=>{}))}}};$((()=>{core.model,document.addEventListener("coreInitialized",(function(a){facturacion.Init(),facturacion.Facturacion.Events(),"Prefacturacion"!=core.model&&"emision"!=core.model||CoreUI.Controller.InitializeSelectData()}))}));